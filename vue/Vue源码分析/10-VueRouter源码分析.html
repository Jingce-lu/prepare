<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>VueRouter 源码解析 | Lu notes</title>
    <meta name="description" content=" ">
    <link rel=" " href=" ">
    
    <link rel="preload" href="/prepare/assets/css/0.styles.080a75b5.css" as="style"><link rel="preload" href="/prepare/assets/js/app.26f016bf.js" as="script"><link rel="preload" href="/prepare/assets/js/2.df88221a.js" as="script"><link rel="preload" href="/prepare/assets/js/620.b428f155.js" as="script"><link rel="prefetch" href="/prepare/assets/js/10.21a5dc83.js"><link rel="prefetch" href="/prepare/assets/js/100.14f64daa.js"><link rel="prefetch" href="/prepare/assets/js/101.08c816ba.js"><link rel="prefetch" href="/prepare/assets/js/102.75954b8d.js"><link rel="prefetch" href="/prepare/assets/js/103.f07a1a73.js"><link rel="prefetch" href="/prepare/assets/js/104.38a0a2db.js"><link rel="prefetch" href="/prepare/assets/js/105.1165f8d4.js"><link rel="prefetch" href="/prepare/assets/js/106.bd44a1cb.js"><link rel="prefetch" href="/prepare/assets/js/107.648515e5.js"><link rel="prefetch" href="/prepare/assets/js/108.c89e3d00.js"><link rel="prefetch" href="/prepare/assets/js/109.807ec5a8.js"><link rel="prefetch" href="/prepare/assets/js/11.5006b74c.js"><link rel="prefetch" href="/prepare/assets/js/110.f32f0344.js"><link rel="prefetch" href="/prepare/assets/js/111.cc33770a.js"><link rel="prefetch" href="/prepare/assets/js/112.2c844910.js"><link rel="prefetch" href="/prepare/assets/js/113.aace951e.js"><link rel="prefetch" href="/prepare/assets/js/114.87472f0b.js"><link rel="prefetch" href="/prepare/assets/js/115.ca09de7b.js"><link rel="prefetch" href="/prepare/assets/js/116.04b7cbb7.js"><link rel="prefetch" href="/prepare/assets/js/117.a997b001.js"><link rel="prefetch" href="/prepare/assets/js/118.929eba63.js"><link rel="prefetch" href="/prepare/assets/js/119.678ae8a7.js"><link rel="prefetch" href="/prepare/assets/js/12.b4533720.js"><link rel="prefetch" href="/prepare/assets/js/120.d74c0340.js"><link rel="prefetch" href="/prepare/assets/js/121.681bda87.js"><link rel="prefetch" href="/prepare/assets/js/122.e9c1ac50.js"><link rel="prefetch" href="/prepare/assets/js/123.6b8eced2.js"><link rel="prefetch" href="/prepare/assets/js/124.828a6255.js"><link rel="prefetch" href="/prepare/assets/js/125.9014d997.js"><link rel="prefetch" href="/prepare/assets/js/126.69f28474.js"><link rel="prefetch" href="/prepare/assets/js/127.8b28030f.js"><link rel="prefetch" href="/prepare/assets/js/128.b641adb5.js"><link rel="prefetch" href="/prepare/assets/js/129.ccaed8f4.js"><link rel="prefetch" href="/prepare/assets/js/13.1278de07.js"><link rel="prefetch" href="/prepare/assets/js/130.bd8064e4.js"><link rel="prefetch" href="/prepare/assets/js/131.d50daaf0.js"><link rel="prefetch" href="/prepare/assets/js/132.563c3581.js"><link rel="prefetch" href="/prepare/assets/js/133.71e89464.js"><link rel="prefetch" href="/prepare/assets/js/134.41086874.js"><link rel="prefetch" href="/prepare/assets/js/135.46dc8866.js"><link rel="prefetch" href="/prepare/assets/js/136.d3d5d8a3.js"><link rel="prefetch" href="/prepare/assets/js/137.0fdfd912.js"><link rel="prefetch" href="/prepare/assets/js/138.bf658009.js"><link rel="prefetch" href="/prepare/assets/js/139.cc6ec2ba.js"><link rel="prefetch" href="/prepare/assets/js/14.7a37b244.js"><link rel="prefetch" href="/prepare/assets/js/140.8c5472ed.js"><link rel="prefetch" href="/prepare/assets/js/141.c56c6f8b.js"><link rel="prefetch" href="/prepare/assets/js/142.ecaec7e8.js"><link rel="prefetch" href="/prepare/assets/js/143.60383cd7.js"><link rel="prefetch" href="/prepare/assets/js/144.8fe78fad.js"><link rel="prefetch" href="/prepare/assets/js/145.95fbff34.js"><link rel="prefetch" href="/prepare/assets/js/146.89a9f5f4.js"><link rel="prefetch" href="/prepare/assets/js/147.8eed692b.js"><link rel="prefetch" href="/prepare/assets/js/148.30ec0b02.js"><link rel="prefetch" href="/prepare/assets/js/149.1c016ae1.js"><link rel="prefetch" href="/prepare/assets/js/15.cac92205.js"><link rel="prefetch" href="/prepare/assets/js/150.d984e236.js"><link rel="prefetch" href="/prepare/assets/js/151.02f8a81b.js"><link rel="prefetch" href="/prepare/assets/js/152.324a81b8.js"><link rel="prefetch" href="/prepare/assets/js/153.ce198e3d.js"><link rel="prefetch" href="/prepare/assets/js/154.77b911cc.js"><link rel="prefetch" href="/prepare/assets/js/155.298715e7.js"><link rel="prefetch" href="/prepare/assets/js/156.e4686166.js"><link rel="prefetch" href="/prepare/assets/js/157.4181d3b5.js"><link rel="prefetch" href="/prepare/assets/js/158.db2f8c04.js"><link rel="prefetch" href="/prepare/assets/js/159.14255a33.js"><link rel="prefetch" href="/prepare/assets/js/16.41172132.js"><link rel="prefetch" href="/prepare/assets/js/160.65d8926d.js"><link rel="prefetch" href="/prepare/assets/js/161.b2223e92.js"><link rel="prefetch" href="/prepare/assets/js/162.b1ff5f45.js"><link rel="prefetch" href="/prepare/assets/js/163.5dba0ea0.js"><link rel="prefetch" href="/prepare/assets/js/164.e096cb52.js"><link rel="prefetch" href="/prepare/assets/js/165.7cd8f1ba.js"><link rel="prefetch" href="/prepare/assets/js/166.d877586c.js"><link rel="prefetch" href="/prepare/assets/js/167.d28450cb.js"><link rel="prefetch" href="/prepare/assets/js/168.eb091bc1.js"><link rel="prefetch" href="/prepare/assets/js/169.a26dd498.js"><link rel="prefetch" href="/prepare/assets/js/17.c5c7986d.js"><link rel="prefetch" href="/prepare/assets/js/170.c9c9b064.js"><link rel="prefetch" href="/prepare/assets/js/171.fd192fbf.js"><link rel="prefetch" href="/prepare/assets/js/172.f727ac0a.js"><link rel="prefetch" href="/prepare/assets/js/173.f599b562.js"><link rel="prefetch" href="/prepare/assets/js/174.ccb97937.js"><link rel="prefetch" href="/prepare/assets/js/175.f9f562ae.js"><link rel="prefetch" href="/prepare/assets/js/176.5972bcd9.js"><link rel="prefetch" href="/prepare/assets/js/177.8e748403.js"><link rel="prefetch" href="/prepare/assets/js/178.a2b1a493.js"><link rel="prefetch" href="/prepare/assets/js/179.0cc507d4.js"><link rel="prefetch" href="/prepare/assets/js/18.f1e9f997.js"><link rel="prefetch" href="/prepare/assets/js/180.a350adc5.js"><link rel="prefetch" href="/prepare/assets/js/181.cfe7eeb5.js"><link rel="prefetch" href="/prepare/assets/js/182.6fe8ae66.js"><link rel="prefetch" href="/prepare/assets/js/183.4180a2f0.js"><link rel="prefetch" href="/prepare/assets/js/184.ee6512ea.js"><link rel="prefetch" href="/prepare/assets/js/185.fd01e8f7.js"><link rel="prefetch" href="/prepare/assets/js/186.6dc776c2.js"><link rel="prefetch" href="/prepare/assets/js/187.9d60c24e.js"><link rel="prefetch" href="/prepare/assets/js/188.8b920010.js"><link rel="prefetch" href="/prepare/assets/js/189.4e560170.js"><link rel="prefetch" href="/prepare/assets/js/19.5fad194b.js"><link rel="prefetch" href="/prepare/assets/js/190.9c3e60b9.js"><link rel="prefetch" href="/prepare/assets/js/191.10274678.js"><link rel="prefetch" href="/prepare/assets/js/192.5de74ee3.js"><link rel="prefetch" href="/prepare/assets/js/193.226b812f.js"><link rel="prefetch" href="/prepare/assets/js/194.a77541bf.js"><link rel="prefetch" href="/prepare/assets/js/195.a75c0cd4.js"><link rel="prefetch" href="/prepare/assets/js/196.71a8595a.js"><link rel="prefetch" href="/prepare/assets/js/197.0c378137.js"><link rel="prefetch" href="/prepare/assets/js/198.8dba78ce.js"><link rel="prefetch" href="/prepare/assets/js/199.d1841f0e.js"><link rel="prefetch" href="/prepare/assets/js/20.b634e488.js"><link rel="prefetch" href="/prepare/assets/js/200.690b96e6.js"><link rel="prefetch" href="/prepare/assets/js/201.6c855fe9.js"><link rel="prefetch" href="/prepare/assets/js/202.3fada634.js"><link rel="prefetch" href="/prepare/assets/js/203.49bdb170.js"><link rel="prefetch" href="/prepare/assets/js/204.361bf43b.js"><link rel="prefetch" href="/prepare/assets/js/205.92420110.js"><link rel="prefetch" href="/prepare/assets/js/206.59392858.js"><link rel="prefetch" href="/prepare/assets/js/207.935304e5.js"><link rel="prefetch" href="/prepare/assets/js/208.7b71d0e9.js"><link rel="prefetch" href="/prepare/assets/js/209.35b8cd75.js"><link rel="prefetch" href="/prepare/assets/js/21.f064f2c6.js"><link rel="prefetch" href="/prepare/assets/js/210.dc5da418.js"><link rel="prefetch" href="/prepare/assets/js/211.63a8984b.js"><link rel="prefetch" href="/prepare/assets/js/212.c0974cda.js"><link rel="prefetch" href="/prepare/assets/js/213.71110262.js"><link rel="prefetch" href="/prepare/assets/js/214.ee1ba10b.js"><link rel="prefetch" href="/prepare/assets/js/215.b462c901.js"><link rel="prefetch" href="/prepare/assets/js/216.6de2e00c.js"><link rel="prefetch" href="/prepare/assets/js/217.54e3c060.js"><link rel="prefetch" href="/prepare/assets/js/218.8ed01541.js"><link rel="prefetch" href="/prepare/assets/js/219.476a8b7c.js"><link rel="prefetch" href="/prepare/assets/js/22.c9fbe411.js"><link rel="prefetch" href="/prepare/assets/js/220.ec8134f7.js"><link rel="prefetch" href="/prepare/assets/js/221.e4d54890.js"><link rel="prefetch" href="/prepare/assets/js/222.8b8f93c7.js"><link rel="prefetch" href="/prepare/assets/js/223.38e33e5b.js"><link rel="prefetch" href="/prepare/assets/js/224.585b953a.js"><link rel="prefetch" href="/prepare/assets/js/225.026800ba.js"><link rel="prefetch" href="/prepare/assets/js/226.a5ddb79b.js"><link rel="prefetch" href="/prepare/assets/js/227.c72b63e6.js"><link rel="prefetch" href="/prepare/assets/js/228.3a93a1ed.js"><link rel="prefetch" href="/prepare/assets/js/229.943af962.js"><link rel="prefetch" href="/prepare/assets/js/23.76d84253.js"><link rel="prefetch" href="/prepare/assets/js/230.f61dd6bc.js"><link rel="prefetch" href="/prepare/assets/js/231.0de03505.js"><link rel="prefetch" href="/prepare/assets/js/232.87d71704.js"><link rel="prefetch" href="/prepare/assets/js/233.c9691bf5.js"><link rel="prefetch" href="/prepare/assets/js/234.5d996585.js"><link rel="prefetch" href="/prepare/assets/js/235.ea3d0b62.js"><link rel="prefetch" href="/prepare/assets/js/236.32eb5c1d.js"><link rel="prefetch" href="/prepare/assets/js/237.11b7085e.js"><link rel="prefetch" href="/prepare/assets/js/238.83ed958e.js"><link rel="prefetch" href="/prepare/assets/js/239.8d5988c0.js"><link rel="prefetch" href="/prepare/assets/js/24.91073e02.js"><link rel="prefetch" href="/prepare/assets/js/240.700c92d8.js"><link rel="prefetch" href="/prepare/assets/js/241.90738883.js"><link rel="prefetch" href="/prepare/assets/js/242.4ac1e980.js"><link rel="prefetch" href="/prepare/assets/js/243.a3121715.js"><link rel="prefetch" href="/prepare/assets/js/244.f7508c6a.js"><link rel="prefetch" href="/prepare/assets/js/245.95ef5b9b.js"><link rel="prefetch" href="/prepare/assets/js/246.66505b01.js"><link rel="prefetch" href="/prepare/assets/js/247.1a36d6e0.js"><link rel="prefetch" href="/prepare/assets/js/248.427c0ab3.js"><link rel="prefetch" href="/prepare/assets/js/249.41058be8.js"><link rel="prefetch" href="/prepare/assets/js/25.64f6c154.js"><link rel="prefetch" href="/prepare/assets/js/250.cc434537.js"><link rel="prefetch" href="/prepare/assets/js/251.5e453f2d.js"><link rel="prefetch" href="/prepare/assets/js/252.8f3433a5.js"><link rel="prefetch" href="/prepare/assets/js/253.af526b01.js"><link rel="prefetch" href="/prepare/assets/js/254.3c0cb7a9.js"><link rel="prefetch" href="/prepare/assets/js/255.bb68323e.js"><link rel="prefetch" href="/prepare/assets/js/256.1629d9b7.js"><link rel="prefetch" href="/prepare/assets/js/257.07a37597.js"><link rel="prefetch" href="/prepare/assets/js/258.3c9df90b.js"><link rel="prefetch" href="/prepare/assets/js/259.8cd177e5.js"><link rel="prefetch" href="/prepare/assets/js/26.8cedf695.js"><link rel="prefetch" href="/prepare/assets/js/260.bc66782f.js"><link rel="prefetch" href="/prepare/assets/js/261.93869f43.js"><link rel="prefetch" href="/prepare/assets/js/262.f077a3c1.js"><link rel="prefetch" href="/prepare/assets/js/263.ac0575cd.js"><link rel="prefetch" href="/prepare/assets/js/264.502301c7.js"><link rel="prefetch" href="/prepare/assets/js/265.9316658c.js"><link rel="prefetch" href="/prepare/assets/js/266.dbf17672.js"><link rel="prefetch" href="/prepare/assets/js/267.48d714e3.js"><link rel="prefetch" href="/prepare/assets/js/268.33fe74d4.js"><link rel="prefetch" href="/prepare/assets/js/269.399546cb.js"><link rel="prefetch" href="/prepare/assets/js/27.35031a05.js"><link rel="prefetch" href="/prepare/assets/js/270.3bc7d27f.js"><link rel="prefetch" href="/prepare/assets/js/271.359b1aae.js"><link rel="prefetch" href="/prepare/assets/js/272.ce0d3979.js"><link rel="prefetch" href="/prepare/assets/js/273.9b4eb2b0.js"><link rel="prefetch" href="/prepare/assets/js/274.6b8d7eb1.js"><link rel="prefetch" href="/prepare/assets/js/275.14bfd5ad.js"><link rel="prefetch" href="/prepare/assets/js/276.c4485ad4.js"><link rel="prefetch" href="/prepare/assets/js/277.4f0d1940.js"><link rel="prefetch" href="/prepare/assets/js/278.a91cbbd4.js"><link rel="prefetch" href="/prepare/assets/js/279.e1b51fad.js"><link rel="prefetch" href="/prepare/assets/js/28.a4d31af6.js"><link rel="prefetch" href="/prepare/assets/js/280.c8f08ab8.js"><link rel="prefetch" href="/prepare/assets/js/281.f21c89f5.js"><link rel="prefetch" href="/prepare/assets/js/282.929f1f4d.js"><link rel="prefetch" href="/prepare/assets/js/283.b0eb84b0.js"><link rel="prefetch" href="/prepare/assets/js/284.9e04d0e7.js"><link rel="prefetch" href="/prepare/assets/js/285.69b15966.js"><link rel="prefetch" href="/prepare/assets/js/286.603d0267.js"><link rel="prefetch" href="/prepare/assets/js/287.addadd18.js"><link rel="prefetch" href="/prepare/assets/js/288.986bab77.js"><link rel="prefetch" href="/prepare/assets/js/289.776aae55.js"><link rel="prefetch" href="/prepare/assets/js/29.4af0c594.js"><link rel="prefetch" href="/prepare/assets/js/290.c0ddf840.js"><link rel="prefetch" href="/prepare/assets/js/291.b1859fc6.js"><link rel="prefetch" href="/prepare/assets/js/292.23ff023a.js"><link rel="prefetch" href="/prepare/assets/js/293.9cb5fbd1.js"><link rel="prefetch" href="/prepare/assets/js/294.bf3849b5.js"><link rel="prefetch" href="/prepare/assets/js/295.c43afdca.js"><link rel="prefetch" href="/prepare/assets/js/296.3aecc8d3.js"><link rel="prefetch" href="/prepare/assets/js/297.36e3ad53.js"><link rel="prefetch" href="/prepare/assets/js/298.d461f3a4.js"><link rel="prefetch" href="/prepare/assets/js/299.f0e4451a.js"><link rel="prefetch" href="/prepare/assets/js/3.08575337.js"><link rel="prefetch" href="/prepare/assets/js/30.24fdd7ed.js"><link rel="prefetch" href="/prepare/assets/js/300.e5bdac87.js"><link rel="prefetch" href="/prepare/assets/js/301.d473ba77.js"><link rel="prefetch" href="/prepare/assets/js/302.4104d73c.js"><link rel="prefetch" href="/prepare/assets/js/303.fce6eb00.js"><link rel="prefetch" href="/prepare/assets/js/304.9da21191.js"><link rel="prefetch" href="/prepare/assets/js/305.914a352e.js"><link rel="prefetch" href="/prepare/assets/js/306.76fa1e97.js"><link rel="prefetch" href="/prepare/assets/js/307.17643748.js"><link rel="prefetch" href="/prepare/assets/js/308.0ecfa788.js"><link rel="prefetch" href="/prepare/assets/js/309.a15b3f86.js"><link rel="prefetch" href="/prepare/assets/js/31.134e90e4.js"><link rel="prefetch" href="/prepare/assets/js/310.4d5d17fd.js"><link rel="prefetch" href="/prepare/assets/js/311.a58884d8.js"><link rel="prefetch" href="/prepare/assets/js/312.a52307d6.js"><link rel="prefetch" href="/prepare/assets/js/313.653cd055.js"><link rel="prefetch" href="/prepare/assets/js/314.058b508e.js"><link rel="prefetch" href="/prepare/assets/js/315.e9b7aab8.js"><link rel="prefetch" href="/prepare/assets/js/316.50c71c59.js"><link rel="prefetch" href="/prepare/assets/js/317.19abcc7c.js"><link rel="prefetch" href="/prepare/assets/js/318.f990c725.js"><link rel="prefetch" href="/prepare/assets/js/319.7717e90e.js"><link rel="prefetch" href="/prepare/assets/js/32.e9a6b791.js"><link rel="prefetch" href="/prepare/assets/js/320.03c13da8.js"><link rel="prefetch" href="/prepare/assets/js/321.9bd9af8e.js"><link rel="prefetch" href="/prepare/assets/js/322.acc4f9e7.js"><link rel="prefetch" href="/prepare/assets/js/323.df8278ee.js"><link rel="prefetch" href="/prepare/assets/js/324.0a21cecc.js"><link rel="prefetch" href="/prepare/assets/js/325.ae2ddbbb.js"><link rel="prefetch" href="/prepare/assets/js/326.fcab49af.js"><link rel="prefetch" href="/prepare/assets/js/327.9543df61.js"><link rel="prefetch" href="/prepare/assets/js/328.7fd3aa5e.js"><link rel="prefetch" href="/prepare/assets/js/329.9aac076a.js"><link rel="prefetch" href="/prepare/assets/js/33.8b822516.js"><link rel="prefetch" href="/prepare/assets/js/330.4b405ac1.js"><link rel="prefetch" href="/prepare/assets/js/331.5724f9a5.js"><link rel="prefetch" href="/prepare/assets/js/332.cf01c6fc.js"><link rel="prefetch" href="/prepare/assets/js/333.75804713.js"><link rel="prefetch" href="/prepare/assets/js/334.09491cd9.js"><link rel="prefetch" href="/prepare/assets/js/335.2ad0b1e4.js"><link rel="prefetch" href="/prepare/assets/js/336.d230da96.js"><link rel="prefetch" href="/prepare/assets/js/337.a225a7b6.js"><link rel="prefetch" href="/prepare/assets/js/338.ed7b966e.js"><link rel="prefetch" href="/prepare/assets/js/339.095b9ea9.js"><link rel="prefetch" href="/prepare/assets/js/34.3c0efde9.js"><link rel="prefetch" href="/prepare/assets/js/340.a3fd6f25.js"><link rel="prefetch" href="/prepare/assets/js/341.6097be8c.js"><link rel="prefetch" href="/prepare/assets/js/342.f14c0419.js"><link rel="prefetch" href="/prepare/assets/js/343.a697d1a5.js"><link rel="prefetch" href="/prepare/assets/js/344.53936bd4.js"><link rel="prefetch" href="/prepare/assets/js/345.af6c3675.js"><link rel="prefetch" href="/prepare/assets/js/346.aad8d457.js"><link rel="prefetch" href="/prepare/assets/js/347.c7ae98e9.js"><link rel="prefetch" href="/prepare/assets/js/348.103bdfd6.js"><link rel="prefetch" href="/prepare/assets/js/349.1c9eb07c.js"><link rel="prefetch" href="/prepare/assets/js/35.3f918e70.js"><link rel="prefetch" href="/prepare/assets/js/350.8192ea8d.js"><link rel="prefetch" href="/prepare/assets/js/351.d7809c21.js"><link rel="prefetch" href="/prepare/assets/js/352.783c766d.js"><link rel="prefetch" href="/prepare/assets/js/353.51f2c117.js"><link rel="prefetch" href="/prepare/assets/js/354.a07c6f37.js"><link rel="prefetch" href="/prepare/assets/js/355.b4d95902.js"><link rel="prefetch" href="/prepare/assets/js/356.c1f13cb6.js"><link rel="prefetch" href="/prepare/assets/js/357.d555e80c.js"><link rel="prefetch" href="/prepare/assets/js/358.3910a3f5.js"><link rel="prefetch" href="/prepare/assets/js/359.d1d53bfa.js"><link rel="prefetch" href="/prepare/assets/js/36.7b540d91.js"><link rel="prefetch" href="/prepare/assets/js/360.f73f99d7.js"><link rel="prefetch" href="/prepare/assets/js/361.addcad4b.js"><link rel="prefetch" href="/prepare/assets/js/362.ae274243.js"><link rel="prefetch" href="/prepare/assets/js/363.0ada15ad.js"><link rel="prefetch" href="/prepare/assets/js/364.0b75155e.js"><link rel="prefetch" href="/prepare/assets/js/365.dcb2d3c2.js"><link rel="prefetch" href="/prepare/assets/js/366.18804e35.js"><link rel="prefetch" href="/prepare/assets/js/367.819d067b.js"><link rel="prefetch" href="/prepare/assets/js/368.66fb0d32.js"><link rel="prefetch" href="/prepare/assets/js/369.9fd5b3e2.js"><link rel="prefetch" href="/prepare/assets/js/37.1a7e194a.js"><link rel="prefetch" href="/prepare/assets/js/370.bce22552.js"><link rel="prefetch" href="/prepare/assets/js/371.9696c247.js"><link rel="prefetch" href="/prepare/assets/js/372.c5b7a178.js"><link rel="prefetch" href="/prepare/assets/js/373.c08a99b4.js"><link rel="prefetch" href="/prepare/assets/js/374.823b38eb.js"><link rel="prefetch" href="/prepare/assets/js/375.df6a6ae4.js"><link rel="prefetch" href="/prepare/assets/js/376.cd5a476c.js"><link rel="prefetch" href="/prepare/assets/js/377.7de7b0df.js"><link rel="prefetch" href="/prepare/assets/js/378.fa3e9cbb.js"><link rel="prefetch" href="/prepare/assets/js/379.8cfe1909.js"><link rel="prefetch" href="/prepare/assets/js/38.0549b1ce.js"><link rel="prefetch" href="/prepare/assets/js/380.eccbb7bd.js"><link rel="prefetch" href="/prepare/assets/js/381.30d3a8c1.js"><link rel="prefetch" href="/prepare/assets/js/382.5b52f239.js"><link rel="prefetch" href="/prepare/assets/js/383.d3d447e8.js"><link rel="prefetch" href="/prepare/assets/js/384.5e617aa3.js"><link rel="prefetch" href="/prepare/assets/js/385.c5fcfd1b.js"><link rel="prefetch" href="/prepare/assets/js/386.4063e5ed.js"><link rel="prefetch" href="/prepare/assets/js/387.27b4e954.js"><link rel="prefetch" href="/prepare/assets/js/388.b463edb4.js"><link rel="prefetch" href="/prepare/assets/js/389.67f0ec2f.js"><link rel="prefetch" href="/prepare/assets/js/39.75f92fc1.js"><link rel="prefetch" href="/prepare/assets/js/390.1452ef20.js"><link rel="prefetch" href="/prepare/assets/js/391.04051a47.js"><link rel="prefetch" href="/prepare/assets/js/392.b6375126.js"><link rel="prefetch" href="/prepare/assets/js/393.39610a69.js"><link rel="prefetch" href="/prepare/assets/js/394.421580e5.js"><link rel="prefetch" href="/prepare/assets/js/395.27acf5e2.js"><link rel="prefetch" href="/prepare/assets/js/396.4becd0a6.js"><link rel="prefetch" href="/prepare/assets/js/397.4ad00d4f.js"><link rel="prefetch" href="/prepare/assets/js/398.1d74f179.js"><link rel="prefetch" href="/prepare/assets/js/399.dffdc686.js"><link rel="prefetch" href="/prepare/assets/js/4.03399f42.js"><link rel="prefetch" href="/prepare/assets/js/40.80d1fff7.js"><link rel="prefetch" href="/prepare/assets/js/400.3196869a.js"><link rel="prefetch" href="/prepare/assets/js/401.25f071c2.js"><link rel="prefetch" href="/prepare/assets/js/402.75b7c862.js"><link rel="prefetch" href="/prepare/assets/js/403.c51c66ca.js"><link rel="prefetch" href="/prepare/assets/js/404.c92918a1.js"><link rel="prefetch" href="/prepare/assets/js/405.0015a170.js"><link rel="prefetch" href="/prepare/assets/js/406.2eb2a9d7.js"><link rel="prefetch" href="/prepare/assets/js/407.282b90ed.js"><link rel="prefetch" href="/prepare/assets/js/408.67af5e24.js"><link rel="prefetch" href="/prepare/assets/js/409.a8c06c55.js"><link rel="prefetch" href="/prepare/assets/js/41.b41373df.js"><link rel="prefetch" href="/prepare/assets/js/410.63851fa1.js"><link rel="prefetch" href="/prepare/assets/js/411.de97b1a9.js"><link rel="prefetch" href="/prepare/assets/js/412.4095c618.js"><link rel="prefetch" href="/prepare/assets/js/413.74d96333.js"><link rel="prefetch" href="/prepare/assets/js/414.00c2a736.js"><link rel="prefetch" href="/prepare/assets/js/415.f66f4e90.js"><link rel="prefetch" href="/prepare/assets/js/416.7f264478.js"><link rel="prefetch" href="/prepare/assets/js/417.fa06f1cd.js"><link rel="prefetch" href="/prepare/assets/js/418.76f47501.js"><link rel="prefetch" href="/prepare/assets/js/419.7384c3a4.js"><link rel="prefetch" href="/prepare/assets/js/42.d7536485.js"><link rel="prefetch" href="/prepare/assets/js/420.832cb989.js"><link rel="prefetch" href="/prepare/assets/js/421.9d8973b7.js"><link rel="prefetch" href="/prepare/assets/js/422.1ec02764.js"><link rel="prefetch" href="/prepare/assets/js/423.c979e03e.js"><link rel="prefetch" href="/prepare/assets/js/424.22de4fa2.js"><link rel="prefetch" href="/prepare/assets/js/425.0bf31da5.js"><link rel="prefetch" href="/prepare/assets/js/426.4c7e2d40.js"><link rel="prefetch" href="/prepare/assets/js/427.96635e88.js"><link rel="prefetch" href="/prepare/assets/js/428.2c79f175.js"><link rel="prefetch" href="/prepare/assets/js/429.56a8a120.js"><link rel="prefetch" href="/prepare/assets/js/43.a0078c9c.js"><link rel="prefetch" href="/prepare/assets/js/430.f16a77f1.js"><link rel="prefetch" href="/prepare/assets/js/431.01ef59e2.js"><link rel="prefetch" href="/prepare/assets/js/432.796a0024.js"><link rel="prefetch" href="/prepare/assets/js/433.fce2beed.js"><link rel="prefetch" href="/prepare/assets/js/434.6c1f53e9.js"><link rel="prefetch" href="/prepare/assets/js/435.b87d2573.js"><link rel="prefetch" href="/prepare/assets/js/436.b30cb85a.js"><link rel="prefetch" href="/prepare/assets/js/437.64864627.js"><link rel="prefetch" href="/prepare/assets/js/438.f3ca7326.js"><link rel="prefetch" href="/prepare/assets/js/439.e4d5f452.js"><link rel="prefetch" href="/prepare/assets/js/44.919848cd.js"><link rel="prefetch" href="/prepare/assets/js/440.c85f9536.js"><link rel="prefetch" href="/prepare/assets/js/441.062bc977.js"><link rel="prefetch" href="/prepare/assets/js/442.4089b867.js"><link rel="prefetch" href="/prepare/assets/js/443.93b53dfa.js"><link rel="prefetch" href="/prepare/assets/js/444.9923aa31.js"><link rel="prefetch" href="/prepare/assets/js/445.abcfc306.js"><link rel="prefetch" href="/prepare/assets/js/446.58fede2b.js"><link rel="prefetch" href="/prepare/assets/js/447.610f436c.js"><link rel="prefetch" href="/prepare/assets/js/448.ae9421bd.js"><link rel="prefetch" href="/prepare/assets/js/449.23851307.js"><link rel="prefetch" href="/prepare/assets/js/45.91af9a0b.js"><link rel="prefetch" href="/prepare/assets/js/450.d6c7dc76.js"><link rel="prefetch" href="/prepare/assets/js/451.03fd9e51.js"><link rel="prefetch" href="/prepare/assets/js/452.6fd1be16.js"><link rel="prefetch" href="/prepare/assets/js/453.92af4181.js"><link rel="prefetch" href="/prepare/assets/js/454.c62bf2bd.js"><link rel="prefetch" href="/prepare/assets/js/455.aa2654d2.js"><link rel="prefetch" href="/prepare/assets/js/456.618fe865.js"><link rel="prefetch" href="/prepare/assets/js/457.4041675d.js"><link rel="prefetch" href="/prepare/assets/js/458.93782ebf.js"><link rel="prefetch" href="/prepare/assets/js/459.bf647460.js"><link rel="prefetch" href="/prepare/assets/js/46.9aa9eb2f.js"><link rel="prefetch" href="/prepare/assets/js/460.69d5d701.js"><link rel="prefetch" href="/prepare/assets/js/461.a63ccc25.js"><link rel="prefetch" href="/prepare/assets/js/462.e96b27dc.js"><link rel="prefetch" href="/prepare/assets/js/463.261ec7a8.js"><link rel="prefetch" href="/prepare/assets/js/464.829a3664.js"><link rel="prefetch" href="/prepare/assets/js/465.8791e09d.js"><link rel="prefetch" href="/prepare/assets/js/466.cd9c13fd.js"><link rel="prefetch" href="/prepare/assets/js/467.a2b79dcb.js"><link rel="prefetch" href="/prepare/assets/js/468.10d31ad4.js"><link rel="prefetch" href="/prepare/assets/js/469.63e24f18.js"><link rel="prefetch" href="/prepare/assets/js/47.874b43a7.js"><link rel="prefetch" href="/prepare/assets/js/470.deb3581e.js"><link rel="prefetch" href="/prepare/assets/js/471.4936f0a5.js"><link rel="prefetch" href="/prepare/assets/js/472.467db050.js"><link rel="prefetch" href="/prepare/assets/js/473.76cf0c51.js"><link rel="prefetch" href="/prepare/assets/js/474.580dc3e1.js"><link rel="prefetch" href="/prepare/assets/js/475.d0108802.js"><link rel="prefetch" href="/prepare/assets/js/476.302b2cf7.js"><link rel="prefetch" href="/prepare/assets/js/477.bd3e15e9.js"><link rel="prefetch" href="/prepare/assets/js/478.6e17580a.js"><link rel="prefetch" href="/prepare/assets/js/479.b86231aa.js"><link rel="prefetch" href="/prepare/assets/js/48.c3cf1ae6.js"><link rel="prefetch" href="/prepare/assets/js/480.9d3c146c.js"><link rel="prefetch" href="/prepare/assets/js/481.7f97a174.js"><link rel="prefetch" href="/prepare/assets/js/482.3d18cacb.js"><link rel="prefetch" href="/prepare/assets/js/483.f01ac50d.js"><link rel="prefetch" href="/prepare/assets/js/484.812c80a4.js"><link rel="prefetch" href="/prepare/assets/js/485.afc68631.js"><link rel="prefetch" href="/prepare/assets/js/486.60b594ea.js"><link rel="prefetch" href="/prepare/assets/js/487.aa26c270.js"><link rel="prefetch" href="/prepare/assets/js/488.c0f2f73b.js"><link rel="prefetch" href="/prepare/assets/js/489.3469aea2.js"><link rel="prefetch" href="/prepare/assets/js/49.65f6c32c.js"><link rel="prefetch" href="/prepare/assets/js/490.7a06452e.js"><link rel="prefetch" href="/prepare/assets/js/491.821ebbee.js"><link rel="prefetch" href="/prepare/assets/js/492.9239db05.js"><link rel="prefetch" href="/prepare/assets/js/493.442e8b75.js"><link rel="prefetch" href="/prepare/assets/js/494.2fe4756d.js"><link rel="prefetch" href="/prepare/assets/js/495.7a75655b.js"><link rel="prefetch" href="/prepare/assets/js/496.ae74c93c.js"><link rel="prefetch" href="/prepare/assets/js/497.608c9cd5.js"><link rel="prefetch" href="/prepare/assets/js/498.d4df63f8.js"><link rel="prefetch" href="/prepare/assets/js/499.8ccb5476.js"><link rel="prefetch" href="/prepare/assets/js/5.1b19945b.js"><link rel="prefetch" href="/prepare/assets/js/50.329f5842.js"><link rel="prefetch" href="/prepare/assets/js/500.09125832.js"><link rel="prefetch" href="/prepare/assets/js/501.6211aaaf.js"><link rel="prefetch" href="/prepare/assets/js/502.829d1790.js"><link rel="prefetch" href="/prepare/assets/js/503.c85c18f5.js"><link rel="prefetch" href="/prepare/assets/js/504.07e8c4c6.js"><link rel="prefetch" href="/prepare/assets/js/505.13eedcb9.js"><link rel="prefetch" href="/prepare/assets/js/506.3ee56e9d.js"><link rel="prefetch" href="/prepare/assets/js/507.e05e2779.js"><link rel="prefetch" href="/prepare/assets/js/508.fa69cfca.js"><link rel="prefetch" href="/prepare/assets/js/509.f9f0ded1.js"><link rel="prefetch" href="/prepare/assets/js/51.62cfb61d.js"><link rel="prefetch" href="/prepare/assets/js/510.bfb2d4be.js"><link rel="prefetch" href="/prepare/assets/js/511.2aec4062.js"><link rel="prefetch" href="/prepare/assets/js/512.0c151119.js"><link rel="prefetch" href="/prepare/assets/js/513.c718db9a.js"><link rel="prefetch" href="/prepare/assets/js/514.d2483464.js"><link rel="prefetch" href="/prepare/assets/js/515.050713b7.js"><link rel="prefetch" href="/prepare/assets/js/516.62e9b110.js"><link rel="prefetch" href="/prepare/assets/js/517.b59903b9.js"><link rel="prefetch" href="/prepare/assets/js/518.955dc73b.js"><link rel="prefetch" href="/prepare/assets/js/519.cf381fff.js"><link rel="prefetch" href="/prepare/assets/js/52.aaadca0f.js"><link rel="prefetch" href="/prepare/assets/js/520.a0a8ac6a.js"><link rel="prefetch" href="/prepare/assets/js/521.bfe69814.js"><link rel="prefetch" href="/prepare/assets/js/522.56e7d8fe.js"><link rel="prefetch" href="/prepare/assets/js/523.f328a0c4.js"><link rel="prefetch" href="/prepare/assets/js/524.f8a0b80a.js"><link rel="prefetch" href="/prepare/assets/js/525.3fb16904.js"><link rel="prefetch" href="/prepare/assets/js/526.4755d1c8.js"><link rel="prefetch" href="/prepare/assets/js/527.da67cb17.js"><link rel="prefetch" href="/prepare/assets/js/528.275caabc.js"><link rel="prefetch" href="/prepare/assets/js/529.7a864b1e.js"><link rel="prefetch" href="/prepare/assets/js/53.4181bd00.js"><link rel="prefetch" href="/prepare/assets/js/530.dab8339c.js"><link rel="prefetch" href="/prepare/assets/js/531.42d5778a.js"><link rel="prefetch" href="/prepare/assets/js/532.45a3709c.js"><link rel="prefetch" href="/prepare/assets/js/533.ef6ef6c6.js"><link rel="prefetch" href="/prepare/assets/js/534.6d4b083d.js"><link rel="prefetch" href="/prepare/assets/js/535.42281fce.js"><link rel="prefetch" href="/prepare/assets/js/536.e4342436.js"><link rel="prefetch" href="/prepare/assets/js/537.01529b88.js"><link rel="prefetch" href="/prepare/assets/js/538.ad29ed75.js"><link rel="prefetch" href="/prepare/assets/js/539.d62db569.js"><link rel="prefetch" href="/prepare/assets/js/54.12a486a6.js"><link rel="prefetch" href="/prepare/assets/js/540.5ae88e43.js"><link rel="prefetch" href="/prepare/assets/js/541.7419c9aa.js"><link rel="prefetch" href="/prepare/assets/js/542.c02e9050.js"><link rel="prefetch" href="/prepare/assets/js/543.674db80a.js"><link rel="prefetch" href="/prepare/assets/js/544.77798d2b.js"><link rel="prefetch" href="/prepare/assets/js/545.7070db51.js"><link rel="prefetch" href="/prepare/assets/js/546.ca34a57e.js"><link rel="prefetch" href="/prepare/assets/js/547.91d8b073.js"><link rel="prefetch" href="/prepare/assets/js/548.da13521c.js"><link rel="prefetch" href="/prepare/assets/js/549.e5e521e0.js"><link rel="prefetch" href="/prepare/assets/js/55.dcad84ea.js"><link rel="prefetch" href="/prepare/assets/js/550.8977f4fa.js"><link rel="prefetch" href="/prepare/assets/js/551.e3aeb9cd.js"><link rel="prefetch" href="/prepare/assets/js/552.a3ce76ac.js"><link rel="prefetch" href="/prepare/assets/js/553.912f1252.js"><link rel="prefetch" href="/prepare/assets/js/554.f44f0865.js"><link rel="prefetch" href="/prepare/assets/js/555.8af3dffd.js"><link rel="prefetch" href="/prepare/assets/js/556.45d41a6e.js"><link rel="prefetch" href="/prepare/assets/js/557.8755c018.js"><link rel="prefetch" href="/prepare/assets/js/558.ff140e45.js"><link rel="prefetch" href="/prepare/assets/js/559.12e409d8.js"><link rel="prefetch" href="/prepare/assets/js/56.db169fed.js"><link rel="prefetch" href="/prepare/assets/js/560.3286f965.js"><link rel="prefetch" href="/prepare/assets/js/561.922b6733.js"><link rel="prefetch" href="/prepare/assets/js/562.f1d7f86a.js"><link rel="prefetch" href="/prepare/assets/js/563.43778584.js"><link rel="prefetch" href="/prepare/assets/js/564.b488c2f7.js"><link rel="prefetch" href="/prepare/assets/js/565.6cae052e.js"><link rel="prefetch" href="/prepare/assets/js/566.ffbff2ec.js"><link rel="prefetch" href="/prepare/assets/js/567.40bd054d.js"><link rel="prefetch" href="/prepare/assets/js/568.19c5b53d.js"><link rel="prefetch" href="/prepare/assets/js/569.981259a9.js"><link rel="prefetch" href="/prepare/assets/js/57.22e07713.js"><link rel="prefetch" href="/prepare/assets/js/570.9b75a4cd.js"><link rel="prefetch" href="/prepare/assets/js/571.22822226.js"><link rel="prefetch" href="/prepare/assets/js/572.09d1afe9.js"><link rel="prefetch" href="/prepare/assets/js/573.8e5d8f98.js"><link rel="prefetch" href="/prepare/assets/js/574.88edd795.js"><link rel="prefetch" href="/prepare/assets/js/575.f79d364c.js"><link rel="prefetch" href="/prepare/assets/js/576.3ddb20cd.js"><link rel="prefetch" href="/prepare/assets/js/577.9a092ee4.js"><link rel="prefetch" href="/prepare/assets/js/578.6070878e.js"><link rel="prefetch" href="/prepare/assets/js/579.1ba8ede0.js"><link rel="prefetch" href="/prepare/assets/js/58.0dae4bef.js"><link rel="prefetch" href="/prepare/assets/js/580.d7042f21.js"><link rel="prefetch" href="/prepare/assets/js/581.2de732c0.js"><link rel="prefetch" href="/prepare/assets/js/582.cd5dbae7.js"><link rel="prefetch" href="/prepare/assets/js/583.87210fd0.js"><link rel="prefetch" href="/prepare/assets/js/584.c2771cc5.js"><link rel="prefetch" href="/prepare/assets/js/585.48e096b6.js"><link rel="prefetch" href="/prepare/assets/js/586.6e750908.js"><link rel="prefetch" href="/prepare/assets/js/587.d53d0968.js"><link rel="prefetch" href="/prepare/assets/js/588.d2c80932.js"><link rel="prefetch" href="/prepare/assets/js/589.f3c4c4da.js"><link rel="prefetch" href="/prepare/assets/js/59.f51e3a1f.js"><link rel="prefetch" href="/prepare/assets/js/590.7c317a81.js"><link rel="prefetch" href="/prepare/assets/js/591.c691df86.js"><link rel="prefetch" href="/prepare/assets/js/592.fe78ac72.js"><link rel="prefetch" href="/prepare/assets/js/593.946169fc.js"><link rel="prefetch" href="/prepare/assets/js/594.84ff33e0.js"><link rel="prefetch" href="/prepare/assets/js/595.8d603500.js"><link rel="prefetch" href="/prepare/assets/js/596.9037d8bd.js"><link rel="prefetch" href="/prepare/assets/js/597.3584ee48.js"><link rel="prefetch" href="/prepare/assets/js/598.d0f1e06e.js"><link rel="prefetch" href="/prepare/assets/js/599.244624d9.js"><link rel="prefetch" href="/prepare/assets/js/6.9444d72f.js"><link rel="prefetch" href="/prepare/assets/js/60.70695472.js"><link rel="prefetch" href="/prepare/assets/js/600.d5234d51.js"><link rel="prefetch" href="/prepare/assets/js/601.723df476.js"><link rel="prefetch" href="/prepare/assets/js/602.07966dec.js"><link rel="prefetch" href="/prepare/assets/js/603.62a8807f.js"><link rel="prefetch" href="/prepare/assets/js/604.31c942a3.js"><link rel="prefetch" href="/prepare/assets/js/605.8ba5cc1f.js"><link rel="prefetch" href="/prepare/assets/js/606.b05df817.js"><link rel="prefetch" href="/prepare/assets/js/607.80c1b284.js"><link rel="prefetch" href="/prepare/assets/js/608.bed17c81.js"><link rel="prefetch" href="/prepare/assets/js/609.9c1d6018.js"><link rel="prefetch" href="/prepare/assets/js/61.f452eb1e.js"><link rel="prefetch" href="/prepare/assets/js/610.7c22b2de.js"><link rel="prefetch" href="/prepare/assets/js/611.626db025.js"><link rel="prefetch" href="/prepare/assets/js/612.951eb340.js"><link rel="prefetch" href="/prepare/assets/js/613.fdc2cba6.js"><link rel="prefetch" href="/prepare/assets/js/614.fa50b41b.js"><link rel="prefetch" href="/prepare/assets/js/615.0c5e1f6c.js"><link rel="prefetch" href="/prepare/assets/js/616.5078b12e.js"><link rel="prefetch" href="/prepare/assets/js/617.f9b2b30d.js"><link rel="prefetch" href="/prepare/assets/js/618.62e1a93f.js"><link rel="prefetch" href="/prepare/assets/js/619.ee7f121d.js"><link rel="prefetch" href="/prepare/assets/js/62.537fb957.js"><link rel="prefetch" href="/prepare/assets/js/621.4546ee76.js"><link rel="prefetch" href="/prepare/assets/js/622.47123d65.js"><link rel="prefetch" href="/prepare/assets/js/623.0b603a20.js"><link rel="prefetch" href="/prepare/assets/js/624.74068c21.js"><link rel="prefetch" href="/prepare/assets/js/625.8e7cd8e8.js"><link rel="prefetch" href="/prepare/assets/js/626.3b72ceec.js"><link rel="prefetch" href="/prepare/assets/js/627.743c55f8.js"><link rel="prefetch" href="/prepare/assets/js/628.596c5223.js"><link rel="prefetch" href="/prepare/assets/js/629.603fbc3b.js"><link rel="prefetch" href="/prepare/assets/js/63.9b6fda45.js"><link rel="prefetch" href="/prepare/assets/js/630.5e98798e.js"><link rel="prefetch" href="/prepare/assets/js/631.de9ce315.js"><link rel="prefetch" href="/prepare/assets/js/632.67a34980.js"><link rel="prefetch" href="/prepare/assets/js/633.c33eedbd.js"><link rel="prefetch" href="/prepare/assets/js/634.639a5b75.js"><link rel="prefetch" href="/prepare/assets/js/635.e7566bd6.js"><link rel="prefetch" href="/prepare/assets/js/636.c03bf92e.js"><link rel="prefetch" href="/prepare/assets/js/637.4f1c16a4.js"><link rel="prefetch" href="/prepare/assets/js/64.7d5117e3.js"><link rel="prefetch" href="/prepare/assets/js/65.c6817900.js"><link rel="prefetch" href="/prepare/assets/js/66.0d92e78c.js"><link rel="prefetch" href="/prepare/assets/js/67.bfba1dfe.js"><link rel="prefetch" href="/prepare/assets/js/68.01d551fa.js"><link rel="prefetch" href="/prepare/assets/js/69.5e6c1f1e.js"><link rel="prefetch" href="/prepare/assets/js/7.06976092.js"><link rel="prefetch" href="/prepare/assets/js/70.01d73133.js"><link rel="prefetch" href="/prepare/assets/js/71.7c3de2c4.js"><link rel="prefetch" href="/prepare/assets/js/72.e76e5fb2.js"><link rel="prefetch" href="/prepare/assets/js/73.82fabf4c.js"><link rel="prefetch" href="/prepare/assets/js/74.3f28dbee.js"><link rel="prefetch" href="/prepare/assets/js/75.52a9417d.js"><link rel="prefetch" href="/prepare/assets/js/76.66195e23.js"><link rel="prefetch" href="/prepare/assets/js/77.ef053e83.js"><link rel="prefetch" href="/prepare/assets/js/78.3fa1085d.js"><link rel="prefetch" href="/prepare/assets/js/79.29f7ac3c.js"><link rel="prefetch" href="/prepare/assets/js/8.8784c020.js"><link rel="prefetch" href="/prepare/assets/js/80.ef72de3c.js"><link rel="prefetch" href="/prepare/assets/js/81.b077feaa.js"><link rel="prefetch" href="/prepare/assets/js/82.e231e989.js"><link rel="prefetch" href="/prepare/assets/js/83.3fd80644.js"><link rel="prefetch" href="/prepare/assets/js/84.4ba9fae0.js"><link rel="prefetch" href="/prepare/assets/js/85.16eeddc5.js"><link rel="prefetch" href="/prepare/assets/js/86.0dbb6ccf.js"><link rel="prefetch" href="/prepare/assets/js/87.559533ad.js"><link rel="prefetch" href="/prepare/assets/js/88.bc8b8b8f.js"><link rel="prefetch" href="/prepare/assets/js/89.40142912.js"><link rel="prefetch" href="/prepare/assets/js/9.e0475b8b.js"><link rel="prefetch" href="/prepare/assets/js/90.9c39370c.js"><link rel="prefetch" href="/prepare/assets/js/91.0dc7f473.js"><link rel="prefetch" href="/prepare/assets/js/92.0c4fb004.js"><link rel="prefetch" href="/prepare/assets/js/93.61288dd3.js"><link rel="prefetch" href="/prepare/assets/js/94.27dc11c8.js"><link rel="prefetch" href="/prepare/assets/js/95.e9b3d2e2.js"><link rel="prefetch" href="/prepare/assets/js/96.ff539867.js"><link rel="prefetch" href="/prepare/assets/js/97.780f1441.js"><link rel="prefetch" href="/prepare/assets/js/98.7ead62e3.js"><link rel="prefetch" href="/prepare/assets/js/99.700f1951.js">
    <link rel="stylesheet" href="/prepare/assets/css/0.styles.080a75b5.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/prepare/" class="home-link router-link-active"><!----> <span class="site-name">Lu notes</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/prepare/" class="nav-link">首页</a></div><div class="nav-item"><a href="/prepare/js/" class="nav-link">Js</a></div><div class="nav-item"><a href="/prepare/react/" class="nav-link">React</a></div><div class="nav-item"><a href="/prepare/vue/" class="nav-link router-link-active">Vue</a></div><div class="nav-item"><a href="/prepare/framework/" class="nav-link">框架通识</a></div><div class="nav-item"><a href="/prepare/safety/" class="nav-link">安全性能</a></div><div class="nav-item"><a href="/prepare/prepare/" class="nav-link">Prepare</a></div><div class="nav-item"><a href="/prepare/handrolledcode/" class="nav-link">手撸代码无敌</a></div><div class="nav-item"><a href="/prepare/dataalgorithm/" class="nav-link">数据算法</a></div><div class="nav-item"><a href="/prepare/engineering/" class="nav-link">工程化</a></div><div class="nav-item"><a href="/prepare/other/" class="nav-link">其他</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/prepare/" class="nav-link">首页</a></div><div class="nav-item"><a href="/prepare/js/" class="nav-link">Js</a></div><div class="nav-item"><a href="/prepare/react/" class="nav-link">React</a></div><div class="nav-item"><a href="/prepare/vue/" class="nav-link router-link-active">Vue</a></div><div class="nav-item"><a href="/prepare/framework/" class="nav-link">框架通识</a></div><div class="nav-item"><a href="/prepare/safety/" class="nav-link">安全性能</a></div><div class="nav-item"><a href="/prepare/prepare/" class="nav-link">Prepare</a></div><div class="nav-item"><a href="/prepare/handrolledcode/" class="nav-link">手撸代码无敌</a></div><div class="nav-item"><a href="/prepare/dataalgorithm/" class="nav-link">数据算法</a></div><div class="nav-item"><a href="/prepare/engineering/" class="nav-link">工程化</a></div><div class="nav-item"><a href="/prepare/other/" class="nav-link">其他</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><a href="/prepare/vue/Vue基础/" class="sidebar-heading clickable"><span>Vue基础</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/prepare/vue/Vue源码分析/" class="sidebar-heading clickable open"><span>Vue源码分析</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/prepare/vue/Vue源码分析/01-NextTick原理分析.html" class="sidebar-link">01-NextTick原理分析</a></li><li><a href="/prepare/vue/Vue源码分析/02-从Vue.js源码看nextTick机制.html" class="sidebar-link">02-从Vue.js源码看nextTick机制</a></li><li><a href="/prepare/vue/Vue源码分析/03-Vue&amp;&amp;MVVM原理.html" class="sidebar-link">03-Vue&amp;&amp;MVVM原理</a></li><li><a href="/prepare/vue/Vue源码分析/04-剖析Vue原理&amp;实现双向绑定MVVM.html" class="sidebar-link">04-剖析Vue原理&amp;实现双向绑定MVVM</a></li><li><a href="/prepare/vue/Vue源码分析/05-vue源码解析－事件机制.html" class="sidebar-link">05-vue源码解析－事件机制</a></li><li><a href="/prepare/vue/Vue源码分析/06-150行代码实现一个低配版的MVVM库.html" class="sidebar-link">06-150行代码实现一个低配版的MVVM库</a></li><li><a href="/prepare/vue/Vue源码分析/07-160行代码仿Vue实现极简双向绑定[详细注释].html" class="sidebar-link">07-160行代码仿Vue实现极简双向绑定[详细注释]</a></li><li><a href="/prepare/vue/Vue源码分析/08-撸一个简单的Vue.html" class="sidebar-link">08-撸一个简单的Vue</a></li><li><a href="/prepare/vue/Vue源码分析/09-基于proxy的简易版vue.html" class="sidebar-link">09-基于proxy的简易版vue</a></li><li><a href="/prepare/vue/Vue源码分析/10-VueRouter源码分析.html" class="active sidebar-link">10-VueRouter源码分析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/prepare/vue/Vue源码分析/10-VueRouter源码分析.html#路由注册" class="sidebar-link">路由注册</a></li><li class="sidebar-sub-header"><a href="/prepare/vue/Vue源码分析/10-VueRouter源码分析.html#vuerouter-实例化" class="sidebar-link">VueRouter 实例化</a></li><li class="sidebar-sub-header"><a href="/prepare/vue/Vue源码分析/10-VueRouter源码分析.html#创建路由匹配对象" class="sidebar-link">创建路由匹配对象</a></li><li class="sidebar-sub-header"><a href="/prepare/vue/Vue源码分析/10-VueRouter源码分析.html#路由初始化" class="sidebar-link">路由初始化</a></li><li class="sidebar-sub-header"><a href="/prepare/vue/Vue源码分析/10-VueRouter源码分析.html#路由跳转" class="sidebar-link">路由跳转</a></li></ul></li><li><a href="/prepare/vue/Vue源码分析/11-Vuex源码深度解析.html" class="sidebar-link">11-Vuex源码深度解析</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/prepare/vue/Vue进阶/" class="sidebar-heading clickable"><span>Vue进阶</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/prepare/vue/Vue项目/" class="sidebar-heading clickable"><span>Vue项目</span> <span class="arrow right"></span></a> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="vuerouter-源码解析"><a href="#vuerouter-源码解析" aria-hidden="true" class="header-anchor">#</a> VueRouter 源码解析</h1> <ul><li><a href="#vuerouter-%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90">VueRouter 源码解析</a> <ul><li><a href="#%E8%B7%AF%E7%94%B1%E6%B3%A8%E5%86%8C">路由注册</a></li> <li><a href="#vuerouter-%E5%AE%9E%E4%BE%8B%E5%8C%96">VueRouter 实例化</a></li> <li><a href="#%E5%88%9B%E5%BB%BA%E8%B7%AF%E7%94%B1%E5%8C%B9%E9%85%8D%E5%AF%B9%E8%B1%A1">创建路由匹配对象</a></li> <li><a href="#%E8%B7%AF%E7%94%B1%E5%88%9D%E5%A7%8B%E5%8C%96">路由初始化</a></li> <li><a href="#%E8%B7%AF%E7%94%B1%E8%B7%B3%E8%BD%AC">路由跳转</a></li></ul></li></ul> <h2 id="路由注册"><a href="#路由注册" aria-hidden="true" class="header-anchor">#</a> 路由注册</h2> <p>使用路由之前，需要调用 <code>Vue.use(VueRouter)</code>，这是因为让插件可以使用 <code>Vue</code></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">initUse</span><span class="token punctuation">(</span><span class="token parameter">Vue<span class="token punctuation">:</span> GlobalAPI</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Vue<span class="token punctuation">.</span><span class="token function-variable function">use</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">plugin<span class="token punctuation">:</span> Function <span class="token operator">|</span> Object</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 判断重复安装插件</span>
    <span class="token keyword">const</span> installedPlugins <span class="token operator">=</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>_installedPlugins <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_installedPlugins <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>installedPlugins<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>plugin<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> args <span class="token operator">=</span> <span class="token function">toArray</span><span class="token punctuation">(</span>arguments<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token comment">// 插入 Vue</span>
    args<span class="token punctuation">.</span><span class="token function">unshift</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
    <span class="token comment">// 一般插件都会有一个 install 函数</span>
    <span class="token comment">// 通过该函数让插件可以使用 Vue</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> plugin<span class="token punctuation">.</span>install <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      plugin<span class="token punctuation">.</span><span class="token function">install</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>plugin<span class="token punctuation">,</span> args<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> plugin <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">plugin</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    installedPlugins<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>plugin<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>接下来看下 <code>install</code> 函数的部分实现</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">install</span><span class="token punctuation">(</span><span class="token parameter">Vue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 确保 install 调用一次</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>install<span class="token punctuation">.</span>installed <span class="token operator">&amp;&amp;</span> _Vue <span class="token operator">===</span> Vue<span class="token punctuation">)</span> <span class="token keyword">return</span>
  install<span class="token punctuation">.</span>installed <span class="token operator">=</span> <span class="token boolean">true</span>
  <span class="token comment">// 把 Vue 赋值给全局变量</span>
  _Vue <span class="token operator">=</span> Vue
  <span class="token keyword">const</span> <span class="token function-variable function">registerInstance</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">vm<span class="token punctuation">,</span> callVal</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> i <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>_parentVnode
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      <span class="token function">isDef</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
      <span class="token function">isDef</span><span class="token punctuation">(</span><span class="token punctuation">(</span>i <span class="token operator">=</span> i<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
      <span class="token function">isDef</span><span class="token punctuation">(</span><span class="token punctuation">(</span>i <span class="token operator">=</span> i<span class="token punctuation">.</span>registerRouteInstance<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">i</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> callVal<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 给每个组件的钩子函数混入实现</span>
  <span class="token comment">// 可以发现在 `beforeCreate` 钩子执行时</span>
  <span class="token comment">// 会初始化路由</span>
  Vue<span class="token punctuation">.</span><span class="token function">mixin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token function">beforeCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 判断组件是否存在 router 对象，该对象只在根组件上有</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$options<span class="token punctuation">.</span>router<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 根路由设置为自己</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_routerRoot <span class="token operator">=</span> <span class="token keyword">this</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_router <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$options<span class="token punctuation">.</span>router
        <span class="token comment">// 初始化路由</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_router<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
        <span class="token comment">// 很重要，为 _route 属性实现双向绑定</span>
        <span class="token comment">// 触发组件渲染</span>
        Vue<span class="token punctuation">.</span>util<span class="token punctuation">.</span><span class="token function">defineReactive</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token string">'_route'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_router<span class="token punctuation">.</span>history<span class="token punctuation">.</span>current<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 用于 router-view 层级判断</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_routerRoot <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$parent <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$parent<span class="token punctuation">.</span>_routerRoot<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token keyword">this</span>
      <span class="token punctuation">}</span>
      <span class="token function">registerInstance</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">destroyed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">registerInstance</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">// 全局注册组件 router-link 和 router-view</span>
  Vue<span class="token punctuation">.</span><span class="token function">component</span><span class="token punctuation">(</span><span class="token string">'RouterView'</span><span class="token punctuation">,</span> View<span class="token punctuation">)</span>
  Vue<span class="token punctuation">.</span><span class="token function">component</span><span class="token punctuation">(</span><span class="token string">'RouterLink'</span><span class="token punctuation">,</span> Link<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br></div></div><p>对于路由注册来说，核心就是调用 <code>Vue.use(VueRouter)</code>，使得 VueRouter 可以使用 Vue。然后通过 Vue 来调用 VueRouter 的 <code>install</code> 函数。在该函数中，核心就是给组件混入钩子函数和全局注册两个路由组件。</p> <h2 id="vuerouter-实例化"><a href="#vuerouter-实例化" aria-hidden="true" class="header-anchor">#</a> VueRouter 实例化</h2> <p>在安装插件后，对 VueRouter 进行实例化。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> Home <span class="token operator">=</span> <span class="token punctuation">{</span> template<span class="token punctuation">:</span> <span class="token string">'&lt;div&gt;home&lt;/div&gt;'</span> <span class="token punctuation">}</span>
<span class="token keyword">const</span> Foo <span class="token operator">=</span> <span class="token punctuation">{</span> template<span class="token punctuation">:</span> <span class="token string">'&lt;div&gt;foo&lt;/div&gt;'</span> <span class="token punctuation">}</span>
<span class="token keyword">const</span> Bar <span class="token operator">=</span> <span class="token punctuation">{</span> template<span class="token punctuation">:</span> <span class="token string">'&lt;div&gt;bar&lt;/div&gt;'</span> <span class="token punctuation">}</span>

<span class="token comment">// 3. Create the router</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VueRouter</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  mode<span class="token punctuation">:</span> <span class="token string">'hash'</span><span class="token punctuation">,</span>
  base<span class="token punctuation">:</span> __dirname<span class="token punctuation">,</span>
  routes<span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span> path<span class="token punctuation">:</span> <span class="token string">'/'</span><span class="token punctuation">,</span> component<span class="token punctuation">:</span> Home <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// all paths are defined without the hash.</span>
    <span class="token punctuation">{</span> path<span class="token punctuation">:</span> <span class="token string">'/foo'</span><span class="token punctuation">,</span> component<span class="token punctuation">:</span> Foo <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> path<span class="token punctuation">:</span> <span class="token string">'/bar'</span><span class="token punctuation">,</span> component<span class="token punctuation">:</span> Bar <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>来看一下 VueRouter 的构造函数</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">options<span class="token punctuation">:</span> RouterOptions <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token comment">// 路由匹配对象</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>matcher <span class="token operator">=</span> <span class="token function">createMatcher</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>routes <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span>

  <span class="token comment">// 根据 mode 采取不同的路由方式</span>
  <span class="token keyword">let</span> mode <span class="token operator">=</span> options<span class="token punctuation">.</span>mode <span class="token operator">||</span> <span class="token string">'hash'</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>fallback <span class="token operator">=</span>
    mode <span class="token operator">===</span> <span class="token string">'history'</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>supportsPushState <span class="token operator">&amp;&amp;</span> options<span class="token punctuation">.</span>fallback <span class="token operator">!==</span> <span class="token boolean">false</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>fallback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    mode <span class="token operator">=</span> <span class="token string">'hash'</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>inBrowser<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    mode <span class="token operator">=</span> <span class="token string">'abstract'</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>mode <span class="token operator">=</span> mode

  <span class="token keyword">switch</span> <span class="token punctuation">(</span>mode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token string">'history'</span><span class="token punctuation">:</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>history <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HTML5History</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> options<span class="token punctuation">.</span>base<span class="token punctuation">)</span>
      <span class="token keyword">break</span>
    <span class="token keyword">case</span> <span class="token string">'hash'</span><span class="token punctuation">:</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>history <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashHistory</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> options<span class="token punctuation">.</span>base<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>fallback<span class="token punctuation">)</span>
      <span class="token keyword">break</span>
    <span class="token keyword">case</span> <span class="token string">'abstract'</span><span class="token punctuation">:</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>history <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AbstractHistory</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> options<span class="token punctuation">.</span>base<span class="token punctuation">)</span>
      <span class="token keyword">break</span>
    <span class="token keyword">default</span><span class="token punctuation">:</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">assert</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">invalid mode: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>mode<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><p>在实例化 VueRouter 的过程中，核心是创建一个路由匹配对象，并且根据 mode 来采取不同的路由方式。</p> <h2 id="创建路由匹配对象"><a href="#创建路由匹配对象" aria-hidden="true" class="header-anchor">#</a> 创建路由匹配对象</h2> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createMatcher</span><span class="token punctuation">(</span>
  <span class="token parameter">routes<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>RouteConfig<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  router<span class="token punctuation">:</span> VueRouter</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span> Matcher <span class="token punctuation">{</span>
  <span class="token comment">// 创建路由映射表</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> pathList<span class="token punctuation">,</span> pathMap<span class="token punctuation">,</span> nameMap <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">createRouteMap</span><span class="token punctuation">(</span>routes<span class="token punctuation">)</span>

  <span class="token keyword">function</span> <span class="token function">addRoutes</span><span class="token punctuation">(</span><span class="token parameter">routes</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">createRouteMap</span><span class="token punctuation">(</span>routes<span class="token punctuation">,</span> pathList<span class="token punctuation">,</span> pathMap<span class="token punctuation">,</span> nameMap<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 路由匹配</span>
  <span class="token keyword">function</span> <span class="token function">match</span><span class="token punctuation">(</span>
    <span class="token parameter">raw<span class="token punctuation">:</span> RawLocation<span class="token punctuation">,</span>
    currentRoute<span class="token operator">?</span><span class="token punctuation">:</span> Route<span class="token punctuation">,</span>
    redirectedFrom<span class="token operator">?</span><span class="token punctuation">:</span> Location</span>
  <span class="token punctuation">)</span><span class="token punctuation">:</span> Route <span class="token punctuation">{</span>
    <span class="token comment">//...</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    match<span class="token punctuation">,</span>
    addRoutes
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p><code>createMatcher</code> 函数的作用就是创建路由映射表，然后通过闭包的方式让 <code>addRoutes</code> 和 <code>match</code> 函数能够使用路由映射表的几个对象，最后返回一个 <code>Matcher</code> 对象。</p> <p>接下来看 <code>createMatcher</code> 函数时如何创建映射表的</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createRouteMap</span><span class="token punctuation">(</span>
  <span class="token parameter">routes<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>RouteConfig<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  oldPathList<span class="token operator">?</span><span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  oldPathMap<span class="token operator">?</span><span class="token punctuation">:</span> Dictionary<span class="token operator">&lt;</span>RouteRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  oldNameMap<span class="token operator">?</span><span class="token punctuation">:</span> Dictionary<span class="token operator">&lt;</span>RouteRecord<span class="token operator">&gt;</span></span>
<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
  pathList<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  pathMap<span class="token punctuation">:</span> Dictionary<span class="token operator">&lt;</span>RouteRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  nameMap<span class="token punctuation">:</span> Dictionary<span class="token operator">&lt;</span>RouteRecord<span class="token operator">&gt;</span>
<span class="token punctuation">}</span> <span class="token punctuation">{</span>
  <span class="token comment">// 创建映射表</span>
  <span class="token keyword">const</span> pathList<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span> <span class="token operator">=</span> oldPathList <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">const</span> pathMap<span class="token punctuation">:</span> Dictionary<span class="token operator">&lt;</span>RouteRecord<span class="token operator">&gt;</span> <span class="token operator">=</span> oldPathMap <span class="token operator">||</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> nameMap<span class="token punctuation">:</span> Dictionary<span class="token operator">&lt;</span>RouteRecord<span class="token operator">&gt;</span> <span class="token operator">=</span> oldNameMap <span class="token operator">||</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
  <span class="token comment">// 遍历路由配置，为每个配置添加路由记录</span>
  routes<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">route</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">addRouteRecord</span><span class="token punctuation">(</span>pathList<span class="token punctuation">,</span> pathMap<span class="token punctuation">,</span> nameMap<span class="token punctuation">,</span> route<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">// 确保通配符在最后</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> l <span class="token operator">=</span> pathList<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pathList<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'*'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      pathList<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>pathList<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
      l<span class="token operator">--</span>
      i<span class="token operator">--</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    pathList<span class="token punctuation">,</span>
    pathMap<span class="token punctuation">,</span>
    nameMap
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 添加路由记录</span>
<span class="token keyword">function</span> <span class="token function">addRouteRecord</span><span class="token punctuation">(</span>
  <span class="token parameter">pathList<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  pathMap<span class="token punctuation">:</span> Dictionary<span class="token operator">&lt;</span>RouteRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  nameMap<span class="token punctuation">:</span> Dictionary<span class="token operator">&lt;</span>RouteRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  route<span class="token punctuation">:</span> RouteConfig<span class="token punctuation">,</span>
  parent<span class="token operator">?</span><span class="token punctuation">:</span> RouteRecord<span class="token punctuation">,</span>
  matchAs<span class="token operator">?</span><span class="token punctuation">:</span> string</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 获得路由配置下的属性</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> path<span class="token punctuation">,</span> name <span class="token punctuation">}</span> <span class="token operator">=</span> route
  <span class="token keyword">const</span> pathToRegexpOptions<span class="token punctuation">:</span> PathToRegexpOptions <span class="token operator">=</span>
    route<span class="token punctuation">.</span>pathToRegexpOptions <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token comment">// 格式化 url，替换 /</span>
  <span class="token keyword">const</span> normalizedPath <span class="token operator">=</span> <span class="token function">normalizePath</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> parent<span class="token punctuation">,</span> pathToRegexpOptions<span class="token punctuation">.</span>strict<span class="token punctuation">)</span>
  <span class="token comment">// 生成记录对象</span>
  <span class="token keyword">const</span> record<span class="token punctuation">:</span> RouteRecord <span class="token operator">=</span> <span class="token punctuation">{</span>
    path<span class="token punctuation">:</span> normalizedPath<span class="token punctuation">,</span>
    regex<span class="token punctuation">:</span> <span class="token function">compileRouteRegex</span><span class="token punctuation">(</span>normalizedPath<span class="token punctuation">,</span> pathToRegexpOptions<span class="token punctuation">)</span><span class="token punctuation">,</span>
    components<span class="token punctuation">:</span> route<span class="token punctuation">.</span>components <span class="token operator">||</span> <span class="token punctuation">{</span> <span class="token keyword">default</span><span class="token punctuation">:</span> route<span class="token punctuation">.</span>component <span class="token punctuation">}</span><span class="token punctuation">,</span>
    instances<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    name<span class="token punctuation">,</span>
    parent<span class="token punctuation">,</span>
    matchAs<span class="token punctuation">,</span>
    redirect<span class="token punctuation">:</span> route<span class="token punctuation">.</span>redirect<span class="token punctuation">,</span>
    beforeEnter<span class="token punctuation">:</span> route<span class="token punctuation">.</span>beforeEnter<span class="token punctuation">,</span>
    meta<span class="token punctuation">:</span> route<span class="token punctuation">.</span>meta <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    props<span class="token punctuation">:</span>
      route<span class="token punctuation">.</span>props <span class="token operator">==</span> <span class="token keyword">null</span>
        <span class="token operator">?</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token punctuation">:</span> route<span class="token punctuation">.</span>components
        <span class="token operator">?</span> route<span class="token punctuation">.</span>props
        <span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token keyword">default</span><span class="token punctuation">:</span> route<span class="token punctuation">.</span>props <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>route<span class="token punctuation">.</span>children<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 递归路由配置的 children 属性，添加路由记录</span>
    route<span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">child</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> childMatchAs <span class="token operator">=</span> matchAs
        <span class="token operator">?</span> <span class="token function">cleanPath</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>matchAs<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>child<span class="token punctuation">.</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">:</span> <span class="token keyword">undefined</span>
      <span class="token function">addRouteRecord</span><span class="token punctuation">(</span>pathList<span class="token punctuation">,</span> pathMap<span class="token punctuation">,</span> nameMap<span class="token punctuation">,</span> child<span class="token punctuation">,</span> record<span class="token punctuation">,</span> childMatchAs<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 如果路由有别名的话</span>
  <span class="token comment">// 给别名也添加路由记录</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>route<span class="token punctuation">.</span>alias <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> aliases <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>route<span class="token punctuation">.</span>alias<span class="token punctuation">)</span> <span class="token operator">?</span> route<span class="token punctuation">.</span>alias <span class="token punctuation">:</span> <span class="token punctuation">[</span>route<span class="token punctuation">.</span>alias<span class="token punctuation">]</span>

    aliases<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">alias</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> aliasRoute <span class="token operator">=</span> <span class="token punctuation">{</span>
        path<span class="token punctuation">:</span> alias<span class="token punctuation">,</span>
        children<span class="token punctuation">:</span> route<span class="token punctuation">.</span>children
      <span class="token punctuation">}</span>
      <span class="token function">addRouteRecord</span><span class="token punctuation">(</span>
        pathList<span class="token punctuation">,</span>
        pathMap<span class="token punctuation">,</span>
        nameMap<span class="token punctuation">,</span>
        aliasRoute<span class="token punctuation">,</span>
        parent<span class="token punctuation">,</span>
        record<span class="token punctuation">.</span>path <span class="token operator">||</span> <span class="token string">'/'</span> <span class="token comment">// matchAs</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 更新映射表</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pathMap<span class="token punctuation">[</span>record<span class="token punctuation">.</span>path<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    pathList<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>record<span class="token punctuation">.</span>path<span class="token punctuation">)</span>
    pathMap<span class="token punctuation">[</span>record<span class="token punctuation">.</span>path<span class="token punctuation">]</span> <span class="token operator">=</span> record
  <span class="token punctuation">}</span>
  <span class="token comment">// 命名路由添加记录</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>nameMap<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      nameMap<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> record
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>matchAs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">warn</span><span class="token punctuation">(</span>
        <span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Duplicate named routes definition: </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">{ name: &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;, path: &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>record<span class="token punctuation">.</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; }</span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br></div></div><p>以上就是创建路由匹配对象的全过程，通过用户配置的路由规则来创建对应的路由映射表。</p> <h2 id="路由初始化"><a href="#路由初始化" aria-hidden="true" class="header-anchor">#</a> 路由初始化</h2> <p>当根组件调用 <code>beforeCreate</code> 钩子函数时，会执行以下代码</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">beforeCreate</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment">// 只有根组件有 router 属性，所以根组件初始化时会初始化路由</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$options<span class="token punctuation">.</span>router<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_routerRoot <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_router <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$options<span class="token punctuation">.</span>router
    <span class="token keyword">this</span><span class="token punctuation">.</span>_router<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
    Vue<span class="token punctuation">.</span>util<span class="token punctuation">.</span><span class="token function">defineReactive</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token string">'_route'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_router<span class="token punctuation">.</span>history<span class="token punctuation">.</span>current<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_routerRoot <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$parent <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$parent<span class="token punctuation">.</span>_routerRoot<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token keyword">this</span>
  <span class="token punctuation">}</span>
  <span class="token function">registerInstance</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>接下来看下路由初始化会做些什么</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">init</span><span class="token punctuation">(</span>app<span class="token punctuation">:</span> any <span class="token comment">/* Vue component instance */</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 保存组件实例</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>apps<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span>
  <span class="token comment">// 如果根组件已经有了就返回</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>app<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>app <span class="token operator">=</span> app
  <span class="token comment">// 赋值路由模式</span>
  <span class="token keyword">const</span> history <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>history
  <span class="token comment">// 判断路由模式，以哈希模式为例</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>history <span class="token keyword">instanceof</span> <span class="token class-name">HTML5History</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    history<span class="token punctuation">.</span><span class="token function">transitionTo</span><span class="token punctuation">(</span>history<span class="token punctuation">.</span><span class="token function">getCurrentLocation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>history <span class="token keyword">instanceof</span> <span class="token class-name">HashHistory</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 添加 hashchange 监听</span>
    <span class="token keyword">const</span> <span class="token function-variable function">setupHashListener</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      history<span class="token punctuation">.</span><span class="token function">setupListeners</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 路由跳转</span>
    history<span class="token punctuation">.</span><span class="token function">transitionTo</span><span class="token punctuation">(</span>
      history<span class="token punctuation">.</span><span class="token function">getCurrentLocation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      setupHashListener<span class="token punctuation">,</span>
      setupHashListener
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 该回调会在 transitionTo 中调用</span>
  <span class="token comment">// 对组件的 _route 属性进行赋值，触发组件渲染</span>
  history<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token parameter">route</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>apps<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      app<span class="token punctuation">.</span>_route <span class="token operator">=</span> route
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><p>在路由初始化时，核心就是进行路由的跳转，改变 URL 然后渲染对应的组件。接下来来看一下路由是如何进行跳转的。</p> <h2 id="路由跳转"><a href="#路由跳转" aria-hidden="true" class="header-anchor">#</a> 路由跳转</h2> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">transitionTo</span> <span class="token punctuation">(</span><span class="token parameter">location<span class="token punctuation">:</span> RawLocation<span class="token punctuation">,</span> onComplete<span class="token operator">?</span><span class="token punctuation">:</span> Function<span class="token punctuation">,</span> onAbort<span class="token operator">?</span><span class="token punctuation">:</span> Function</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 获取匹配的路由信息</span>
  <span class="token keyword">const</span> route <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>location<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>current<span class="token punctuation">)</span>
  <span class="token comment">// 确认切换路由</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">confirmTransition</span><span class="token punctuation">(</span>route<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 以下为切换路由成功或失败的回调</span>
    <span class="token comment">// 更新路由信息，对组件的 _route 属性进行赋值，触发组件渲染</span>
    <span class="token comment">// 调用 afterHooks 中的钩子函数</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateRoute</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span>
    <span class="token comment">// 添加 hashchange 监听</span>
    onComplete <span class="token operator">&amp;&amp;</span> <span class="token function">onComplete</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span>
    <span class="token comment">// 更新 URL</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">ensureURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 只执行一次 ready 回调</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>ready<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>ready <span class="token operator">=</span> <span class="token boolean">true</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>readyCbs<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">cb</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token function">cb</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 错误处理</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>onAbort<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">onAbort</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>ready<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>ready <span class="token operator">=</span> <span class="token boolean">true</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>readyErrorCbs<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">cb</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token function">cb</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><p>在路由跳转中，需要先获取匹配的路由信息，所以先来看下如何获取匹配的路由信息</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">match</span><span class="token punctuation">(</span>
  <span class="token parameter">raw<span class="token punctuation">:</span> RawLocation<span class="token punctuation">,</span>
  currentRoute<span class="token operator">?</span><span class="token punctuation">:</span> Route<span class="token punctuation">,</span>
  redirectedFrom<span class="token operator">?</span><span class="token punctuation">:</span> Location</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span> Route <span class="token punctuation">{</span>
  <span class="token comment">// 序列化 url</span>
  <span class="token comment">// 比如对于该 url 来说 /abc?foo=bar&amp;baz=qux##hello</span>
  <span class="token comment">// 会序列化路径为 /abc</span>
  <span class="token comment">// 哈希为 ##hello</span>
  <span class="token comment">// 参数为 foo: 'bar', baz: 'qux'</span>
  <span class="token keyword">const</span> location <span class="token operator">=</span> <span class="token function">normalizeLocation</span><span class="token punctuation">(</span>raw<span class="token punctuation">,</span> currentRoute<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> router<span class="token punctuation">)</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> name <span class="token punctuation">}</span> <span class="token operator">=</span> location
  <span class="token comment">// 如果是命名路由，就判断记录中是否有该命名路由配置</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> record <span class="token operator">=</span> nameMap<span class="token punctuation">[</span>name<span class="token punctuation">]</span>
    <span class="token comment">// 没找到表示没有匹配的路由</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>record<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">_createRoute</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> location<span class="token punctuation">)</span>
    <span class="token keyword">const</span> paramNames <span class="token operator">=</span> record<span class="token punctuation">.</span>regex<span class="token punctuation">.</span>keys
      <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=&gt;</span> <span class="token operator">!</span>key<span class="token punctuation">.</span>optional<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=&gt;</span> key<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
    <span class="token comment">// 参数处理</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> location<span class="token punctuation">.</span>params <span class="token operator">!==</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      location<span class="token punctuation">.</span>params <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>currentRoute <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> currentRoute<span class="token punctuation">.</span>params <span class="token operator">===</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> currentRoute<span class="token punctuation">.</span>params<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>key <span class="token keyword">in</span> location<span class="token punctuation">.</span>params<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> paramNames<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          location<span class="token punctuation">.</span>params<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> currentRoute<span class="token punctuation">.</span>params<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>record<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      location<span class="token punctuation">.</span>path <span class="token operator">=</span> <span class="token function">fillParams</span><span class="token punctuation">(</span>
        record<span class="token punctuation">.</span>path<span class="token punctuation">,</span>
        location<span class="token punctuation">.</span>params<span class="token punctuation">,</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">named route &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;</span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token function">_createRoute</span><span class="token punctuation">(</span>record<span class="token punctuation">,</span> location<span class="token punctuation">,</span> redirectedFrom<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>location<span class="token punctuation">.</span>path<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 非命名路由处理</span>
    location<span class="token punctuation">.</span>params <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> pathList<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 查找记录</span>
      <span class="token keyword">const</span> path <span class="token operator">=</span> pathList<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
      <span class="token keyword">const</span> record <span class="token operator">=</span> pathMap<span class="token punctuation">[</span>path<span class="token punctuation">]</span>
      <span class="token comment">// 如果匹配路由，则创建路由</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">matchRoute</span><span class="token punctuation">(</span>record<span class="token punctuation">.</span>regex<span class="token punctuation">,</span> location<span class="token punctuation">.</span>path<span class="token punctuation">,</span> location<span class="token punctuation">.</span>params<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">_createRoute</span><span class="token punctuation">(</span>record<span class="token punctuation">,</span> location<span class="token punctuation">,</span> redirectedFrom<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 没有匹配的路由</span>
  <span class="token keyword">return</span> <span class="token function">_createRoute</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> location<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br></div></div><p>接下来看看如何创建路由</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 根据条件创建不同的路由</span>
<span class="token keyword">function</span> <span class="token function">_createRoute</span><span class="token punctuation">(</span>
  <span class="token parameter">record<span class="token punctuation">:</span> <span class="token operator">?</span>RouteRecord<span class="token punctuation">,</span>
  location<span class="token punctuation">:</span> Location<span class="token punctuation">,</span>
  redirectedFrom<span class="token operator">?</span><span class="token punctuation">:</span> Location</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span> Route <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>record <span class="token operator">&amp;&amp;</span> record<span class="token punctuation">.</span>redirect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">redirect</span><span class="token punctuation">(</span>record<span class="token punctuation">,</span> redirectedFrom <span class="token operator">||</span> location<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>record <span class="token operator">&amp;&amp;</span> record<span class="token punctuation">.</span>matchAs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">alias</span><span class="token punctuation">(</span>record<span class="token punctuation">,</span> location<span class="token punctuation">,</span> record<span class="token punctuation">.</span>matchAs<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token function">createRoute</span><span class="token punctuation">(</span>record<span class="token punctuation">,</span> location<span class="token punctuation">,</span> redirectedFrom<span class="token punctuation">,</span> router<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createRoute</span><span class="token punctuation">(</span>
  <span class="token parameter">record<span class="token punctuation">:</span> <span class="token operator">?</span>RouteRecord<span class="token punctuation">,</span>
  location<span class="token punctuation">:</span> Location<span class="token punctuation">,</span>
  redirectedFrom<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token operator">?</span>Location<span class="token punctuation">,</span>
  router<span class="token operator">?</span><span class="token punctuation">:</span> VueRouter</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span> Route <span class="token punctuation">{</span>
  <span class="token keyword">const</span> stringifyQuery <span class="token operator">=</span> router <span class="token operator">&amp;&amp;</span> router<span class="token punctuation">.</span>options<span class="token punctuation">.</span>stringifyQuery
  <span class="token comment">// 克隆参数</span>
  <span class="token keyword">let</span> query<span class="token punctuation">:</span> any <span class="token operator">=</span> location<span class="token punctuation">.</span>query <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    query <span class="token operator">=</span> <span class="token function">clone</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token comment">// 创建路由对象</span>
  <span class="token keyword">const</span> route<span class="token punctuation">:</span> Route <span class="token operator">=</span> <span class="token punctuation">{</span>
    name<span class="token punctuation">:</span> location<span class="token punctuation">.</span>name <span class="token operator">||</span> <span class="token punctuation">(</span>record <span class="token operator">&amp;&amp;</span> record<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">,</span>
    meta<span class="token punctuation">:</span> <span class="token punctuation">(</span>record <span class="token operator">&amp;&amp;</span> record<span class="token punctuation">.</span>meta<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    path<span class="token punctuation">:</span> location<span class="token punctuation">.</span>path <span class="token operator">||</span> <span class="token string">'/'</span><span class="token punctuation">,</span>
    hash<span class="token punctuation">:</span> location<span class="token punctuation">.</span>hash <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">,</span>
    query<span class="token punctuation">,</span>
    params<span class="token punctuation">:</span> location<span class="token punctuation">.</span>params <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    fullPath<span class="token punctuation">:</span> <span class="token function">getFullPath</span><span class="token punctuation">(</span>location<span class="token punctuation">,</span> stringifyQuery<span class="token punctuation">)</span><span class="token punctuation">,</span>
    matched<span class="token punctuation">:</span> record <span class="token operator">?</span> <span class="token function">formatMatch</span><span class="token punctuation">(</span>record<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>redirectedFrom<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    route<span class="token punctuation">.</span>redirectedFrom <span class="token operator">=</span> <span class="token function">getFullPath</span><span class="token punctuation">(</span>redirectedFrom<span class="token punctuation">,</span> stringifyQuery<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 让路由对象不可修改</span>
  <span class="token keyword">return</span> Object<span class="token punctuation">.</span><span class="token function">freeze</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// 获得包含当前路由的所有嵌套路径片段的路由记录</span>
<span class="token comment">// 包含从根路由到当前路由的匹配记录，从上至下</span>
<span class="token keyword">function</span> <span class="token function">formatMatch</span><span class="token punctuation">(</span><span class="token parameter">record<span class="token punctuation">:</span> <span class="token operator">?</span>RouteRecord</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>RouteRecord<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>record<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">unshift</span><span class="token punctuation">(</span>record<span class="token punctuation">)</span>
    record <span class="token operator">=</span> record<span class="token punctuation">.</span>parent
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> res
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br></div></div><p>至此匹配路由已经完成，我们回到 <code>transitionTo</code> 函数中，接下来执行 <code>confirmTransition</code></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">transitionTo</span> <span class="token punctuation">(</span><span class="token parameter">location<span class="token punctuation">:</span> RawLocation<span class="token punctuation">,</span> onComplete<span class="token operator">?</span><span class="token punctuation">:</span> Function<span class="token punctuation">,</span> onAbort<span class="token operator">?</span><span class="token punctuation">:</span> Function</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 确认切换路由</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">confirmTransition</span><span class="token punctuation">(</span>route<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token function">confirmTransition</span><span class="token punctuation">(</span><span class="token parameter">route<span class="token punctuation">:</span> Route<span class="token punctuation">,</span> onComplete<span class="token punctuation">:</span> Function<span class="token punctuation">,</span> onAbort<span class="token operator">?</span><span class="token punctuation">:</span> Function</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> current <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>current
  <span class="token comment">// 中断跳转路由函数</span>
  <span class="token keyword">const</span> <span class="token function-variable function">abort</span> <span class="token operator">=</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>errorCbs<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>errorCbs<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">cb</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token function">cb</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">warn</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token string">'uncaught error during route navigation:'</span><span class="token punctuation">)</span>
        console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    onAbort <span class="token operator">&amp;&amp;</span> <span class="token function">onAbort</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 如果是相同的路由就不跳转</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    <span class="token function">isSameRoute</span><span class="token punctuation">(</span>route<span class="token punctuation">,</span> current<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
    route<span class="token punctuation">.</span>matched<span class="token punctuation">.</span>length <span class="token operator">===</span> current<span class="token punctuation">.</span>matched<span class="token punctuation">.</span>length
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">ensureURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 通过对比路由解析出可复用的组件，需要渲染的组件，失活的组件</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> updated<span class="token punctuation">,</span> deactivated<span class="token punctuation">,</span> activated <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">resolveQueue</span><span class="token punctuation">(</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>current<span class="token punctuation">.</span>matched<span class="token punctuation">,</span>
    route<span class="token punctuation">.</span>matched
  <span class="token punctuation">)</span>

  <span class="token keyword">function</span> <span class="token function">resolveQueue</span><span class="token punctuation">(</span>
      <span class="token parameter">current<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>RouteRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span>
      next<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>RouteRecord<span class="token operator">&gt;</span></span>
    <span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
      updated<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>RouteRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span>
      activated<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>RouteRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span>
      deactivated<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>RouteRecord<span class="token operator">&gt;</span>
    <span class="token punctuation">}</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> i
      <span class="token keyword">const</span> max <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>current<span class="token punctuation">.</span>length<span class="token punctuation">,</span> next<span class="token punctuation">.</span>length<span class="token punctuation">)</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> max<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 当前路由路径和跳转路由路径不同时跳出遍历</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>current<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">!==</span> next<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">break</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span>
        <span class="token comment">// 可复用的组件对应路由</span>
        updated<span class="token punctuation">:</span> next<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">// 需要渲染的组件对应路由</span>
        activated<span class="token punctuation">:</span> next<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">// 失活的组件对应路由</span>
        deactivated<span class="token punctuation">:</span> current<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 导航守卫数组</span>
  <span class="token keyword">const</span> queue<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span><span class="token operator">?</span>NavigationGuard<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>
    <span class="token comment">// 失活的组件钩子</span>
    <span class="token function">extractLeaveGuards</span><span class="token punctuation">(</span>deactivated<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">// 全局 beforeEach 钩子</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">.</span>beforeHooks<span class="token punctuation">,</span>
    <span class="token comment">// 在当前路由改变，但是该组件被复用时调用</span>
    <span class="token function">extractUpdateHooks</span><span class="token punctuation">(</span>updated<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">// 需要渲染组件 enter 守卫钩子</span>
    activated<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">m</span> <span class="token operator">=&gt;</span> m<span class="token punctuation">.</span>beforeEnter<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">// 解析异步路由组件</span>
    <span class="token function">resolveAsyncComponents</span><span class="token punctuation">(</span>activated<span class="token punctuation">)</span>
  <span class="token punctuation">)</span>
  <span class="token comment">// 保存路由</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>pending <span class="token operator">=</span> route
  <span class="token comment">// 迭代器，用于执行 queue 中的导航守卫钩子</span>
  <span class="token keyword">const</span> <span class="token function-variable function">iterator</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">hook<span class="token punctuation">:</span> NavigationGuard<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 路由不相等就不跳转路由</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>pending <span class="token operator">!==</span> route<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">// 执行钩子</span>
      <span class="token function">hook</span><span class="token punctuation">(</span>route<span class="token punctuation">,</span> current<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">to<span class="token punctuation">:</span> any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 只有执行了钩子函数中的 next，才会继续执行下一个钩子函数</span>
        <span class="token comment">// 否则会暂停跳转</span>
        <span class="token comment">// 以下逻辑是在判断 next() 中的传参</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>to <span class="token operator">===</span> <span class="token boolean">false</span> <span class="token operator">||</span> <span class="token function">isError</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// next(false)</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">ensureURL</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
          <span class="token function">abort</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>
          <span class="token keyword">typeof</span> to <span class="token operator">===</span> <span class="token string">'string'</span> <span class="token operator">||</span>
          <span class="token punctuation">(</span><span class="token keyword">typeof</span> to <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span>
            <span class="token punctuation">(</span><span class="token keyword">typeof</span> to<span class="token punctuation">.</span>path <span class="token operator">===</span> <span class="token string">'string'</span> <span class="token operator">||</span> <span class="token keyword">typeof</span> to<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// next('/') 或者 next({ path: '/' }) -&gt; 重定向</span>
          <span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> to <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> to<span class="token punctuation">.</span>replace<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 这里执行 next</span>
        <span class="token comment">// 也就是执行下面函数 runQueue 中的 step(index + 1)</span>
          <span class="token function">next</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">abort</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 经典的同步执行异步函数</span>
  <span class="token function">runQueue</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> iterator<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> postEnterCbs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">const</span> <span class="token function-variable function">isValid</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>current <span class="token operator">===</span> route
    <span class="token comment">// 当所有异步组件加载完成后，会执行这里的回调，也就是 runQueue 中的 cb()</span>
    <span class="token comment">// 接下来执行 需要渲染组件的导航守卫钩子</span>
    <span class="token keyword">const</span> enterGuards <span class="token operator">=</span> <span class="token function">extractEnterGuards</span><span class="token punctuation">(</span>activated<span class="token punctuation">,</span> postEnterCbs<span class="token punctuation">,</span> isValid<span class="token punctuation">)</span>
    <span class="token keyword">const</span> queue <span class="token operator">=</span> enterGuards<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">.</span>resolveHooks<span class="token punctuation">)</span>
    <span class="token function">runQueue</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> iterator<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 跳转完成</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>pending <span class="token operator">!==</span> route<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>pending <span class="token operator">=</span> <span class="token keyword">null</span>
      <span class="token function">onComplete</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">.</span>app<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">.</span>app<span class="token punctuation">.</span><span class="token function">$nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          postEnterCbs<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">cb</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">runQueue</span> <span class="token punctuation">(</span><span class="token parameter">queue<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span><span class="token operator">?</span>NavigationGuard<span class="token operator">&gt;</span><span class="token punctuation">,</span> fn<span class="token punctuation">:</span> Function<span class="token punctuation">,</span> cb<span class="token punctuation">:</span> Function</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token function-variable function">step</span> <span class="token operator">=</span> <span class="token parameter">index</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 队列中的函数都执行完毕，就执行回调函数</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">&gt;=</span> queue<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>queue<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 执行迭代器，用户在钩子函数中执行 next() 回调</span>
      <span class="token comment">// 回调中判断传参，没有问题就执行 next()，也就是 fn 函数中的第二个参数</span>
        <span class="token function">fn</span><span class="token punctuation">(</span>queue<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token function">step</span><span class="token punctuation">(</span>index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">step</span><span class="token punctuation">(</span>index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 取出队列中第一个钩子函数</span>
  <span class="token function">step</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br></div></div><p>接下来介绍导航守卫</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> queue<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span><span class="token operator">?</span>NavigationGuard<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>
  <span class="token comment">// 失活的组件钩子</span>
  <span class="token function">extractLeaveGuards</span><span class="token punctuation">(</span>deactivated<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token comment">// 全局 beforeEach 钩子</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">.</span>beforeHooks<span class="token punctuation">,</span>
  <span class="token comment">// 在当前路由改变，但是该组件被复用时调用</span>
  <span class="token function">extractUpdateHooks</span><span class="token punctuation">(</span>updated<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token comment">// 需要渲染组件 enter 守卫钩子</span>
  activated<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">m</span> <span class="token operator">=&gt;</span> m<span class="token punctuation">.</span>beforeEnter<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token comment">// 解析异步路由组件</span>
  <span class="token function">resolveAsyncComponents</span><span class="token punctuation">(</span>activated<span class="token punctuation">)</span>
<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>第一步是先执行失活组件的钩子函数</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">extractLeaveGuards</span><span class="token punctuation">(</span><span class="token parameter">deactivated<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>RouteRecord<span class="token operator">&gt;</span></span><span class="token punctuation">)</span><span class="token punctuation">:</span> Array<span class="token operator">&lt;</span><span class="token operator">?</span>Function<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 传入需要执行的钩子函数名</span>
  <span class="token keyword">return</span> <span class="token function">extractGuards</span><span class="token punctuation">(</span>deactivated<span class="token punctuation">,</span> <span class="token string">'beforeRouteLeave'</span><span class="token punctuation">,</span> bindGuard<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">extractGuards</span><span class="token punctuation">(</span>
  <span class="token parameter">records<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>RouteRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  name<span class="token punctuation">:</span> string<span class="token punctuation">,</span>
  bind<span class="token punctuation">:</span> Function<span class="token punctuation">,</span>
  reverse<span class="token operator">?</span><span class="token punctuation">:</span> boolean</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span> Array<span class="token operator">&lt;</span><span class="token operator">?</span>Function<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> guards <span class="token operator">=</span> <span class="token function">flatMapComponents</span><span class="token punctuation">(</span>records<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">def<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> match<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 找出组件中对应的钩子函数</span>
    <span class="token keyword">const</span> guard <span class="token operator">=</span> <span class="token function">extractGuard</span><span class="token punctuation">(</span>def<span class="token punctuation">,</span> name<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>guard<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 给每个钩子函数添加上下文对象为组件自身</span>
      <span class="token keyword">return</span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>guard<span class="token punctuation">)</span>
        <span class="token operator">?</span> guard<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">guard</span> <span class="token operator">=&gt;</span> <span class="token function">bind</span><span class="token punctuation">(</span>guard<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> match<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">:</span> <span class="token function">bind</span><span class="token punctuation">(</span>guard<span class="token punctuation">,</span> instance<span class="token punctuation">,</span> match<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">// 数组降维，并且判断是否需要翻转数组</span>
  <span class="token comment">// 因为某些钩子函数需要从子执行到父</span>
  <span class="token keyword">return</span> <span class="token function">flatten</span><span class="token punctuation">(</span>reverse <span class="token operator">?</span> guards<span class="token punctuation">.</span><span class="token function">reverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> guards<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">flatMapComponents</span><span class="token punctuation">(</span>
  <span class="token parameter">matched<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>RouteRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  fn<span class="token punctuation">:</span> Function</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span> Array<span class="token operator">&lt;</span><span class="token operator">?</span>Function<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 数组降维</span>
  <span class="token keyword">return</span> <span class="token function">flatten</span><span class="token punctuation">(</span>
    matched<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">m</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 将组件中的对象传入回调函数中，获得钩子函数数组</span>
      <span class="token keyword">return</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>components<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=&gt;</span>
        <span class="token function">fn</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>components<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span> m<span class="token punctuation">.</span>instances<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span> m<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><p>第二步执行全局 beforeEach 钩子函数</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">beforeEach</span><span class="token punctuation">(</span>fn<span class="token punctuation">:</span> Function<span class="token punctuation">)</span><span class="token punctuation">:</span> Function <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">registerHook</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>beforeHooks<span class="token punctuation">,</span> fn<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">registerHook</span><span class="token punctuation">(</span><span class="token parameter">list<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span><span class="token punctuation">,</span> fn<span class="token punctuation">:</span> Function</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Function <span class="token punctuation">{</span>
  list<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> i <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> list<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>在 VueRouter 类中有以上代码，每当给 VueRouter 实例添加 beforeEach 函数时就会将函数 push 进 beforeHooks 中。</p> <p>第三步执行 <code>beforeRouteUpdate</code> 钩子函数，调用方式和第一步相同，只是传入的函数名不同，在该函数中可以访问到 this 对象。</p> <p>第四步执行 <code>beforeEnter</code> 钩子函数，该函数是路由独享的钩子函数。</p> <p>第五步是解析异步组件。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">resolveAsyncComponents</span><span class="token punctuation">(</span><span class="token parameter">matched<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>RouteRecord<span class="token operator">&gt;</span></span><span class="token punctuation">)</span><span class="token punctuation">:</span> Function <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token parameter">to<span class="token punctuation">,</span> <span class="token keyword">from</span><span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> hasAsync <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token keyword">let</span> pending <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">let</span> error <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token comment">// 该函数作用之前已经介绍过了</span>
    <span class="token function">flatMapComponents</span><span class="token punctuation">(</span>matched<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">def<span class="token punctuation">,</span> _<span class="token punctuation">,</span> match<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 判断是否是异步组件</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> def <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">&amp;&amp;</span> def<span class="token punctuation">.</span>cid <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        hasAsync <span class="token operator">=</span> <span class="token boolean">true</span>
        pending<span class="token operator">++</span>
        <span class="token comment">// 成功回调</span>
        <span class="token comment">// once 函数确保异步组件只加载一次</span>
        <span class="token keyword">const</span> resolve <span class="token operator">=</span> <span class="token function">once</span><span class="token punctuation">(</span><span class="token parameter">resolvedDef</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isESModule</span><span class="token punctuation">(</span>resolvedDef<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            resolvedDef <span class="token operator">=</span> resolvedDef<span class="token punctuation">.</span>default
          <span class="token punctuation">}</span>
          <span class="token comment">// 判断是否是构造函数</span>
          <span class="token comment">// 不是的话通过 Vue 来生成组件构造函数</span>
          def<span class="token punctuation">.</span>resolved <span class="token operator">=</span>
            <span class="token keyword">typeof</span> resolvedDef <span class="token operator">===</span> <span class="token string">'function'</span>
              <span class="token operator">?</span> resolvedDef
              <span class="token punctuation">:</span> _Vue<span class="token punctuation">.</span><span class="token function">extend</span><span class="token punctuation">(</span>resolvedDef<span class="token punctuation">)</span>
          <span class="token comment">// 赋值组件</span>
          <span class="token comment">// 如果组件全部解析完毕，继续下一步</span>
          match<span class="token punctuation">.</span>components<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> resolvedDef
          pending<span class="token operator">--</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>pending <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token comment">// 失败回调</span>
        <span class="token keyword">const</span> reject <span class="token operator">=</span> <span class="token function">once</span><span class="token punctuation">(</span><span class="token parameter">reason</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> msg <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Failed to resolve async component </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>reason<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
          process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> <span class="token function">warn</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> msg<span class="token punctuation">)</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            error <span class="token operator">=</span> <span class="token function">isError</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span> <span class="token operator">?</span> reason <span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
            <span class="token function">next</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">let</span> res
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
          <span class="token comment">// 执行异步组件函数</span>
          res <span class="token operator">=</span> <span class="token function">def</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 下载完成执行回调</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> res<span class="token punctuation">.</span>then <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            res<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> comp <span class="token operator">=</span> res<span class="token punctuation">.</span>component
            <span class="token keyword">if</span> <span class="token punctuation">(</span>comp <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> comp<span class="token punctuation">.</span>then <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              comp<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">// 不是异步组件直接下一步</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hasAsync<span class="token punctuation">)</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br></div></div><p>以上就是第一个 <code>runQueue</code> 中的逻辑，第五步完成后会执行第一个 <code>runQueue</code> 中回调函数</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 该回调用于保存 `beforeRouteEnter` 钩子中的回调函数</span>
<span class="token keyword">const</span> postEnterCbs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">const</span> <span class="token function-variable function">isValid</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>current <span class="token operator">===</span> route
<span class="token comment">// beforeRouteEnter 导航守卫钩子</span>
<span class="token keyword">const</span> enterGuards <span class="token operator">=</span> <span class="token function">extractEnterGuards</span><span class="token punctuation">(</span>activated<span class="token punctuation">,</span> postEnterCbs<span class="token punctuation">,</span> isValid<span class="token punctuation">)</span>
<span class="token comment">// beforeResolve 导航守卫钩子</span>
<span class="token keyword">const</span> queue <span class="token operator">=</span> enterGuards<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">.</span>resolveHooks<span class="token punctuation">)</span>
<span class="token function">runQueue</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> iterator<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>pending <span class="token operator">!==</span> route<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>pending <span class="token operator">=</span> <span class="token keyword">null</span>
  <span class="token comment">// 这里会执行 afterEach 导航守卫钩子</span>
  <span class="token function">onComplete</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">.</span>app<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">.</span>app<span class="token punctuation">.</span><span class="token function">$nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      postEnterCbs<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">cb</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>第六步是执行 <code>beforeRouteEnter</code> 导航守卫钩子，<code>beforeRouteEnter</code> 钩子不能访问 <code>this</code> 对象，因为钩子在导航确认前被调用，需要渲染的组件还没被创建。但是该钩子函数是唯一一个支持在回调中获取 <code>this</code> 对象的函数，回调会在路由确认执行。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">beforeRouteEnter</span> <span class="token punctuation">(</span><span class="token parameter">to<span class="token punctuation">,</span> <span class="token keyword">from</span><span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token parameter">vm</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 通过 `vm` 访问组件实例</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>下面来看看是如何支持在回调中拿到 <code>this</code> 对象的</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">extractEnterGuards</span><span class="token punctuation">(</span>
  activated<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>RouteRecord<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  cbs<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>Function<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  <span class="token function-variable function">isValid</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> boolean
<span class="token punctuation">)</span><span class="token punctuation">:</span> Array<span class="token operator">&lt;</span><span class="token operator">?</span>Function<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 这里和之前调用导航守卫基本一致</span>
  <span class="token keyword">return</span> <span class="token function">extractGuards</span><span class="token punctuation">(</span>
    activated<span class="token punctuation">,</span>
    <span class="token string">'beforeRouteEnter'</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token parameter">guard<span class="token punctuation">,</span> _<span class="token punctuation">,</span> match<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">bindEnterGuard</span><span class="token punctuation">(</span>guard<span class="token punctuation">,</span> match<span class="token punctuation">,</span> key<span class="token punctuation">,</span> cbs<span class="token punctuation">,</span> isValid<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">bindEnterGuard</span><span class="token punctuation">(</span>
  guard<span class="token punctuation">:</span> NavigationGuard<span class="token punctuation">,</span>
  match<span class="token punctuation">:</span> RouteRecord<span class="token punctuation">,</span>
  key<span class="token punctuation">:</span> string<span class="token punctuation">,</span>
  cbs<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>Function<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  <span class="token function-variable function">isValid</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> boolean
<span class="token punctuation">)</span><span class="token punctuation">:</span> NavigationGuard <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">routeEnterGuard</span><span class="token punctuation">(</span><span class="token parameter">to<span class="token punctuation">,</span> <span class="token keyword">from</span><span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">guard</span><span class="token punctuation">(</span>to<span class="token punctuation">,</span> <span class="token keyword">from</span><span class="token punctuation">,</span> <span class="token parameter">cb</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 判断 cb 是否是函数</span>
      <span class="token comment">// 是的话就 push 进 postEnterCbs</span>
      <span class="token function">next</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> cb <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        cbs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token comment">// 循环直到拿到组件实例</span>
          <span class="token function">poll</span><span class="token punctuation">(</span>cb<span class="token punctuation">,</span> match<span class="token punctuation">.</span>instances<span class="token punctuation">,</span> key<span class="token punctuation">,</span> isValid<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 该函数是为了解决 issus ##750</span>
<span class="token comment">// 当 router-view 外面包裹了 mode 为 out-in 的 transition 组件</span>
<span class="token comment">// 会在组件初次导航到时获得不到组件实例对象</span>
<span class="token keyword">function</span> <span class="token function">poll</span><span class="token punctuation">(</span>
  cb<span class="token punctuation">:</span> any<span class="token punctuation">,</span> <span class="token comment">// somehow flow cannot infer this is a function</span>
  instances<span class="token punctuation">:</span> Object<span class="token punctuation">,</span>
  key<span class="token punctuation">:</span> string<span class="token punctuation">,</span>
  <span class="token function-variable function">isValid</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> boolean
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    instances<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span>
    <span class="token operator">!</span>instances<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span>_isBeingDestroyed <span class="token comment">// do not reuse being destroyed instance</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">cb</span><span class="token punctuation">(</span>instances<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// setTimeout 16ms 作用和 nextTick 基本相同</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">poll</span><span class="token punctuation">(</span>cb<span class="token punctuation">,</span> instances<span class="token punctuation">,</span> key<span class="token punctuation">,</span> isValid<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br></div></div><p>第七步是执行 <code>beforeResolve</code> 导航守卫钩子，如果注册了全局 <code>beforeResolve</code> 钩子就会在这里执行。</p> <p>第八步就是导航确认，调用 <code>afterEach</code> 导航守卫钩子了。</p> <p>以上都执行完成后，会触发组件的渲染</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>history<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token parameter">route</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>apps<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    app<span class="token punctuation">.</span>_route <span class="token operator">=</span> route
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>以上回调会在 <code>updateRoute</code> 中调用</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">updateRoute</span><span class="token punctuation">(</span><span class="token parameter">route<span class="token punctuation">:</span> Route</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> prev <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>current
    <span class="token keyword">this</span><span class="token punctuation">.</span>current <span class="token operator">=</span> route
    <span class="token keyword">this</span><span class="token punctuation">.</span>cb <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">cb</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">.</span>afterHooks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">hook</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      hook <span class="token operator">&amp;&amp;</span> <span class="token function">hook</span><span class="token punctuation">(</span>route<span class="token punctuation">,</span> prev<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>至此，路由跳转已经全部分析完毕。核心就是判断需要跳转的路由是否存在于记录中，然后执行各种导航守卫函数，最后完成 URL 的改变和组件的渲染。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/prepare/vue/Vue源码分析/09-基于proxy的简易版vue.html" class="prev">09-基于proxy的简易版vue</a></span> <span class="next"><a href="/prepare/vue/Vue源码分析/11-Vuex源码深度解析.html">11-Vuex源码深度解析</a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/prepare/assets/js/app.26f016bf.js" defer></script><script src="/prepare/assets/js/2.df88221a.js" defer></script><script src="/prepare/assets/js/620.b428f155.js" defer></script>
  </body>
</html>
