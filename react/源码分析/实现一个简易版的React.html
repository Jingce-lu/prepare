<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>React 源码分析，实现一个简易版的React | Lu notes</title>
    <meta name="description" content=" ">
    <link rel=" " href=" ">
    
    <link rel="preload" href="/prepare/assets/css/0.styles.49d0346a.css" as="style"><link rel="preload" href="/prepare/assets/js/app.63a9d18c.js" as="script"><link rel="preload" href="/prepare/assets/js/2.df88221a.js" as="script"><link rel="preload" href="/prepare/assets/js/596.48e4bef1.js" as="script"><link rel="prefetch" href="/prepare/assets/js/10.83c986e7.js"><link rel="prefetch" href="/prepare/assets/js/100.14f64daa.js"><link rel="prefetch" href="/prepare/assets/js/101.08c816ba.js"><link rel="prefetch" href="/prepare/assets/js/102.75954b8d.js"><link rel="prefetch" href="/prepare/assets/js/103.f07a1a73.js"><link rel="prefetch" href="/prepare/assets/js/104.38a0a2db.js"><link rel="prefetch" href="/prepare/assets/js/105.1165f8d4.js"><link rel="prefetch" href="/prepare/assets/js/106.bd44a1cb.js"><link rel="prefetch" href="/prepare/assets/js/107.648515e5.js"><link rel="prefetch" href="/prepare/assets/js/108.c89e3d00.js"><link rel="prefetch" href="/prepare/assets/js/109.807ec5a8.js"><link rel="prefetch" href="/prepare/assets/js/11.c8f79ff1.js"><link rel="prefetch" href="/prepare/assets/js/110.f32f0344.js"><link rel="prefetch" href="/prepare/assets/js/111.559a1a9b.js"><link rel="prefetch" href="/prepare/assets/js/112.f58bd8e9.js"><link rel="prefetch" href="/prepare/assets/js/113.aace951e.js"><link rel="prefetch" href="/prepare/assets/js/114.87472f0b.js"><link rel="prefetch" href="/prepare/assets/js/115.ca09de7b.js"><link rel="prefetch" href="/prepare/assets/js/116.04b7cbb7.js"><link rel="prefetch" href="/prepare/assets/js/117.a997b001.js"><link rel="prefetch" href="/prepare/assets/js/118.929eba63.js"><link rel="prefetch" href="/prepare/assets/js/119.678ae8a7.js"><link rel="prefetch" href="/prepare/assets/js/12.b330362f.js"><link rel="prefetch" href="/prepare/assets/js/120.d74c0340.js"><link rel="prefetch" href="/prepare/assets/js/121.681bda87.js"><link rel="prefetch" href="/prepare/assets/js/122.e9c1ac50.js"><link rel="prefetch" href="/prepare/assets/js/123.6b8eced2.js"><link rel="prefetch" href="/prepare/assets/js/124.828a6255.js"><link rel="prefetch" href="/prepare/assets/js/125.9014d997.js"><link rel="prefetch" href="/prepare/assets/js/126.69f28474.js"><link rel="prefetch" href="/prepare/assets/js/127.8b28030f.js"><link rel="prefetch" href="/prepare/assets/js/128.b641adb5.js"><link rel="prefetch" href="/prepare/assets/js/129.ccaed8f4.js"><link rel="prefetch" href="/prepare/assets/js/13.1278de07.js"><link rel="prefetch" href="/prepare/assets/js/130.bd8064e4.js"><link rel="prefetch" href="/prepare/assets/js/131.d50daaf0.js"><link rel="prefetch" href="/prepare/assets/js/132.563c3581.js"><link rel="prefetch" href="/prepare/assets/js/133.71e89464.js"><link rel="prefetch" href="/prepare/assets/js/134.41086874.js"><link rel="prefetch" href="/prepare/assets/js/135.b6bf0048.js"><link rel="prefetch" href="/prepare/assets/js/136.d3d5d8a3.js"><link rel="prefetch" href="/prepare/assets/js/137.0fdfd912.js"><link rel="prefetch" href="/prepare/assets/js/138.fd0001bf.js"><link rel="prefetch" href="/prepare/assets/js/139.cc6ec2ba.js"><link rel="prefetch" href="/prepare/assets/js/14.af778cca.js"><link rel="prefetch" href="/prepare/assets/js/140.da4d531b.js"><link rel="prefetch" href="/prepare/assets/js/141.fb33316b.js"><link rel="prefetch" href="/prepare/assets/js/142.cf9ce088.js"><link rel="prefetch" href="/prepare/assets/js/143.7ec19b9d.js"><link rel="prefetch" href="/prepare/assets/js/144.8fe78fad.js"><link rel="prefetch" href="/prepare/assets/js/145.95fbff34.js"><link rel="prefetch" href="/prepare/assets/js/146.89a9f5f4.js"><link rel="prefetch" href="/prepare/assets/js/147.8eed692b.js"><link rel="prefetch" href="/prepare/assets/js/148.30ec0b02.js"><link rel="prefetch" href="/prepare/assets/js/149.1c016ae1.js"><link rel="prefetch" href="/prepare/assets/js/15.cac92205.js"><link rel="prefetch" href="/prepare/assets/js/150.f8de09e6.js"><link rel="prefetch" href="/prepare/assets/js/151.02f8a81b.js"><link rel="prefetch" href="/prepare/assets/js/152.3f20ad47.js"><link rel="prefetch" href="/prepare/assets/js/153.7de1519a.js"><link rel="prefetch" href="/prepare/assets/js/154.77b911cc.js"><link rel="prefetch" href="/prepare/assets/js/155.298715e7.js"><link rel="prefetch" href="/prepare/assets/js/156.e4686166.js"><link rel="prefetch" href="/prepare/assets/js/157.4181d3b5.js"><link rel="prefetch" href="/prepare/assets/js/158.db2f8c04.js"><link rel="prefetch" href="/prepare/assets/js/159.14255a33.js"><link rel="prefetch" href="/prepare/assets/js/16.2b619d53.js"><link rel="prefetch" href="/prepare/assets/js/160.65d8926d.js"><link rel="prefetch" href="/prepare/assets/js/161.b2223e92.js"><link rel="prefetch" href="/prepare/assets/js/162.b1ff5f45.js"><link rel="prefetch" href="/prepare/assets/js/163.5dba0ea0.js"><link rel="prefetch" href="/prepare/assets/js/164.e096cb52.js"><link rel="prefetch" href="/prepare/assets/js/165.7cd8f1ba.js"><link rel="prefetch" href="/prepare/assets/js/166.d877586c.js"><link rel="prefetch" href="/prepare/assets/js/167.d28450cb.js"><link rel="prefetch" href="/prepare/assets/js/168.eb091bc1.js"><link rel="prefetch" href="/prepare/assets/js/169.a26dd498.js"><link rel="prefetch" href="/prepare/assets/js/17.c5c7986d.js"><link rel="prefetch" href="/prepare/assets/js/170.665ba0a3.js"><link rel="prefetch" href="/prepare/assets/js/171.fd192fbf.js"><link rel="prefetch" href="/prepare/assets/js/172.f727ac0a.js"><link rel="prefetch" href="/prepare/assets/js/173.ef653624.js"><link rel="prefetch" href="/prepare/assets/js/174.28a582ff.js"><link rel="prefetch" href="/prepare/assets/js/175.b2b2de9b.js"><link rel="prefetch" href="/prepare/assets/js/176.969a50d4.js"><link rel="prefetch" href="/prepare/assets/js/177.8e748403.js"><link rel="prefetch" href="/prepare/assets/js/178.a2b1a493.js"><link rel="prefetch" href="/prepare/assets/js/179.0cc507d4.js"><link rel="prefetch" href="/prepare/assets/js/18.f1e9f997.js"><link rel="prefetch" href="/prepare/assets/js/180.176717f1.js"><link rel="prefetch" href="/prepare/assets/js/181.cfe7eeb5.js"><link rel="prefetch" href="/prepare/assets/js/182.6fe8ae66.js"><link rel="prefetch" href="/prepare/assets/js/183.4180a2f0.js"><link rel="prefetch" href="/prepare/assets/js/184.6ef96f6b.js"><link rel="prefetch" href="/prepare/assets/js/185.dd1e7436.js"><link rel="prefetch" href="/prepare/assets/js/186.efbff27c.js"><link rel="prefetch" href="/prepare/assets/js/187.9d60c24e.js"><link rel="prefetch" href="/prepare/assets/js/188.f2ee4a7a.js"><link rel="prefetch" href="/prepare/assets/js/189.b058ec91.js"><link rel="prefetch" href="/prepare/assets/js/19.5fad194b.js"><link rel="prefetch" href="/prepare/assets/js/190.0c7927e5.js"><link rel="prefetch" href="/prepare/assets/js/191.94cb2cc5.js"><link rel="prefetch" href="/prepare/assets/js/192.db0b5eb7.js"><link rel="prefetch" href="/prepare/assets/js/193.a7c05a54.js"><link rel="prefetch" href="/prepare/assets/js/194.a77541bf.js"><link rel="prefetch" href="/prepare/assets/js/195.a75c0cd4.js"><link rel="prefetch" href="/prepare/assets/js/196.482786d8.js"><link rel="prefetch" href="/prepare/assets/js/197.2ff27d5b.js"><link rel="prefetch" href="/prepare/assets/js/198.a63f521e.js"><link rel="prefetch" href="/prepare/assets/js/199.71fdc965.js"><link rel="prefetch" href="/prepare/assets/js/20.b634e488.js"><link rel="prefetch" href="/prepare/assets/js/200.b678406b.js"><link rel="prefetch" href="/prepare/assets/js/201.25c444fb.js"><link rel="prefetch" href="/prepare/assets/js/202.e20e51cd.js"><link rel="prefetch" href="/prepare/assets/js/203.069234ae.js"><link rel="prefetch" href="/prepare/assets/js/204.ea2cdf60.js"><link rel="prefetch" href="/prepare/assets/js/205.af025d46.js"><link rel="prefetch" href="/prepare/assets/js/206.f35569f4.js"><link rel="prefetch" href="/prepare/assets/js/207.fecddfea.js"><link rel="prefetch" href="/prepare/assets/js/208.bfde3fb2.js"><link rel="prefetch" href="/prepare/assets/js/209.a9f11b8d.js"><link rel="prefetch" href="/prepare/assets/js/21.f064f2c6.js"><link rel="prefetch" href="/prepare/assets/js/210.93fad9f4.js"><link rel="prefetch" href="/prepare/assets/js/211.19a96c05.js"><link rel="prefetch" href="/prepare/assets/js/212.3d6583b5.js"><link rel="prefetch" href="/prepare/assets/js/213.15677803.js"><link rel="prefetch" href="/prepare/assets/js/214.afcb6713.js"><link rel="prefetch" href="/prepare/assets/js/215.d3e9b4e5.js"><link rel="prefetch" href="/prepare/assets/js/216.67bbc6f5.js"><link rel="prefetch" href="/prepare/assets/js/217.3f8e12cd.js"><link rel="prefetch" href="/prepare/assets/js/218.77c1f826.js"><link rel="prefetch" href="/prepare/assets/js/219.bc984ac3.js"><link rel="prefetch" href="/prepare/assets/js/22.c9fbe411.js"><link rel="prefetch" href="/prepare/assets/js/220.99f418df.js"><link rel="prefetch" href="/prepare/assets/js/221.71376b39.js"><link rel="prefetch" href="/prepare/assets/js/222.b884a97e.js"><link rel="prefetch" href="/prepare/assets/js/223.e9bb5415.js"><link rel="prefetch" href="/prepare/assets/js/224.587ea252.js"><link rel="prefetch" href="/prepare/assets/js/225.e49c9db9.js"><link rel="prefetch" href="/prepare/assets/js/226.e84426f7.js"><link rel="prefetch" href="/prepare/assets/js/227.f3b2bbd6.js"><link rel="prefetch" href="/prepare/assets/js/228.b4628504.js"><link rel="prefetch" href="/prepare/assets/js/229.ce76c246.js"><link rel="prefetch" href="/prepare/assets/js/23.76d84253.js"><link rel="prefetch" href="/prepare/assets/js/230.dfddbd45.js"><link rel="prefetch" href="/prepare/assets/js/231.23d2684a.js"><link rel="prefetch" href="/prepare/assets/js/232.15f95d7f.js"><link rel="prefetch" href="/prepare/assets/js/233.672e2713.js"><link rel="prefetch" href="/prepare/assets/js/234.5fa7e6b1.js"><link rel="prefetch" href="/prepare/assets/js/235.a7445e06.js"><link rel="prefetch" href="/prepare/assets/js/236.ec80c971.js"><link rel="prefetch" href="/prepare/assets/js/237.0bdc0e06.js"><link rel="prefetch" href="/prepare/assets/js/238.14d87b19.js"><link rel="prefetch" href="/prepare/assets/js/239.5d06d632.js"><link rel="prefetch" href="/prepare/assets/js/24.91073e02.js"><link rel="prefetch" href="/prepare/assets/js/240.fd208ded.js"><link rel="prefetch" href="/prepare/assets/js/241.268105bd.js"><link rel="prefetch" href="/prepare/assets/js/242.b8d79ae9.js"><link rel="prefetch" href="/prepare/assets/js/243.53916b2e.js"><link rel="prefetch" href="/prepare/assets/js/244.43fda1aa.js"><link rel="prefetch" href="/prepare/assets/js/245.034b7571.js"><link rel="prefetch" href="/prepare/assets/js/246.927ed92c.js"><link rel="prefetch" href="/prepare/assets/js/247.581d19cc.js"><link rel="prefetch" href="/prepare/assets/js/248.160e1892.js"><link rel="prefetch" href="/prepare/assets/js/249.cbf670e4.js"><link rel="prefetch" href="/prepare/assets/js/25.64f6c154.js"><link rel="prefetch" href="/prepare/assets/js/250.33f52e4b.js"><link rel="prefetch" href="/prepare/assets/js/251.ed0ea5ae.js"><link rel="prefetch" href="/prepare/assets/js/252.8050ec8c.js"><link rel="prefetch" href="/prepare/assets/js/253.2d061fd1.js"><link rel="prefetch" href="/prepare/assets/js/254.6a30bbdb.js"><link rel="prefetch" href="/prepare/assets/js/255.ad2abfc5.js"><link rel="prefetch" href="/prepare/assets/js/256.0910a605.js"><link rel="prefetch" href="/prepare/assets/js/257.76706674.js"><link rel="prefetch" href="/prepare/assets/js/258.f29fb9b5.js"><link rel="prefetch" href="/prepare/assets/js/259.9040aa68.js"><link rel="prefetch" href="/prepare/assets/js/26.8cedf695.js"><link rel="prefetch" href="/prepare/assets/js/260.8238de2a.js"><link rel="prefetch" href="/prepare/assets/js/261.c06ab0ac.js"><link rel="prefetch" href="/prepare/assets/js/262.13c09bcc.js"><link rel="prefetch" href="/prepare/assets/js/263.11616bf7.js"><link rel="prefetch" href="/prepare/assets/js/264.5fc71a79.js"><link rel="prefetch" href="/prepare/assets/js/265.b5954e89.js"><link rel="prefetch" href="/prepare/assets/js/266.e8edaf22.js"><link rel="prefetch" href="/prepare/assets/js/267.654dc240.js"><link rel="prefetch" href="/prepare/assets/js/268.b273294b.js"><link rel="prefetch" href="/prepare/assets/js/269.ac15d21c.js"><link rel="prefetch" href="/prepare/assets/js/27.35031a05.js"><link rel="prefetch" href="/prepare/assets/js/270.180941a2.js"><link rel="prefetch" href="/prepare/assets/js/271.5282c9b9.js"><link rel="prefetch" href="/prepare/assets/js/272.1d6593e1.js"><link rel="prefetch" href="/prepare/assets/js/273.8f68666f.js"><link rel="prefetch" href="/prepare/assets/js/274.fcedbdd8.js"><link rel="prefetch" href="/prepare/assets/js/275.b1ca2c7d.js"><link rel="prefetch" href="/prepare/assets/js/276.ddf4fcc8.js"><link rel="prefetch" href="/prepare/assets/js/277.91d15df0.js"><link rel="prefetch" href="/prepare/assets/js/278.b321fb63.js"><link rel="prefetch" href="/prepare/assets/js/279.b8598048.js"><link rel="prefetch" href="/prepare/assets/js/28.a4d31af6.js"><link rel="prefetch" href="/prepare/assets/js/280.9b711778.js"><link rel="prefetch" href="/prepare/assets/js/281.18d50e6b.js"><link rel="prefetch" href="/prepare/assets/js/282.33139e4b.js"><link rel="prefetch" href="/prepare/assets/js/283.8939bd5d.js"><link rel="prefetch" href="/prepare/assets/js/284.dc4cb497.js"><link rel="prefetch" href="/prepare/assets/js/285.e95fd8e1.js"><link rel="prefetch" href="/prepare/assets/js/286.623f81e0.js"><link rel="prefetch" href="/prepare/assets/js/287.354a503a.js"><link rel="prefetch" href="/prepare/assets/js/288.3c4a176d.js"><link rel="prefetch" href="/prepare/assets/js/289.497923b3.js"><link rel="prefetch" href="/prepare/assets/js/29.4af0c594.js"><link rel="prefetch" href="/prepare/assets/js/290.202ee27b.js"><link rel="prefetch" href="/prepare/assets/js/291.6e42e502.js"><link rel="prefetch" href="/prepare/assets/js/292.e4bda953.js"><link rel="prefetch" href="/prepare/assets/js/293.5e65c538.js"><link rel="prefetch" href="/prepare/assets/js/294.64d09376.js"><link rel="prefetch" href="/prepare/assets/js/295.b640329c.js"><link rel="prefetch" href="/prepare/assets/js/296.d3c76e7a.js"><link rel="prefetch" href="/prepare/assets/js/297.32925526.js"><link rel="prefetch" href="/prepare/assets/js/298.1a7652df.js"><link rel="prefetch" href="/prepare/assets/js/299.6c1fee96.js"><link rel="prefetch" href="/prepare/assets/js/3.08575337.js"><link rel="prefetch" href="/prepare/assets/js/30.f6c22495.js"><link rel="prefetch" href="/prepare/assets/js/300.50344b34.js"><link rel="prefetch" href="/prepare/assets/js/301.b55c3676.js"><link rel="prefetch" href="/prepare/assets/js/302.4bf62c44.js"><link rel="prefetch" href="/prepare/assets/js/303.3a5d6e71.js"><link rel="prefetch" href="/prepare/assets/js/304.5df8c3de.js"><link rel="prefetch" href="/prepare/assets/js/305.bada65d3.js"><link rel="prefetch" href="/prepare/assets/js/306.32e9af36.js"><link rel="prefetch" href="/prepare/assets/js/307.ddf504cf.js"><link rel="prefetch" href="/prepare/assets/js/308.742107bd.js"><link rel="prefetch" href="/prepare/assets/js/309.2f908a61.js"><link rel="prefetch" href="/prepare/assets/js/31.134e90e4.js"><link rel="prefetch" href="/prepare/assets/js/310.8a940cbb.js"><link rel="prefetch" href="/prepare/assets/js/311.f5148f40.js"><link rel="prefetch" href="/prepare/assets/js/312.9264ef3e.js"><link rel="prefetch" href="/prepare/assets/js/313.ffd14aab.js"><link rel="prefetch" href="/prepare/assets/js/314.49423aaf.js"><link rel="prefetch" href="/prepare/assets/js/315.d457f083.js"><link rel="prefetch" href="/prepare/assets/js/316.05e007d3.js"><link rel="prefetch" href="/prepare/assets/js/317.53fe3d4e.js"><link rel="prefetch" href="/prepare/assets/js/318.9339ed71.js"><link rel="prefetch" href="/prepare/assets/js/319.34cf4263.js"><link rel="prefetch" href="/prepare/assets/js/32.e9a6b791.js"><link rel="prefetch" href="/prepare/assets/js/320.5a7672f5.js"><link rel="prefetch" href="/prepare/assets/js/321.06ffbbd4.js"><link rel="prefetch" href="/prepare/assets/js/322.d5c84c45.js"><link rel="prefetch" href="/prepare/assets/js/323.371aa6aa.js"><link rel="prefetch" href="/prepare/assets/js/324.a9c4ec6d.js"><link rel="prefetch" href="/prepare/assets/js/325.3aac2b89.js"><link rel="prefetch" href="/prepare/assets/js/326.d2f6d858.js"><link rel="prefetch" href="/prepare/assets/js/327.342b87ca.js"><link rel="prefetch" href="/prepare/assets/js/328.1bda3615.js"><link rel="prefetch" href="/prepare/assets/js/329.67b18f06.js"><link rel="prefetch" href="/prepare/assets/js/33.8b822516.js"><link rel="prefetch" href="/prepare/assets/js/330.ab2b970b.js"><link rel="prefetch" href="/prepare/assets/js/331.80066dcb.js"><link rel="prefetch" href="/prepare/assets/js/332.6640aed2.js"><link rel="prefetch" href="/prepare/assets/js/333.6e80ae70.js"><link rel="prefetch" href="/prepare/assets/js/334.c0cf7881.js"><link rel="prefetch" href="/prepare/assets/js/335.4a7f7b77.js"><link rel="prefetch" href="/prepare/assets/js/336.a8123a09.js"><link rel="prefetch" href="/prepare/assets/js/337.09fb830d.js"><link rel="prefetch" href="/prepare/assets/js/338.84e28e0c.js"><link rel="prefetch" href="/prepare/assets/js/339.50f7ad5b.js"><link rel="prefetch" href="/prepare/assets/js/34.3c0efde9.js"><link rel="prefetch" href="/prepare/assets/js/340.02597427.js"><link rel="prefetch" href="/prepare/assets/js/341.9f057c12.js"><link rel="prefetch" href="/prepare/assets/js/342.eaf98ad1.js"><link rel="prefetch" href="/prepare/assets/js/343.ae0570b5.js"><link rel="prefetch" href="/prepare/assets/js/344.f742ed78.js"><link rel="prefetch" href="/prepare/assets/js/345.f0118e85.js"><link rel="prefetch" href="/prepare/assets/js/346.12411e81.js"><link rel="prefetch" href="/prepare/assets/js/347.c35a6a97.js"><link rel="prefetch" href="/prepare/assets/js/348.ed41af85.js"><link rel="prefetch" href="/prepare/assets/js/349.c4e14c7a.js"><link rel="prefetch" href="/prepare/assets/js/35.3f918e70.js"><link rel="prefetch" href="/prepare/assets/js/350.7cbfb86d.js"><link rel="prefetch" href="/prepare/assets/js/351.62c71611.js"><link rel="prefetch" href="/prepare/assets/js/352.683cf657.js"><link rel="prefetch" href="/prepare/assets/js/353.defd0c5f.js"><link rel="prefetch" href="/prepare/assets/js/354.3e42ed4a.js"><link rel="prefetch" href="/prepare/assets/js/355.1b1cac2a.js"><link rel="prefetch" href="/prepare/assets/js/356.f8204767.js"><link rel="prefetch" href="/prepare/assets/js/357.cbae51d8.js"><link rel="prefetch" href="/prepare/assets/js/358.d75756a9.js"><link rel="prefetch" href="/prepare/assets/js/359.a396644c.js"><link rel="prefetch" href="/prepare/assets/js/36.7b540d91.js"><link rel="prefetch" href="/prepare/assets/js/360.fdb62b65.js"><link rel="prefetch" href="/prepare/assets/js/361.3bdbd303.js"><link rel="prefetch" href="/prepare/assets/js/362.b349cde5.js"><link rel="prefetch" href="/prepare/assets/js/363.4d6edb22.js"><link rel="prefetch" href="/prepare/assets/js/364.9b9df865.js"><link rel="prefetch" href="/prepare/assets/js/365.f9cba890.js"><link rel="prefetch" href="/prepare/assets/js/366.e8f1febf.js"><link rel="prefetch" href="/prepare/assets/js/367.eb2aca2f.js"><link rel="prefetch" href="/prepare/assets/js/368.814e52fc.js"><link rel="prefetch" href="/prepare/assets/js/369.d78ce369.js"><link rel="prefetch" href="/prepare/assets/js/37.1a7e194a.js"><link rel="prefetch" href="/prepare/assets/js/370.319f7045.js"><link rel="prefetch" href="/prepare/assets/js/371.b8abee1f.js"><link rel="prefetch" href="/prepare/assets/js/372.964f805d.js"><link rel="prefetch" href="/prepare/assets/js/373.c0b2f99b.js"><link rel="prefetch" href="/prepare/assets/js/374.c249a380.js"><link rel="prefetch" href="/prepare/assets/js/375.ff30ed13.js"><link rel="prefetch" href="/prepare/assets/js/376.bbecb507.js"><link rel="prefetch" href="/prepare/assets/js/377.6a716d77.js"><link rel="prefetch" href="/prepare/assets/js/378.5f8a5cbc.js"><link rel="prefetch" href="/prepare/assets/js/379.c08812d0.js"><link rel="prefetch" href="/prepare/assets/js/38.0549b1ce.js"><link rel="prefetch" href="/prepare/assets/js/380.8d8667b0.js"><link rel="prefetch" href="/prepare/assets/js/381.10208525.js"><link rel="prefetch" href="/prepare/assets/js/382.8b4c0616.js"><link rel="prefetch" href="/prepare/assets/js/383.9d9a9912.js"><link rel="prefetch" href="/prepare/assets/js/384.bafdedf4.js"><link rel="prefetch" href="/prepare/assets/js/385.d33db8a1.js"><link rel="prefetch" href="/prepare/assets/js/386.25b9eead.js"><link rel="prefetch" href="/prepare/assets/js/387.97e0cf46.js"><link rel="prefetch" href="/prepare/assets/js/388.1826ca33.js"><link rel="prefetch" href="/prepare/assets/js/389.f884b6df.js"><link rel="prefetch" href="/prepare/assets/js/39.75f92fc1.js"><link rel="prefetch" href="/prepare/assets/js/390.8aded17d.js"><link rel="prefetch" href="/prepare/assets/js/391.e292b5f5.js"><link rel="prefetch" href="/prepare/assets/js/392.7ae69a2c.js"><link rel="prefetch" href="/prepare/assets/js/393.5d74cbfc.js"><link rel="prefetch" href="/prepare/assets/js/394.b75454b6.js"><link rel="prefetch" href="/prepare/assets/js/395.d66f82e9.js"><link rel="prefetch" href="/prepare/assets/js/396.359e46f5.js"><link rel="prefetch" href="/prepare/assets/js/397.6128a1ce.js"><link rel="prefetch" href="/prepare/assets/js/398.fd4ccef9.js"><link rel="prefetch" href="/prepare/assets/js/399.8df2bd6d.js"><link rel="prefetch" href="/prepare/assets/js/4.9d872f2c.js"><link rel="prefetch" href="/prepare/assets/js/40.80d1fff7.js"><link rel="prefetch" href="/prepare/assets/js/400.9c2e32f3.js"><link rel="prefetch" href="/prepare/assets/js/401.1e7acac7.js"><link rel="prefetch" href="/prepare/assets/js/402.2abe5731.js"><link rel="prefetch" href="/prepare/assets/js/403.472d1758.js"><link rel="prefetch" href="/prepare/assets/js/404.7f65f63c.js"><link rel="prefetch" href="/prepare/assets/js/405.2c7e135a.js"><link rel="prefetch" href="/prepare/assets/js/406.f277eb1e.js"><link rel="prefetch" href="/prepare/assets/js/407.3a58b288.js"><link rel="prefetch" href="/prepare/assets/js/408.7d12812e.js"><link rel="prefetch" href="/prepare/assets/js/409.db0926cd.js"><link rel="prefetch" href="/prepare/assets/js/41.b41373df.js"><link rel="prefetch" href="/prepare/assets/js/410.89c23f36.js"><link rel="prefetch" href="/prepare/assets/js/411.5a39f766.js"><link rel="prefetch" href="/prepare/assets/js/412.8c681c28.js"><link rel="prefetch" href="/prepare/assets/js/413.47e02ab2.js"><link rel="prefetch" href="/prepare/assets/js/414.afe8053b.js"><link rel="prefetch" href="/prepare/assets/js/415.ef038a14.js"><link rel="prefetch" href="/prepare/assets/js/416.7af24260.js"><link rel="prefetch" href="/prepare/assets/js/417.39974bce.js"><link rel="prefetch" href="/prepare/assets/js/418.1dbd2b47.js"><link rel="prefetch" href="/prepare/assets/js/419.57294b07.js"><link rel="prefetch" href="/prepare/assets/js/42.d7536485.js"><link rel="prefetch" href="/prepare/assets/js/420.8aa64b55.js"><link rel="prefetch" href="/prepare/assets/js/421.a03fd549.js"><link rel="prefetch" href="/prepare/assets/js/422.69748975.js"><link rel="prefetch" href="/prepare/assets/js/423.0a594095.js"><link rel="prefetch" href="/prepare/assets/js/424.92391f58.js"><link rel="prefetch" href="/prepare/assets/js/425.48455ae7.js"><link rel="prefetch" href="/prepare/assets/js/426.557d35fb.js"><link rel="prefetch" href="/prepare/assets/js/427.cbd70032.js"><link rel="prefetch" href="/prepare/assets/js/428.cdde7bd5.js"><link rel="prefetch" href="/prepare/assets/js/429.9854b3de.js"><link rel="prefetch" href="/prepare/assets/js/43.a0078c9c.js"><link rel="prefetch" href="/prepare/assets/js/430.a99ba43f.js"><link rel="prefetch" href="/prepare/assets/js/431.4042bce4.js"><link rel="prefetch" href="/prepare/assets/js/432.9f39b228.js"><link rel="prefetch" href="/prepare/assets/js/433.3a3b9165.js"><link rel="prefetch" href="/prepare/assets/js/434.d289f498.js"><link rel="prefetch" href="/prepare/assets/js/435.72c38531.js"><link rel="prefetch" href="/prepare/assets/js/436.11ad9a73.js"><link rel="prefetch" href="/prepare/assets/js/437.23a2629c.js"><link rel="prefetch" href="/prepare/assets/js/438.37d5d445.js"><link rel="prefetch" href="/prepare/assets/js/439.bf1578f9.js"><link rel="prefetch" href="/prepare/assets/js/44.919848cd.js"><link rel="prefetch" href="/prepare/assets/js/440.181cbeac.js"><link rel="prefetch" href="/prepare/assets/js/441.55059001.js"><link rel="prefetch" href="/prepare/assets/js/442.5918cb18.js"><link rel="prefetch" href="/prepare/assets/js/443.c99ec05b.js"><link rel="prefetch" href="/prepare/assets/js/444.ee4e0a96.js"><link rel="prefetch" href="/prepare/assets/js/445.3eaf58ab.js"><link rel="prefetch" href="/prepare/assets/js/446.b3db6caf.js"><link rel="prefetch" href="/prepare/assets/js/447.540737ac.js"><link rel="prefetch" href="/prepare/assets/js/448.4ec3f74e.js"><link rel="prefetch" href="/prepare/assets/js/449.fa19d358.js"><link rel="prefetch" href="/prepare/assets/js/45.91af9a0b.js"><link rel="prefetch" href="/prepare/assets/js/450.11ec0451.js"><link rel="prefetch" href="/prepare/assets/js/451.78c192f4.js"><link rel="prefetch" href="/prepare/assets/js/452.15d0aac9.js"><link rel="prefetch" href="/prepare/assets/js/453.e242c6b2.js"><link rel="prefetch" href="/prepare/assets/js/454.563d0015.js"><link rel="prefetch" href="/prepare/assets/js/455.3a8f809c.js"><link rel="prefetch" href="/prepare/assets/js/456.ed5fb0d4.js"><link rel="prefetch" href="/prepare/assets/js/457.46c5f930.js"><link rel="prefetch" href="/prepare/assets/js/458.f0c40d08.js"><link rel="prefetch" href="/prepare/assets/js/459.f3e38755.js"><link rel="prefetch" href="/prepare/assets/js/46.9aa9eb2f.js"><link rel="prefetch" href="/prepare/assets/js/460.0c80e449.js"><link rel="prefetch" href="/prepare/assets/js/461.1cbbbe69.js"><link rel="prefetch" href="/prepare/assets/js/462.e5750da6.js"><link rel="prefetch" href="/prepare/assets/js/463.4859157e.js"><link rel="prefetch" href="/prepare/assets/js/464.fb3639a4.js"><link rel="prefetch" href="/prepare/assets/js/465.96729c45.js"><link rel="prefetch" href="/prepare/assets/js/466.d22d8d75.js"><link rel="prefetch" href="/prepare/assets/js/467.d3a0e064.js"><link rel="prefetch" href="/prepare/assets/js/468.ab75ceaf.js"><link rel="prefetch" href="/prepare/assets/js/469.f4740b9d.js"><link rel="prefetch" href="/prepare/assets/js/47.874b43a7.js"><link rel="prefetch" href="/prepare/assets/js/470.0436791a.js"><link rel="prefetch" href="/prepare/assets/js/471.1ec37528.js"><link rel="prefetch" href="/prepare/assets/js/472.01e6e54f.js"><link rel="prefetch" href="/prepare/assets/js/473.7c701a6a.js"><link rel="prefetch" href="/prepare/assets/js/474.e11d34ad.js"><link rel="prefetch" href="/prepare/assets/js/475.701a62e8.js"><link rel="prefetch" href="/prepare/assets/js/476.7dd760f1.js"><link rel="prefetch" href="/prepare/assets/js/477.80214169.js"><link rel="prefetch" href="/prepare/assets/js/478.90e6042e.js"><link rel="prefetch" href="/prepare/assets/js/479.ffa4ae60.js"><link rel="prefetch" href="/prepare/assets/js/48.c3cf1ae6.js"><link rel="prefetch" href="/prepare/assets/js/480.6267b344.js"><link rel="prefetch" href="/prepare/assets/js/481.957d50af.js"><link rel="prefetch" href="/prepare/assets/js/482.99eb29ba.js"><link rel="prefetch" href="/prepare/assets/js/483.c8cfb77a.js"><link rel="prefetch" href="/prepare/assets/js/484.9d09232d.js"><link rel="prefetch" href="/prepare/assets/js/485.182f0a4f.js"><link rel="prefetch" href="/prepare/assets/js/486.99ac64fb.js"><link rel="prefetch" href="/prepare/assets/js/487.8027a3e8.js"><link rel="prefetch" href="/prepare/assets/js/488.5cd21d8f.js"><link rel="prefetch" href="/prepare/assets/js/489.1a89144a.js"><link rel="prefetch" href="/prepare/assets/js/49.65f6c32c.js"><link rel="prefetch" href="/prepare/assets/js/490.b7bb3291.js"><link rel="prefetch" href="/prepare/assets/js/491.85ef78d6.js"><link rel="prefetch" href="/prepare/assets/js/492.9c975b1c.js"><link rel="prefetch" href="/prepare/assets/js/493.89f19618.js"><link rel="prefetch" href="/prepare/assets/js/494.10fdb7c1.js"><link rel="prefetch" href="/prepare/assets/js/495.a74f0af8.js"><link rel="prefetch" href="/prepare/assets/js/496.08bb999c.js"><link rel="prefetch" href="/prepare/assets/js/497.4c1f063b.js"><link rel="prefetch" href="/prepare/assets/js/498.ce105c27.js"><link rel="prefetch" href="/prepare/assets/js/499.94af4f19.js"><link rel="prefetch" href="/prepare/assets/js/5.a18ea96b.js"><link rel="prefetch" href="/prepare/assets/js/50.329f5842.js"><link rel="prefetch" href="/prepare/assets/js/500.6c78c3d6.js"><link rel="prefetch" href="/prepare/assets/js/501.8da74052.js"><link rel="prefetch" href="/prepare/assets/js/502.bf792a44.js"><link rel="prefetch" href="/prepare/assets/js/503.d7df363d.js"><link rel="prefetch" href="/prepare/assets/js/504.f5d857a5.js"><link rel="prefetch" href="/prepare/assets/js/505.af6f84d7.js"><link rel="prefetch" href="/prepare/assets/js/506.7791dfba.js"><link rel="prefetch" href="/prepare/assets/js/507.6bf04691.js"><link rel="prefetch" href="/prepare/assets/js/508.2fe1b7b8.js"><link rel="prefetch" href="/prepare/assets/js/509.7c167189.js"><link rel="prefetch" href="/prepare/assets/js/51.62cfb61d.js"><link rel="prefetch" href="/prepare/assets/js/510.590ff9ca.js"><link rel="prefetch" href="/prepare/assets/js/511.59795794.js"><link rel="prefetch" href="/prepare/assets/js/512.3734a948.js"><link rel="prefetch" href="/prepare/assets/js/513.10d00c17.js"><link rel="prefetch" href="/prepare/assets/js/514.4bc1697d.js"><link rel="prefetch" href="/prepare/assets/js/515.36438a73.js"><link rel="prefetch" href="/prepare/assets/js/516.a3653967.js"><link rel="prefetch" href="/prepare/assets/js/517.6b5e5598.js"><link rel="prefetch" href="/prepare/assets/js/518.75bf1000.js"><link rel="prefetch" href="/prepare/assets/js/519.a2586286.js"><link rel="prefetch" href="/prepare/assets/js/52.aaadca0f.js"><link rel="prefetch" href="/prepare/assets/js/520.acefb388.js"><link rel="prefetch" href="/prepare/assets/js/521.71ac3c78.js"><link rel="prefetch" href="/prepare/assets/js/522.b47e969a.js"><link rel="prefetch" href="/prepare/assets/js/523.8439d78d.js"><link rel="prefetch" href="/prepare/assets/js/524.b52ae0c7.js"><link rel="prefetch" href="/prepare/assets/js/525.8dbe9d32.js"><link rel="prefetch" href="/prepare/assets/js/526.9eb99be7.js"><link rel="prefetch" href="/prepare/assets/js/527.a535a8db.js"><link rel="prefetch" href="/prepare/assets/js/528.94b78c6d.js"><link rel="prefetch" href="/prepare/assets/js/529.b46e7d04.js"><link rel="prefetch" href="/prepare/assets/js/53.7cfa8646.js"><link rel="prefetch" href="/prepare/assets/js/530.cc143749.js"><link rel="prefetch" href="/prepare/assets/js/531.b9f7ee42.js"><link rel="prefetch" href="/prepare/assets/js/532.0c86d989.js"><link rel="prefetch" href="/prepare/assets/js/533.10131cea.js"><link rel="prefetch" href="/prepare/assets/js/534.2fdc51cf.js"><link rel="prefetch" href="/prepare/assets/js/535.4a97620f.js"><link rel="prefetch" href="/prepare/assets/js/536.d3ffc0c2.js"><link rel="prefetch" href="/prepare/assets/js/537.85696e3c.js"><link rel="prefetch" href="/prepare/assets/js/538.bad141f0.js"><link rel="prefetch" href="/prepare/assets/js/539.49bed946.js"><link rel="prefetch" href="/prepare/assets/js/54.6a67479b.js"><link rel="prefetch" href="/prepare/assets/js/540.ef780497.js"><link rel="prefetch" href="/prepare/assets/js/541.15f8ec68.js"><link rel="prefetch" href="/prepare/assets/js/542.816570b0.js"><link rel="prefetch" href="/prepare/assets/js/543.f3069666.js"><link rel="prefetch" href="/prepare/assets/js/544.f6d5974e.js"><link rel="prefetch" href="/prepare/assets/js/545.ccc25398.js"><link rel="prefetch" href="/prepare/assets/js/546.f7e50f08.js"><link rel="prefetch" href="/prepare/assets/js/547.69e46b94.js"><link rel="prefetch" href="/prepare/assets/js/548.1295ab71.js"><link rel="prefetch" href="/prepare/assets/js/549.b63705ad.js"><link rel="prefetch" href="/prepare/assets/js/55.dcad84ea.js"><link rel="prefetch" href="/prepare/assets/js/550.967c97af.js"><link rel="prefetch" href="/prepare/assets/js/551.1c846408.js"><link rel="prefetch" href="/prepare/assets/js/552.f984abdc.js"><link rel="prefetch" href="/prepare/assets/js/553.b048d8ab.js"><link rel="prefetch" href="/prepare/assets/js/554.bf66e0b3.js"><link rel="prefetch" href="/prepare/assets/js/555.92d1cdd9.js"><link rel="prefetch" href="/prepare/assets/js/556.78ea9a55.js"><link rel="prefetch" href="/prepare/assets/js/557.7bda9323.js"><link rel="prefetch" href="/prepare/assets/js/558.00813194.js"><link rel="prefetch" href="/prepare/assets/js/559.99ac2528.js"><link rel="prefetch" href="/prepare/assets/js/56.db169fed.js"><link rel="prefetch" href="/prepare/assets/js/560.87f02c3a.js"><link rel="prefetch" href="/prepare/assets/js/561.e8e7e3a3.js"><link rel="prefetch" href="/prepare/assets/js/562.ebfb3885.js"><link rel="prefetch" href="/prepare/assets/js/563.d1b36e84.js"><link rel="prefetch" href="/prepare/assets/js/564.d561615d.js"><link rel="prefetch" href="/prepare/assets/js/565.c9fa01b0.js"><link rel="prefetch" href="/prepare/assets/js/566.fc8051e2.js"><link rel="prefetch" href="/prepare/assets/js/567.ebf5ed87.js"><link rel="prefetch" href="/prepare/assets/js/568.a0a53ebd.js"><link rel="prefetch" href="/prepare/assets/js/569.15c96d4c.js"><link rel="prefetch" href="/prepare/assets/js/57.22e07713.js"><link rel="prefetch" href="/prepare/assets/js/570.40a1be74.js"><link rel="prefetch" href="/prepare/assets/js/571.b7e06836.js"><link rel="prefetch" href="/prepare/assets/js/572.34142637.js"><link rel="prefetch" href="/prepare/assets/js/573.29ed4d8f.js"><link rel="prefetch" href="/prepare/assets/js/574.90144819.js"><link rel="prefetch" href="/prepare/assets/js/575.c560499f.js"><link rel="prefetch" href="/prepare/assets/js/576.7f3b699b.js"><link rel="prefetch" href="/prepare/assets/js/577.e800a731.js"><link rel="prefetch" href="/prepare/assets/js/578.ff5d01c7.js"><link rel="prefetch" href="/prepare/assets/js/579.e92bf2f6.js"><link rel="prefetch" href="/prepare/assets/js/58.0dae4bef.js"><link rel="prefetch" href="/prepare/assets/js/580.86251b1e.js"><link rel="prefetch" href="/prepare/assets/js/581.ce4f6fc7.js"><link rel="prefetch" href="/prepare/assets/js/582.214b2afa.js"><link rel="prefetch" href="/prepare/assets/js/583.6075e5e0.js"><link rel="prefetch" href="/prepare/assets/js/584.786e1432.js"><link rel="prefetch" href="/prepare/assets/js/585.15179d99.js"><link rel="prefetch" href="/prepare/assets/js/586.cc1bc7ea.js"><link rel="prefetch" href="/prepare/assets/js/587.6a7027e8.js"><link rel="prefetch" href="/prepare/assets/js/588.50ee5d1a.js"><link rel="prefetch" href="/prepare/assets/js/589.7073e45d.js"><link rel="prefetch" href="/prepare/assets/js/59.f51e3a1f.js"><link rel="prefetch" href="/prepare/assets/js/590.07914245.js"><link rel="prefetch" href="/prepare/assets/js/591.99a14eac.js"><link rel="prefetch" href="/prepare/assets/js/592.0ef82566.js"><link rel="prefetch" href="/prepare/assets/js/593.ba1f860b.js"><link rel="prefetch" href="/prepare/assets/js/594.83a8f276.js"><link rel="prefetch" href="/prepare/assets/js/595.d5aae99d.js"><link rel="prefetch" href="/prepare/assets/js/597.49d84cbd.js"><link rel="prefetch" href="/prepare/assets/js/598.7df9dbd2.js"><link rel="prefetch" href="/prepare/assets/js/599.e5533ef5.js"><link rel="prefetch" href="/prepare/assets/js/6.9444d72f.js"><link rel="prefetch" href="/prepare/assets/js/60.70695472.js"><link rel="prefetch" href="/prepare/assets/js/600.f3197899.js"><link rel="prefetch" href="/prepare/assets/js/601.a7a13a1c.js"><link rel="prefetch" href="/prepare/assets/js/602.26d20354.js"><link rel="prefetch" href="/prepare/assets/js/603.66c51acf.js"><link rel="prefetch" href="/prepare/assets/js/604.dbafdb70.js"><link rel="prefetch" href="/prepare/assets/js/605.2539497b.js"><link rel="prefetch" href="/prepare/assets/js/606.4746d9fa.js"><link rel="prefetch" href="/prepare/assets/js/607.805b7621.js"><link rel="prefetch" href="/prepare/assets/js/608.03bde0bd.js"><link rel="prefetch" href="/prepare/assets/js/609.1b442e58.js"><link rel="prefetch" href="/prepare/assets/js/61.f452eb1e.js"><link rel="prefetch" href="/prepare/assets/js/610.2ef81500.js"><link rel="prefetch" href="/prepare/assets/js/611.96399caa.js"><link rel="prefetch" href="/prepare/assets/js/612.fc7dfc5d.js"><link rel="prefetch" href="/prepare/assets/js/613.4185c191.js"><link rel="prefetch" href="/prepare/assets/js/614.35906dc3.js"><link rel="prefetch" href="/prepare/assets/js/615.62cbaa22.js"><link rel="prefetch" href="/prepare/assets/js/616.c87bac1f.js"><link rel="prefetch" href="/prepare/assets/js/617.51e4191c.js"><link rel="prefetch" href="/prepare/assets/js/618.9795ed7d.js"><link rel="prefetch" href="/prepare/assets/js/619.8480dd10.js"><link rel="prefetch" href="/prepare/assets/js/62.537fb957.js"><link rel="prefetch" href="/prepare/assets/js/620.6bd6dc7d.js"><link rel="prefetch" href="/prepare/assets/js/621.574df2d9.js"><link rel="prefetch" href="/prepare/assets/js/622.2fe85e03.js"><link rel="prefetch" href="/prepare/assets/js/623.93205ff4.js"><link rel="prefetch" href="/prepare/assets/js/624.4ccab28e.js"><link rel="prefetch" href="/prepare/assets/js/625.5e7f3dcb.js"><link rel="prefetch" href="/prepare/assets/js/626.46e46e89.js"><link rel="prefetch" href="/prepare/assets/js/627.982a0d54.js"><link rel="prefetch" href="/prepare/assets/js/628.74d53553.js"><link rel="prefetch" href="/prepare/assets/js/629.dbbd05eb.js"><link rel="prefetch" href="/prepare/assets/js/63.9b6fda45.js"><link rel="prefetch" href="/prepare/assets/js/630.a66858f8.js"><link rel="prefetch" href="/prepare/assets/js/631.ba8c02f6.js"><link rel="prefetch" href="/prepare/assets/js/632.f57697ae.js"><link rel="prefetch" href="/prepare/assets/js/633.cd6601cf.js"><link rel="prefetch" href="/prepare/assets/js/634.8021f0f8.js"><link rel="prefetch" href="/prepare/assets/js/635.a0fe87bb.js"><link rel="prefetch" href="/prepare/assets/js/636.1028d6a1.js"><link rel="prefetch" href="/prepare/assets/js/637.d44b90f3.js"><link rel="prefetch" href="/prepare/assets/js/638.cd7b4655.js"><link rel="prefetch" href="/prepare/assets/js/639.52477e65.js"><link rel="prefetch" href="/prepare/assets/js/64.7d5117e3.js"><link rel="prefetch" href="/prepare/assets/js/640.00d68b31.js"><link rel="prefetch" href="/prepare/assets/js/641.c5f4dbcc.js"><link rel="prefetch" href="/prepare/assets/js/642.17eea3ca.js"><link rel="prefetch" href="/prepare/assets/js/643.772390ae.js"><link rel="prefetch" href="/prepare/assets/js/644.04ec58e5.js"><link rel="prefetch" href="/prepare/assets/js/645.18375f4a.js"><link rel="prefetch" href="/prepare/assets/js/646.dbd8519b.js"><link rel="prefetch" href="/prepare/assets/js/647.cc551e9d.js"><link rel="prefetch" href="/prepare/assets/js/648.44ba6da9.js"><link rel="prefetch" href="/prepare/assets/js/65.c6817900.js"><link rel="prefetch" href="/prepare/assets/js/66.0d92e78c.js"><link rel="prefetch" href="/prepare/assets/js/67.bfba1dfe.js"><link rel="prefetch" href="/prepare/assets/js/68.01d551fa.js"><link rel="prefetch" href="/prepare/assets/js/69.5e6c1f1e.js"><link rel="prefetch" href="/prepare/assets/js/7.06976092.js"><link rel="prefetch" href="/prepare/assets/js/70.01d73133.js"><link rel="prefetch" href="/prepare/assets/js/71.7c3de2c4.js"><link rel="prefetch" href="/prepare/assets/js/72.e76e5fb2.js"><link rel="prefetch" href="/prepare/assets/js/73.82fabf4c.js"><link rel="prefetch" href="/prepare/assets/js/74.3f28dbee.js"><link rel="prefetch" href="/prepare/assets/js/75.52a9417d.js"><link rel="prefetch" href="/prepare/assets/js/76.66195e23.js"><link rel="prefetch" href="/prepare/assets/js/77.ef053e83.js"><link rel="prefetch" href="/prepare/assets/js/78.3fa1085d.js"><link rel="prefetch" href="/prepare/assets/js/79.29f7ac3c.js"><link rel="prefetch" href="/prepare/assets/js/8.37e468b7.js"><link rel="prefetch" href="/prepare/assets/js/80.ef72de3c.js"><link rel="prefetch" href="/prepare/assets/js/81.b077feaa.js"><link rel="prefetch" href="/prepare/assets/js/82.e231e989.js"><link rel="prefetch" href="/prepare/assets/js/83.3fd80644.js"><link rel="prefetch" href="/prepare/assets/js/84.4ba9fae0.js"><link rel="prefetch" href="/prepare/assets/js/85.af79e353.js"><link rel="prefetch" href="/prepare/assets/js/86.0dbb6ccf.js"><link rel="prefetch" href="/prepare/assets/js/87.559533ad.js"><link rel="prefetch" href="/prepare/assets/js/88.bc8b8b8f.js"><link rel="prefetch" href="/prepare/assets/js/89.40142912.js"><link rel="prefetch" href="/prepare/assets/js/9.b0c18e5e.js"><link rel="prefetch" href="/prepare/assets/js/90.9c39370c.js"><link rel="prefetch" href="/prepare/assets/js/91.0dc7f473.js"><link rel="prefetch" href="/prepare/assets/js/92.0c4fb004.js"><link rel="prefetch" href="/prepare/assets/js/93.61288dd3.js"><link rel="prefetch" href="/prepare/assets/js/94.64cd0224.js"><link rel="prefetch" href="/prepare/assets/js/95.e9b3d2e2.js"><link rel="prefetch" href="/prepare/assets/js/96.ff539867.js"><link rel="prefetch" href="/prepare/assets/js/97.98ee6cef.js"><link rel="prefetch" href="/prepare/assets/js/98.7ead62e3.js"><link rel="prefetch" href="/prepare/assets/js/99.700f1951.js">
    <link rel="stylesheet" href="/prepare/assets/css/0.styles.49d0346a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/prepare/" class="home-link router-link-active"><!----> <span class="site-name">Lu notes</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/prepare/" class="nav-link">首页</a></div><div class="nav-item"><a href="/prepare/js/" class="nav-link">Js</a></div><div class="nav-item"><a href="/prepare/react/" class="nav-link router-link-active">React</a></div><div class="nav-item"><a href="/prepare/vue/" class="nav-link">Vue</a></div><div class="nav-item"><a href="/prepare/framework/" class="nav-link">框架通识</a></div><div class="nav-item"><a href="/prepare/safety/" class="nav-link">安全性能</a></div><div class="nav-item"><a href="/prepare/prepare/" class="nav-link">Prepare</a></div><div class="nav-item"><a href="/prepare/handrolledcode/" class="nav-link">手撸代码无敌</a></div><div class="nav-item"><a href="/prepare/dataalgorithm/" class="nav-link">数据算法</a></div><div class="nav-item"><a href="/prepare/engineering/" class="nav-link">工程化</a></div><div class="nav-item"><a href="/prepare/other/" class="nav-link">其他</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/prepare/" class="nav-link">首页</a></div><div class="nav-item"><a href="/prepare/js/" class="nav-link">Js</a></div><div class="nav-item"><a href="/prepare/react/" class="nav-link router-link-active">React</a></div><div class="nav-item"><a href="/prepare/vue/" class="nav-link">Vue</a></div><div class="nav-item"><a href="/prepare/framework/" class="nav-link">框架通识</a></div><div class="nav-item"><a href="/prepare/safety/" class="nav-link">安全性能</a></div><div class="nav-item"><a href="/prepare/prepare/" class="nav-link">Prepare</a></div><div class="nav-item"><a href="/prepare/handrolledcode/" class="nav-link">手撸代码无敌</a></div><div class="nav-item"><a href="/prepare/dataalgorithm/" class="nav-link">数据算法</a></div><div class="nav-item"><a href="/prepare/engineering/" class="nav-link">工程化</a></div><div class="nav-item"><a href="/prepare/other/" class="nav-link">其他</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><a href="/prepare/react/Collection/" class="sidebar-heading clickable"><span>Collection</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/prepare/react/Dva/" class="sidebar-heading clickable"><span>Dva</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/prepare/react/React-native/" class="sidebar-heading clickable"><span>React-native</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/prepare/react/React基础/" class="sidebar-heading clickable"><span>React基础</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/prepare/react/React进阶/" class="sidebar-heading clickable"><span>React进阶</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/prepare/react/源码分析/" class="sidebar-heading clickable open"><span>源码分析</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/prepare/react/源码分析/200行代码实现简版react.html" class="sidebar-link">200行代码实现简版react</a></li><li><a href="/prepare/react/源码分析/40行代码内实现一个React.html" class="sidebar-link">40行代码内实现一个React</a></li><li><a href="/prepare/react/源码分析/85行代码实现一个React.html" class="sidebar-link">85行代码实现一个React</a></li><li><a href="/prepare/react/源码分析/memoize-one源码解析.html" class="sidebar-link">memoize-one源码解析</a></li><li><a href="/prepare/react/源码分析/React Fiber 架构解析.html" class="sidebar-link">React Fiber 架构解析</a></li><li><a href="/prepare/react/源码分析/React-Object实现React对象.html" class="sidebar-link">React-Object实现React对象</a></li><li><a href="/prepare/react/源码分析/React-redux源码分析.html" class="sidebar-link">React-redux源码分析</a></li><li><a href="/prepare/react/源码分析/Redux源码分析.html" class="sidebar-link">Redux源码分析</a></li><li><a href="/prepare/react/源码分析/从0实现一个lu-redux.html" class="sidebar-link">从0实现一个lu-redux</a></li><li><a href="/prepare/react/源码分析/从0实现一个tiny-react-redux.html" class="sidebar-link">从0实现一个tiny-react-redux</a></li><li><a href="/prepare/react/源码分析/从0实现一个tiny-react.html" class="sidebar-link">从0实现一个tiny-react</a></li><li><a href="/prepare/react/源码分析/从0开始实现react-router.html" class="sidebar-link">从0开始实现react-router</a></li><li><a href="/prepare/react/源码分析/从头实现一个简易版React.html" class="sidebar-link">从头实现一个简易版React</a></li><li><a href="/prepare/react/源码分析/从零开始实现一个React（一）：JSX和虚拟DOM.html" class="sidebar-link">从零开始实现一个React（一）：JSX和虚拟DOM</a></li><li><a href="/prepare/react/源码分析/从零开始实现一个React（三）：diff算法.html" class="sidebar-link">从零开始实现一个React（三）：diff算法</a></li><li><a href="/prepare/react/源码分析/从零开始实现一个React（二）：组件和生命周期.html" class="sidebar-link">从零开始实现一个React（二）：组件和生命周期</a></li><li><a href="/prepare/react/源码分析/从零开始实现一个React（四）：异步的setState.html" class="sidebar-link">从零开始实现一个React（四）：异步的setState</a></li><li><a href="/prepare/react/源码分析/动手实现React-redux.html" class="sidebar-link">动手实现React-redux</a></li><li><a href="/prepare/react/源码分析/动手实现Redux.html" class="sidebar-link">动手实现Redux</a></li><li><a href="/prepare/react/源码分析/实现Didact.html" class="sidebar-link">实现Didact</a></li><li><a href="/prepare/react/源码分析/实现一个简易版的React.html" class="active sidebar-link">实现一个简易版的React</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/prepare/react/源码分析/实现一个简易版的React.html#写在前面" class="sidebar-link">写在前面</a></li><li class="sidebar-sub-header"><a href="/prepare/react/源码分析/实现一个简易版的React.html#实现一个-hello-react！的渲染" class="sidebar-link">实现一个 hello React！的渲染</a></li><li class="sidebar-sub-header"><a href="/prepare/react/源码分析/实现一个简易版的React.html#虚拟-dom" class="sidebar-link">虚拟 dom</a></li><li class="sidebar-sub-header"><a href="/prepare/react/源码分析/实现一个简易版的React.html#实现一个简单的更新机制" class="sidebar-link">实现一个简单的更新机制</a></li></ul></li><li><a href="/prepare/react/源码分析/实现自己的react之简单rendering.html" class="sidebar-link">实现自己的react之简单rendering</a></li><li><a href="/prepare/react/源码分析/简易版react.html" class="sidebar-link">简易版react</a></li><li><a href="/prepare/react/源码分析/路由实现及react-router-v4源码分析.html" class="sidebar-link">路由实现及react-router-v4源码分析</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="react-源码分析，实现一个简易版的react"><a href="#react-源码分析，实现一个简易版的react" aria-hidden="true" class="header-anchor">#</a> React 源码分析，实现一个简易版的React</h1> <ul><li><a href="#react-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E7%AE%80%E6%98%93%E7%89%88%E7%9A%84react">React 源码分析，实现一个简易版的React</a> <ul><li><a href="#%E5%86%99%E5%9C%A8%E5%89%8D%E9%9D%A2">写在前面</a></li> <li><a href="#%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA-hello-react%E7%9A%84%E6%B8%B2%E6%9F%93">实现一个 hello React！的渲染</a></li> <li><a href="#%E8%99%9A%E6%8B%9F-dom">虚拟 dom</a></li> <li><a href="#%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84%E6%9B%B4%E6%96%B0%E6%9C%BA%E5%88%B6">实现一个简单的更新机制</a> <ul><li><a href="#%E6%96%87%E6%9C%AC%E8%8A%82%E7%82%B9%E7%9A%84-receivecomponent">文本节点的 receiveComponent</a></li> <li><a href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E5%85%83%E7%B4%A0%E7%9A%84-receivecomponent">自定义元素的 receiveComponent</a> <ul><li><a href="#%E5%9F%BA%E6%9C%AC%E5%85%83%E7%B4%A0%E7%9A%84-receivecomponent">基本元素的 receiveComponent</a></li></ul></li> <li><a href="#diff-%E5%AE%9E%E7%8E%B0">diff 实现</a></li> <li><a href="#_patch-%E7%9A%84%E5%AE%9E%E7%8E%B0">_patch 的实现</a></li> <li><a href="#end">end</a></li></ul></li></ul></li></ul> <h2 id="写在前面"><a href="#写在前面" aria-hidden="true" class="header-anchor">#</a> 写在前面</h2> <p>基于 React v15<br>
包括：</p> <ul><li>React 的几种组件以及首次渲染实现</li> <li>React 更新机制的实现以及 React diff 算法</li></ul> <p>React 的核心主要有一下几点。</p> <ul><li>虚拟 dom 对象（Virtual DOM）</li> <li>虚拟 dom 差异化算法（diff algorithm）</li> <li>单向数据流</li> <li>组件声明周期</li> <li>事件处理</li></ul> <h2 id="实现一个-hello-react！的渲染"><a href="#实现一个-hello-react！的渲染" aria-hidden="true" class="header-anchor">#</a> 实现一个 hello React！的渲染</h2> <p>看如下代码：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>// js
React.render('hello React！',document.getElementById(&quot;root&quot;))

// html
&lt;div id=&quot;root&quot;&gt;&lt;/div&gt;

// 生成代码
&lt;div id=&quot;root&quot;&gt;
    &lt;span data-reactid=&quot;0&quot;&gt;hello React!&lt;/span&gt;
&lt;/div&gt;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>针对上面代码的具体实现</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">/**
 * component 类
 * 文本类型
 * @param {*} text 文本内容
 */</span>
<span class="token keyword">function</span> <span class="token function">ReactDOMTextComponent</span><span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 存下当前的字符串</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>_currentElement <span class="token operator">=</span> <span class="token string">&quot;&quot;</span> <span class="token operator">+</span> text<span class="token punctuation">;</span>
  <span class="token comment">// 用来标识当前component</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>_rootNodeID <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * component 类 装载方法,生成 dom 结构
 * @param {number} rootID 元素id
 * @return {string} 返回dom
 */</span>
<span class="token class-name">ReactDOMTextComponent</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">mountComponent</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">rootID</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>_rootNodeID <span class="token operator">=</span> rootID<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token string">'&lt;span data-reactid=&quot;'</span> <span class="token operator">+</span> rootID <span class="token operator">+</span> <span class="token string">'&quot;&gt;'</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_currentElement <span class="token operator">+</span> <span class="token string">&quot;&lt;/span&gt;&quot;</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 根据元素类型实例化一个具体的component
 * @param {*} node ReactElement
 * @return {*} 返回一个具体的component实例
 */</span>
<span class="token keyword">function</span> <span class="token function">instantiateReactComponent</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//文本节点的情况</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> node <span class="token operator">===</span> <span class="token string">&quot;string&quot;</span> <span class="token operator">||</span> <span class="token keyword">typeof</span> node <span class="token operator">===</span> <span class="token string">&quot;number&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ReactDOMTextComponent</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> React <span class="token operator">=</span> <span class="token punctuation">{</span>
 nextReactRootIndex<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>

 <span class="token comment">/**
  * 接收一个React元素，和一个dom节点
  * @param {*} element React元素
  * @param {*} container 负责装载的dom
  */</span>
  <span class="token function-variable function">render</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">element<span class="token punctuation">,</span> container</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 实例化组件</span>
    <span class="token keyword">var</span> componentInstance <span class="token operator">=</span> <span class="token function">instantiateReactComponent</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 组件完成dom装载</span>
    <span class="token keyword">var</span> markup <span class="token operator">=</span> componentInstance<span class="token punctuation">.</span><span class="token function">mountComponent</span><span class="token punctuation">(</span>React<span class="token punctuation">.</span>nextReactRootIndex<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 将装载好的 dom 放入 container 中</span>
    <span class="token function">$</span><span class="token punctuation">(</span>container<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">html</span><span class="token punctuation">(</span>markup<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">$</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trigger</span><span class="token punctuation">(</span><span class="token string">&quot;mountReady&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br></div></div><p>这里代码分为三个部分：</p> <ol><li>React.render 作为入口接受一个 React 元素和游览器中的 dom 负责调用渲染,nextReactRootIndex 为每个 component 的唯一标识</li> <li>引入 component 类的概念，ReactDOMTextComponent 是一个 component 类定义。ReactDOMTextComponent 针对于文本节点进行处理。并且在 ReactDOMTextComponent 的原型上实现了 mountComponent 方法，用于对组件的渲染，返回组件的 dom 结构。当然 component 还具有更新和删除操作，这里将在后续讲解。</li> <li>instantiateReactComponent 用来根据 element 的类型（现在只有一种 string 类型），返回一个 component 的实例。其实就是个类工厂。</li></ol> <blockquote><p>在这里我们把逻辑分为几个部分，渲染逻辑则由 component 内部定义，<code>React.render</code> 负责调度整个流程，在调用 <code>instantiateReactComponent</code> 生成一个对应 <code>component</code> 类型的实例对象，再调用对象的 mountComponent 返回 dom，最后再写到 container 节点中</p></blockquote> <h2 id="虚拟-dom"><a href="#虚拟-dom" aria-hidden="true" class="header-anchor">#</a> 虚拟 dom</h2> <p>虚拟 dom 无疑是 React 的核心概念，在代码中我们会使用 React.createElement 来创建一个虚拟 dom 元素。</p> <p>虚拟 dom 分为两种一种是游览器自带的基本元素比如 div，还有一种是自定义元素（文本节点不算虚拟 dom）</p> <p>虚拟节点的使用方式</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 绑定事件监听方法</span>
<span class="token keyword">function</span> <span class="token function">sayHello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'hello!'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> element <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>id<span class="token punctuation">:</span><span class="token string">'jason'</span><span class="token punctuation">,</span>onclick<span class="token punctuation">:</span>hello<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">'click me'</span><span class="token punctuation">)</span>
React<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;root&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">// 最终生成的html</span>

<span class="token operator">&lt;</span>div data<span class="token operator">-</span>reactid<span class="token operator">=</span><span class="token string">&quot;0&quot;</span> id<span class="token operator">=</span><span class="token string">&quot;jason&quot;</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>span data<span class="token operator">-</span>reactid<span class="token operator">=</span><span class="token string">&quot;0.0&quot;</span><span class="token operator">&gt;</span>click me<span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>我们使用 React.createElement 来创建一个虚拟 dom 元素，以下是简易实现</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">/**
 * ReactElement 就是虚拟节点的概念
 * @param {*} key 虚拟节点的唯一标识，后期可以进行优化
 * @param {*} type 虚拟节点类型，type可能是字符串（'div', 'span'），也可能是一个function，function时为一个自定义组件
 * @param {*} props 虚拟节点的属性
 */</span>
<span class="token keyword">function</span> <span class="token function">ReactElement</span><span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> key<span class="token punctuation">,</span> props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>type <span class="token operator">=</span> type<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>key <span class="token operator">=</span> key<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>props <span class="token operator">=</span> props<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> React <span class="token operator">=</span> <span class="token punctuation">{</span>
  nextReactRootIndex<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token comment">/**
   * @param {*} type 元素的 component 类型
   * @param {*} config 元素配置
   * @param {*} children 元素的子元素
   */</span>
  <span class="token function-variable function">createElement</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> config<span class="token punctuation">,</span> children</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> props <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> propName<span class="token punctuation">;</span>
    config <span class="token operator">=</span> config <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">var</span> key <span class="token operator">=</span> config<span class="token punctuation">.</span>key <span class="token operator">||</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>propName <span class="token keyword">in</span> config<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>propName<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> propName <span class="token operator">!==</span> <span class="token string">&quot;key&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        props<span class="token punctuation">[</span>propName<span class="token punctuation">]</span> <span class="token operator">=</span> config<span class="token punctuation">[</span>propName<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">var</span> childrenLength <span class="token operator">=</span> arguments<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>childrenLength <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      props<span class="token punctuation">.</span>children <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span> <span class="token operator">?</span> children <span class="token punctuation">:</span> <span class="token punctuation">[</span>children<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>childrenLength <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> childArray <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> childrenLength<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        childArray<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> arguments<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      props<span class="token punctuation">.</span>children <span class="token operator">=</span> childArray<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ReactElement</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> key<span class="token punctuation">,</span> props<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token comment">/**
   * 自行添加上文中的render方法
   */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br></div></div><blockquote><p>createElement 方法对传入的参数做了一些处理，最终会返回一个 ReactElement 虚拟元素实例，key 的定义可以提高更新时的效率</p></blockquote> <p>有了虚拟元素实例，我们需要改造一下 instantiateReactComponent 方法</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">/**
 * 根据元素类型实例化一个具体的component
 * @param {*} node ReactElement
 * @return {*} 返回一个具体的component实例
 */</span>
<span class="token keyword">function</span> <span class="token function">instantiateReactComponent</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//文本节点的情况</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> node <span class="token operator">===</span> <span class="token string">&quot;string&quot;</span> <span class="token operator">||</span> <span class="token keyword">typeof</span> node <span class="token operator">===</span> <span class="token string">&quot;number&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ReactDOMTextComponent</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//浏览器默认节点的情况</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> node <span class="token operator">===</span> <span class="token string">&quot;object&quot;</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> node<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//注意这里，使用了一种新的component</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ReactDOMComponent</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><blockquote><p>我们增加了一个判断，这样当 render 的不是文本而是浏览器的基本元素时。我们使用另外一种 component 来处理它渲染时应该返回的内容。这里就体现了工厂方法 instantiateReactComponent 的好处了，不管来了什么类型的 node，都可以负责生产出一个负责渲染的 component 实例。这样 render 完全不需要做任何修改，只需要再做一种对应的 component 类型（这里是 ReactDOMComponent）就行了。</p></blockquote> <p><code>ReactDOMComponent</code>的具体实现</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">/**
 * component 类
 * react 基础标签类型，类似与html中的（'div','span' 等）
 * @param {*} element 基础元素
 */</span>
<span class="token keyword">function</span> <span class="token function">ReactDOMComponent</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 存下当前的element对象引用</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>_currentElement <span class="token operator">=</span> element<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>_rootNodeID <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * component 类 装载方法
 * @param {*} rootID 元素id
 * @param {string} 返回dom
 */</span>
<span class="token class-name">ReactDOMComponent</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">mountComponent</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">rootID</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>_rootNodeID <span class="token operator">=</span> rootID<span class="token punctuation">;</span>
  <span class="token keyword">var</span> props <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_currentElement<span class="token punctuation">.</span>props<span class="token punctuation">;</span>

  <span class="token comment">// 外层标签</span>
  <span class="token keyword">var</span> tagOpen <span class="token operator">=</span> <span class="token string">&quot;&lt;&quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_currentElement<span class="token punctuation">.</span>type<span class="token punctuation">;</span>
  <span class="token keyword">var</span> tagClose <span class="token operator">=</span> <span class="token string">&quot;&lt;/&quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_currentElement<span class="token punctuation">.</span>type <span class="token operator">+</span> <span class="token string">&quot;&gt;&quot;</span><span class="token punctuation">;</span>

  <span class="token comment">// 加上reactid标识</span>
  tagOpen <span class="token operator">+=</span> <span class="token string">&quot; data-reactid=&quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_rootNodeID<span class="token punctuation">;</span>

  <span class="token comment">// 拼接标签属性</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> propKey <span class="token keyword">in</span> props<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 属性为绑定事件</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex">/^on[A-Za-z]/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>propKey<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> eventType <span class="token operator">=</span> propKey<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">&quot;on&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 对当前节点添加事件代理</span>
      <span class="token function">$</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">delegate</span><span class="token punctuation">(</span>
        <span class="token string">'[data-reactid=&quot;'</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_rootNodeID <span class="token operator">+</span> <span class="token string">'&quot;]'</span><span class="token punctuation">,</span>
        eventType <span class="token operator">+</span> <span class="token string">&quot;.&quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_rootNodeID<span class="token punctuation">,</span>
        props<span class="token punctuation">[</span>propKey<span class="token punctuation">]</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 对于props 上的children和事件属性不做处理</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      props<span class="token punctuation">[</span>propKey<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span>
      propKey <span class="token operator">!=</span> <span class="token string">&quot;children&quot;</span> <span class="token operator">&amp;&amp;</span>
      <span class="token operator">!</span><span class="token regex">/^on[A-Za-z]/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>propKey<span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      tagOpen <span class="token operator">+=</span> <span class="token string">&quot; &quot;</span> <span class="token operator">+</span> propKey <span class="token operator">+</span> <span class="token string">&quot;=&quot;</span> <span class="token operator">+</span> props<span class="token punctuation">[</span>propKey<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 渲染子节点dom</span>
  <span class="token keyword">var</span> content <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> children <span class="token operator">=</span> props<span class="token punctuation">.</span>children <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token keyword">var</span> childrenInstances <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 保存子节点component 实例</span>
  <span class="token keyword">var</span> that <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>

  children<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">child<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> childComponentInstance <span class="token operator">=</span> <span class="token function">instantiateReactComponent</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 为子节点添加标记</span>
    childComponentInstance<span class="token punctuation">.</span>_mountIndex <span class="token operator">=</span> key<span class="token punctuation">;</span>
    childrenInstances<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>childComponentInstance<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> curRootId <span class="token operator">=</span> that<span class="token punctuation">.</span>_rootNodeID <span class="token operator">+</span> <span class="token string">&quot;.&quot;</span> <span class="token operator">+</span> key<span class="token punctuation">;</span>

    <span class="token comment">// 得到子节点的渲染内容</span>
    <span class="token keyword">var</span> childMarkup <span class="token operator">=</span> childComponentInstance<span class="token punctuation">.</span><span class="token function">mountComponent</span><span class="token punctuation">(</span>curRootId<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 拼接在一起</span>
    content <span class="token operator">+=</span> <span class="token string">&quot; &quot;</span> <span class="token operator">+</span> childMarkup<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 保存component 实例</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>_renderedChildren <span class="token operator">=</span> childrenInstances<span class="token punctuation">;</span>

  <span class="token comment">// 拼出整个html内容</span>
  <span class="token keyword">return</span> tagOpen <span class="token operator">+</span> <span class="token string">&quot;&gt;&quot;</span> <span class="token operator">+</span> content <span class="token operator">+</span> tagClose<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br></div></div><p>对于虚拟 dom 的渲染逻辑，本质上还是个递归渲染的东西，reactElement 会递归渲染自己的子节点。可以看到我们通过 instantiateReactComponent 屏蔽了子节点的差异，只需要使用不同的 component 类，这样都能保证通过 mountComponent 最终拿到渲染后的内容。</p> <p>另外这边的事件也要说下，可以在传递 props 的时候传入{onClick:function(){}}这样的参数，这样就会在当前元素上添加事件，代理到 document。由于 React 本身全是在写 js，所以监听的函数的传递变得特别简单。</p> <blockquote><p>这里很多东西没有考虑，这里为了保持简单就不再扩展了，另外 React 的事件处理其实很复杂，实现了一套标准的 w3c 事件。这里偷懒直接使用 jQuery 的事件代理到 document 上了。</p></blockquote> <p><code>自定义元素</code>的实现
随着前端技术的发展浏览器的那些基本元素已经满足不了我们的需求了，如果你对 web components 有一定的了解，就会知道人们一直在尝试扩展一些自己的标记。</p> <p>React 通过虚拟 dom 做到了类似的功能，还记得我们上面 node.type 只是个简单的字符串，如果是个类呢？如果这个类恰好还有自己的生命周期管理，那扩展性就很高了。</p> <p>在 React 中使用自定义元素</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> CompositeComponent <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createClass</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function-variable function">getInitialState</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      count<span class="token punctuation">:</span> <span class="token number">0</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">componentWillMount</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;声明周期: &quot;</span> <span class="token operator">+</span> <span class="token string">&quot;componentWillMount&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">componentDidMount</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;声明周期: &quot;</span> <span class="token operator">+</span> <span class="token string">&quot;componentDidMount&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">onChange</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> count <span class="token operator">=</span> <span class="token operator">++</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      count<span class="token punctuation">:</span> count
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">render</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> count <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count<span class="token punctuation">;</span>
    <span class="token keyword">var</span> h3 <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>
      <span class="token string">&quot;h3&quot;</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span> onclick<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onChange</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">class</span><span class="token punctuation">:</span> <span class="token string">&quot;h3&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">click me </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>count<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> children <span class="token operator">=</span> <span class="token punctuation">[</span>h3<span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;div&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> children<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> CompositeElement <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>CompositeComponent<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> root <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;container&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

React<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>CompositeElement<span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><p><code>React.createElement</code>接受的不再是字符串，而是一个 class。
React.createClass 生成一个自定义标记类，带有基本的生命周期：</p> <ul><li>getInitialState 获取最初的属性值 this.state</li> <li>componentWillmount 在组件准备渲染时调用</li> <li>componentDidMount 在组件渲染完成后调用</li></ul> <p>React.createClass 的实现</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">/**
 * 所有自定义组件的超类
 * @function render所有自定义组件都有该方法
 */</span>
<span class="token keyword">function</span> <span class="token function">ReactClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token class-name">ReactClass</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">render</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 更新
 * @param {*} newState 新状态
 */</span>
<span class="token class-name">ReactClass</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">setState</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">newState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 拿到ReactCompositeComponent的实例</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>_reactInternalInstance<span class="token punctuation">.</span><span class="token function">receiveComponent</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> newState<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> React <span class="token operator">=</span> <span class="token punctuation">{</span>
  nextReactRootIndex<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>

  <span class="token comment">/**
   * 创建 ReactClass
   * @param {*} spec 传入的对象
   */</span>
  <span class="token function-variable function">createClass</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">spec</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> <span class="token function-variable function">Constructor</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>props <span class="token operator">=</span> props<span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>getInitialState <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getInitialState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token class-name">Constructor</span><span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReactClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Constructor</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>constructor <span class="token operator">=</span> Constructor<span class="token punctuation">;</span>

    Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token class-name">Constructor</span><span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> spec<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> Constructor<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token comment">/**
   * 自己上文的createElement方法
   */</span>

  <span class="token comment">/**
   * 自己上文的render方法
   */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br></div></div><p>这里 createClass 生成了一个继承 ReactClass 的子类，在构造函数里调用 this.getInitialState 获得最初的 state。</p> <blockquote><p>为了演示方便,我们这边的 ReactClass 相当简单，实际上原始的代码处理了很多东西，比如类的 mixin 的组合继承支持,比如 componentDidMount 等可以定义多次，需要合并调用等等，有兴趣的去翻源码吧，不是本文的主要目的，这里就不详细展开了。</p></blockquote> <p>看看我们上面的两种类型就知道，我们是时候为自定义元素也提供一个 component 类了，在那个类里我们会实例化 ReactClass，并且管理生命周期，还有父子组件依赖。</p> <p>首先改造 instantiateReactComponent</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">/**
 * 根据元素类型实例化一个具体的component
 * @param {*} node ReactElement
 * @return {*} 返回一个具体的component实例
 */</span>
<span class="token keyword">function</span> <span class="token function">instantiateReactComponent</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 文本节点的情况</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> node <span class="token operator">===</span> <span class="token string">&quot;string&quot;</span> <span class="token operator">||</span> <span class="token keyword">typeof</span> node <span class="token operator">===</span> <span class="token string">&quot;number&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ReactDOMTextComponent</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//浏览器默认节点的情况</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> node <span class="token operator">===</span> <span class="token string">&quot;object&quot;</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> node<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 注意这里，使用了一种新的component</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ReactDOMComponent</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 自定义的元素节点</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> node <span class="token operator">===</span> <span class="token string">&quot;object&quot;</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> node<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&quot;function&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 注意这里，使用新的component,专门针对自定义元素</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ReactCompositeComponent</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><blockquote><p>这里我们添加了一个判断，处理自定义类型的 component</p></blockquote> <p>ReactCompositeComponent 的具体实现如下</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">/**
 * component 类
 * 复合组件类型
 * @param {*} element 元素
 */</span>
<span class="token keyword">function</span> <span class="token function">ReactCompositeComponent</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 存放元素element对象</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>_currentElement <span class="token operator">=</span> element<span class="token punctuation">;</span>
  <span class="token comment">// 存放唯一标识</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>_rootNodeID <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token comment">// 存放对应的ReactClass的实例</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>_instance <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * component 类 装载方法
 * @param {*} rootID 元素id
 * @param {string} 返回dom
 */</span>
<span class="token class-name">ReactCompositeComponent</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">mountComponent</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">rootID</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>_rootNodeID <span class="token operator">=</span> rootID<span class="token punctuation">;</span>

  <span class="token comment">// 当前元素属性</span>
  <span class="token keyword">var</span> publicProps <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_currentElement<span class="token punctuation">.</span>props<span class="token punctuation">;</span>
  <span class="token comment">// 对应的ReactClass</span>
  <span class="token keyword">var</span> ReactClass <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_currentElement<span class="token punctuation">.</span>type<span class="token punctuation">;</span>

  <span class="token keyword">var</span> inst <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReactClass</span><span class="token punctuation">(</span>publicProps<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>_instance <span class="token operator">=</span> inst<span class="token punctuation">;</span>

  <span class="token comment">// 保留对当前 component的引用</span>
  inst<span class="token punctuation">.</span>_reactInternalInstance <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>inst<span class="token punctuation">.</span>componentWillMount<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 生命周期</span>
    inst<span class="token punctuation">.</span><span class="token function">componentWillMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//这里在原始的 reactjs 其实还有一层处理，就是  componentWillMount 调用 setstate，不会触发 rerender 而是自动提前合并，这里为了保持简单，就略去了</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 调用 ReactClass 实例的render 方法，返回一个element或者文本节点</span>
  <span class="token keyword">var</span> renderedElement <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_instance<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> renderedComponentInstance <span class="token operator">=</span> <span class="token function">instantiateReactComponent</span><span class="token punctuation">(</span>renderedElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>_renderedComponent <span class="token operator">=</span> renderedComponentInstance<span class="token punctuation">;</span> <span class="token comment">//存起来留作后用</span>

  <span class="token keyword">var</span> renderedMarkup <span class="token operator">=</span> renderedComponentInstance<span class="token punctuation">.</span><span class="token function">mountComponent</span><span class="token punctuation">(</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_rootNodeID
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// dom 装载到html 后调用生命周期</span>
  <span class="token function">$</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;mountReady&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    inst<span class="token punctuation">.</span>componentDidMount <span class="token operator">&amp;&amp;</span> inst<span class="token punctuation">.</span><span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> renderedMarkup<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br></div></div><p>自定义元素本身不负责具体的内容，他更多的是负责生命周期。具体的内容是由它的 render 方法返回的虚拟节点来负责渲染的。</p> <blockquote><p>本质上也是递归的去渲染内容的过程。同时因为这种递归的特性，父组件的 componentWillMount 一定在某个子组件的 componentWillMount 之前调用，而父组件的 componentDidMount 肯定在子组件之后，因为监听 mountReady 事件，肯定是子组件先监听的。</p></blockquote> <blockquote><p>需要注意的是自定义元素并不会处理我们 createElement 时传入的子节点，它只会处理自己 render 返回的节点作为自己的子节点。不过我们在 render 时可以使用 this.props.children 拿到那些传入的子节点，可以自己处理。其实有点类似 web components 里面的 shadow dom 的作用。</p></blockquote> <p>初始化渲染的大致流程如下:</p> <div align="center"><img src="/prepare/images/react/041101.jpeg" alt="images/react/041101.jpeg"></div> <h2 id="实现一个简单的更新机制"><a href="#实现一个简单的更新机制" aria-hidden="true" class="header-anchor">#</a> 实现一个简单的更新机制</h2> <p>一般在 React 中我们需要更新时都是调用的 setState 方法。所以本文的更新就基于 setState 实现。看下面的调用方式:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">/**
 * ReactCompositeComponent组件
 */</span>
<span class="token keyword">var</span> CompositeComponent <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createClass</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function-variable function">getInitialState</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      count<span class="token punctuation">:</span> <span class="token number">0</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">componentWillMount</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;声明周期: &quot;</span> <span class="token operator">+</span> <span class="token string">&quot;componentWillMount&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">componentDidMount</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;声明周期: &quot;</span> <span class="token operator">+</span> <span class="token string">&quot;componentDidMount&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">onChange</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> count <span class="token operator">=</span> <span class="token operator">++</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      count<span class="token punctuation">:</span> count
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">render</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> count <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>count<span class="token punctuation">;</span>
    <span class="token keyword">var</span> h3 <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>
      <span class="token string">&quot;h3&quot;</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span> onclick<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onChange</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">class</span><span class="token punctuation">:</span> <span class="token string">&quot;h3&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">click me </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>count<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> children <span class="token operator">=</span> <span class="token punctuation">[</span>h3<span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;div&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> children<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> CompositeElement <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>CompositeComponent<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> root <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;root&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

React<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>CompositeElement<span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 生成html</span>
<span class="token operator">&lt;</span>div id<span class="token operator">=</span><span class="token string">&quot;root&quot;</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>div data<span class="token operator">-</span>reactid<span class="token operator">=</span><span class="token string">&quot;0&quot;</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>h3 data<span class="token operator">-</span>reactid<span class="token operator">=</span><span class="token string">&quot;0.0&quot;</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;h3&quot;</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>span data<span class="token operator">-</span>reactid<span class="token operator">=</span><span class="token string">&quot;0.0.0&quot;</span><span class="token operator">&gt;</span>click me <span class="token number">0</span><span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>h3<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>

<span class="token comment">// 点击click me 计数会递增</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br></div></div><blockquote><p>点击文字就会调用 setState 走更新流程，我们回顾一下 ReactClass，看一下 setState 的实现</p></blockquote> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">/**
 * 更新
 * @param {*} newState 新状态
 */</span>
<span class="token class-name">ReactClass</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">setState</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">newState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 拿到ReactCompositeComponent的实例</span>
  <span class="token comment">// 在装载的时候保存</span>
  <span class="token comment">// 代码：this._reactInternalInstance = this</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>_reactInternalInstance<span class="token punctuation">.</span><span class="token function">receiveComponent</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> newState<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><blockquote><p>可以看到 setState 主要调用了对应的 component 的 receiveComponent 来实现更新。所有的挂载，更新都应该交给对应的 component 来管理。所以就像所有的 component 都实现了 mountComponent 来处理第一次渲染，所有的 component 类都应该实现 receiveComponent 用来处理自己的更新。</p></blockquote> <h3 id="文本节点的-receivecomponent"><a href="#文本节点的-receivecomponent" aria-hidden="true" class="header-anchor">#</a> 文本节点的 receiveComponent</h3> <p>文本节点的更新比较简单，拿到新的文本进行比较，不同则直接替换整个节点</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">/**
 * component 类 更新
 * @param {*} newText
 */</span>
<span class="token class-name">ReactDOMTextComponent</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">receiveComponent</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">nextText</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> nextStringText <span class="token operator">=</span> <span class="token string">&quot;&quot;</span> <span class="token operator">+</span> nextText<span class="token punctuation">;</span>
  <span class="token comment">// 跟以前保存的字符串比较</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>nextStringText <span class="token operator">!==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_currentElement<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_currentElement <span class="token operator">=</span> nextStringText<span class="token punctuation">;</span>
    <span class="token comment">// 替换整个节点</span>
    <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'[data-reactid=&quot;'</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_rootNodeID <span class="token operator">+</span> <span class="token string">'&quot;]'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">html</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_currentElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h3 id="自定义元素的-receivecomponent"><a href="#自定义元素的-receivecomponent" aria-hidden="true" class="header-anchor">#</a> 自定义元素的 receiveComponent</h3> <p>先来看自定义元素的 receiveComponent 的实现</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">/**
 * component 类 更新
 * @param {*} nextElement
 * @param {*} newState
 */</span>
<span class="token class-name">ReactCompositeComponent</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">receiveComponent</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>
  <span class="token parameter">nextElement<span class="token punctuation">,</span>
  newState</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 如果接受了新的element，则直接使用最新的element</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>_currentElement <span class="token operator">=</span> nextElement <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_currentElement<span class="token punctuation">;</span>

  <span class="token keyword">var</span> inst <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_instance<span class="token punctuation">;</span>
  <span class="token comment">// 合并state</span>
  <span class="token keyword">var</span> nextState <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>inst<span class="token punctuation">.</span>state<span class="token punctuation">,</span> newState<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> nextProps <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_currentElement<span class="token punctuation">.</span>props<span class="token punctuation">;</span>

  <span class="token comment">// 更新state</span>
  inst<span class="token punctuation">.</span>state <span class="token operator">=</span> nextState<span class="token punctuation">;</span>

  <span class="token comment">// 生命周期方法</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    inst<span class="token punctuation">.</span>shouldComponentUpdate <span class="token operator">&amp;&amp;</span>
    inst<span class="token punctuation">.</span><span class="token function">shouldComponentUpdate</span><span class="token punctuation">(</span>nextProps<span class="token punctuation">,</span> nextState<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token boolean">false</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果实例的 shouldComponentUpdate 返回 false，则不需要继续往下执行更新</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 生命周期方法</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>inst<span class="token punctuation">.</span>componentWillUpdate<span class="token punctuation">)</span> inst<span class="token punctuation">.</span><span class="token function">componentWillUpdate</span><span class="token punctuation">(</span>nextProps<span class="token punctuation">,</span> nextState<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 获取老的element</span>
  <span class="token keyword">var</span> prevComponentInstance <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_renderedComponent<span class="token punctuation">;</span>
  <span class="token keyword">var</span> prevRenderedElement <span class="token operator">=</span> prevComponentInstance<span class="token punctuation">.</span>_currentElement<span class="token punctuation">;</span>

  <span class="token comment">// 通过重新render 获取新的element</span>
  <span class="token keyword">var</span> nextRenderedElement <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_instance<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 比较新旧元素</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">_shouldUpdateReactComponent</span><span class="token punctuation">(</span>prevRenderedElement<span class="token punctuation">,</span> nextRenderedElement<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 两种元素为相同，需要更新，执行字节点更新</span>
    prevComponentInstance<span class="token punctuation">.</span><span class="token function">receiveComponent</span><span class="token punctuation">(</span>nextRenderedElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 生命周期方法</span>
    inst<span class="token punctuation">.</span>componentDidUpdate <span class="token operator">&amp;&amp;</span> inst<span class="token punctuation">.</span><span class="token function">componentDidUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 两种元素的类型不同，直接重新装载dom</span>
    <span class="token keyword">var</span> thisID <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_rootNodeID<span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>_renderedComponent <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_instantiateReactComponent</span><span class="token punctuation">(</span>
      nextRenderedElement
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">var</span> nextMarkup <span class="token operator">=</span> _renderedComponent<span class="token punctuation">.</span><span class="token function">mountComponent</span><span class="token punctuation">(</span>thisID<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 替换整个节点</span>
    <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'[data-reactid=&quot;'</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_rootNodeID <span class="token operator">+</span> <span class="token string">'&quot;]'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replaceWith</span><span class="token punctuation">(</span>nextMarkup<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 通过比较两个元素，判断是否需要更新
 * @param {*} preElement  旧的元素
 * @param {*} nextElement 新的元素
 * @return {boolean}
 */</span>
<span class="token keyword">function</span> <span class="token function">_shouldUpdateReactComponent</span><span class="token punctuation">(</span><span class="token parameter">prevElement<span class="token punctuation">,</span> nextElement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>prevElement <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> nextElement <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> prevType <span class="token operator">=</span> <span class="token keyword">typeof</span> prevElement<span class="token punctuation">;</span>
    <span class="token keyword">var</span> nextType <span class="token operator">=</span> <span class="token keyword">typeof</span> nextElement<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>prevType <span class="token operator">===</span> <span class="token string">&quot;string&quot;</span> <span class="token operator">||</span> prevType <span class="token operator">===</span> <span class="token string">&quot;number&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 文本节点比较是否为相同类型节点</span>
      <span class="token keyword">return</span> nextType <span class="token operator">===</span> <span class="token string">&quot;string&quot;</span> <span class="token operator">||</span> nextType <span class="token operator">===</span> <span class="token string">&quot;number&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 通过type 和 key 判断是否为同类型节点和同一个节点</span>
      <span class="token keyword">return</span> <span class="token punctuation">(</span>
        nextType <span class="token operator">===</span> <span class="token string">&quot;object&quot;</span> <span class="token operator">&amp;&amp;</span>
        prevElement<span class="token punctuation">.</span>type <span class="token operator">===</span> nextElement<span class="token punctuation">.</span>type <span class="token operator">&amp;&amp;</span>
        prevElement<span class="token punctuation">.</span>key <span class="token operator">===</span> nextElement<span class="token punctuation">.</span>key
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br></div></div><p>上述代码的大致流程是:</p> <ul><li>合并 state</li> <li>更新 state</li> <li>然后看业务代码中是否实现生命周期方法 shouldComponentUpdate 有则调用，如果返回值为 false 则停止往下执行</li> <li>然后是生命周期方法 componentWillUpdate</li> <li>然后通过拿到新 state 的 instance 调用 render 方法拿到新的 element 和之旧的 element 进行比较</li> <li>如果要更新就继续调用对应的 component 类对应的 receiveComponent 就好啦，其实就是直接当甩手掌柜，事情直接丢给手下去办了。当然还有种情况是，两次生成的 element 差别太大，就不是一个类型的，那好办直接重新生成一份新的代码重新渲染一次就 o 了</li></ul> <p>_shouldUpdateReactComponent 是一个全局方法，这个是一种 React 的优化机制。用来决定是直接全部替换，还是使用很细微的改动。当两次 render 出来的子节点 key 不同，直接全部重新渲染一遍，替换就好了。否则，我们就得来个递归的更新，保证最小化的更新机制，这样可以不会有太大的闪烁。</p> <blockquote><p>在这里本质上还是递归调用 receiveComponent 的过程。</p></blockquote> <h4 id="基本元素的-receivecomponent"><a href="#基本元素的-receivecomponent" aria-hidden="true" class="header-anchor">#</a> 基本元素的 receiveComponent</h4> <p>基础元素的更新包括两方面</p> <ul><li>属性的更新，包括对特殊属性比如事件的处理</li> <li>子节点的更新</li></ul> <p>子节点的更新比较复杂，是提升效率的关键，所以需要处理以下问题：</p> <ul><li>diff - 拿新的子节点树跟以前老的子节点树对比，找出他们之间的差别。</li> <li>patch - 所有差别找出后，再一次性的去更新。</li></ul> <p>下面是基础元素更新的基本结构</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">/**
 * component 类 更新
 * @param {*} nextElement
 */</span>
<span class="token class-name">ReactDOMComponent</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">receiveComponent</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">nextElement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> lastProps <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_currentElement<span class="token punctuation">.</span>props<span class="token punctuation">;</span>
  <span class="token keyword">var</span> nextProps <span class="token operator">=</span> nextElement<span class="token punctuation">.</span>props<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>_currentElement <span class="token operator">=</span> nextElement<span class="token punctuation">;</span>
  <span class="token comment">// 处理当前节点的属性</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_updateDOMProperties</span><span class="token punctuation">(</span>lastProps<span class="token punctuation">,</span> nextProps<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 处理当前节点的子节点变动</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_updateDOMChildren</span><span class="token punctuation">(</span>nextElement<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p><code>先看看，更新属性怎么变更：</code></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">/**
 * 更新属性
 * @param {*} lastProps
 * @param {*} nextProps
 */</span>
<span class="token class-name">ReactDOMComponent</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">_updateDOMProperties</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>
  <span class="token parameter">lastProps<span class="token punctuation">,</span>
  nextProps</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 当老属性不在新属性的集合里时，需要删除属性</span>
  <span class="token keyword">var</span> propKey<span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>propKey <span class="token keyword">in</span> lastProps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      nextProps<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>propKey<span class="token punctuation">)</span> <span class="token operator">||</span>
      <span class="token operator">!</span>lastProps<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>propKey<span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 新属性中有，且不再老属性的原型中</span>
      <span class="token keyword">continue</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex">/^on[A-Za-z]/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>propKey<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> eventType <span class="token operator">=</span> propKey<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">&quot;on&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 特殊事件，需要去掉事件监听</span>
      <span class="token function">$</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">undelegate</span><span class="token punctuation">(</span>
        <span class="token string">'[data-reactid=&quot;'</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_rootNodeID <span class="token operator">+</span> <span class="token string">'&quot;]'</span><span class="token punctuation">,</span>
        eventType<span class="token punctuation">,</span>
        lastProps<span class="token punctuation">[</span>propKey<span class="token punctuation">]</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">continue</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 删除不需要的属性</span>
    <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'[data-reactid=&quot;'</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_rootNodeID <span class="token operator">+</span> <span class="token string">'&quot;]'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">removeAttr</span><span class="token punctuation">(</span>propKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 对于新的事件，需要写到dom上</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>propKey <span class="token keyword">in</span> nextProps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex">/^on[A-Za-z]/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>propKey<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> eventType <span class="token operator">=</span> propKey<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">&quot;on&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 删除老的事件绑定</span>
      lastProps<span class="token punctuation">[</span>propKey<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span>
        <span class="token function">$</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">undelegate</span><span class="token punctuation">(</span>
          <span class="token string">'[data-reactid=&quot;'</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_rootNodeID <span class="token operator">+</span> <span class="token string">'&quot;]'</span><span class="token punctuation">,</span>
          eventType<span class="token punctuation">,</span>
          lastProps<span class="token punctuation">[</span>propKey<span class="token punctuation">]</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 针对当前的节点添加事件代理,以_rootNodeID为命名空间</span>
      <span class="token function">$</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">delegate</span><span class="token punctuation">(</span>
        <span class="token string">'[data-reactid=&quot;'</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_rootNodeID <span class="token operator">+</span> <span class="token string">'&quot;]'</span><span class="token punctuation">,</span>
        eventType <span class="token operator">+</span> <span class="token string">&quot;.&quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_rootNodeID<span class="token punctuation">,</span>
        nextProps<span class="token punctuation">[</span>propKey<span class="token punctuation">]</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">continue</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>propKey <span class="token operator">==</span> <span class="token string">&quot;children&quot;</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>

    <span class="token comment">// 添加新的属性，重写同名属性</span>
    <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'[data-reactid=&quot;'</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_rootNodeID <span class="token operator">+</span> <span class="token string">'&quot;]'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">prop</span><span class="token punctuation">(</span>
      propKey<span class="token punctuation">,</span>
      nextProps<span class="token punctuation">[</span>propKey<span class="token punctuation">]</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br></div></div><blockquote><p>属性的变更并不是特别复杂，主要就是找到以前老的不用的属性直接去掉，新的属性赋值，并且注意其中特殊的事件属性做出特殊处理就行了。</p></blockquote> <p><code>子节点更新，也是最复杂的部分：</code></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 全局的更新深度标识</span>
<span class="token keyword">var</span> updateDepth <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token comment">// 全局的更新队列，所有的差异都存在这里</span>
<span class="token keyword">var</span> diffQueue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token class-name">ReactDOMComponent</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">_updateDOMChildren</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>
  <span class="token parameter">nextChildrenElements</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  updateDepth<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token comment">// _diff用来递归找出差别,组装差异对象,添加到更新队列diffQueue。</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_diff</span><span class="token punctuation">(</span>diffQueue<span class="token punctuation">,</span> nextChildrenElements<span class="token punctuation">)</span><span class="token punctuation">;</span>
  updateDepth<span class="token operator">--</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>updateDepth <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 在需要的时候调用patch，执行具体的dom操作</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_patch</span><span class="token punctuation">(</span>diffQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
    diffQueue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><blockquote><p>就像我们之前说的一样，更新子节点包含两个部分，一个是递归的分析差异，把差异添加到队列中。然后在合适的时机调用_patch 把差异应用到 dom 上。那么什么是合适的时机，updateDepth 又是干嘛的？这里需要注意的是，_diff 内部也会递归调用子节点的 receiveComponent 于是当某个子节点也是浏览器普通节点，就也会走_updateDOMChildren 这一步。所以这里使用了 updateDepth 来记录递归的过程，只有等递归回来 updateDepth 为 0 时，代表整个差异已经分析完毕，可以开始使用 patch 来处理差异队列了。</p></blockquote> <h3 id="diff-实现"><a href="#diff-实现" aria-hidden="true" class="header-anchor">#</a> diff 实现</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 差异更新的几种类型</span>
<span class="token keyword">var</span> <span class="token constant">UPDATE_TYPES</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token constant">MOVE_EXISTING</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token constant">REMOVE_NODE</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
  <span class="token constant">INSERT_MARKUP</span><span class="token punctuation">:</span> <span class="token number">3</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 生成子节点 elements 的 component 集合
 * @param {object} prevChildren 前一个 component 集合
 * @param {Array} nextChildrenElements 新传入的子节点element数组
 * @return {object} 返回一个映射
 */</span>
<span class="token keyword">function</span> <span class="token function">generateComponentChildren</span><span class="token punctuation">(</span><span class="token parameter">prevChildren<span class="token punctuation">,</span> nextChildrenElements</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> nextChildren <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  nextChildrenElements <span class="token operator">=</span> nextChildrenElements <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  $<span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span>nextChildrenElements<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">index<span class="token punctuation">,</span> element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> name <span class="token operator">=</span> element<span class="token punctuation">.</span>key <span class="token operator">?</span> element<span class="token punctuation">.</span>key <span class="token punctuation">:</span> index<span class="token punctuation">;</span>
    <span class="token keyword">var</span> prevChild <span class="token operator">=</span> prevChildren <span class="token operator">&amp;&amp;</span> prevChildren<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> prevElement <span class="token operator">=</span> prevChild <span class="token operator">&amp;&amp;</span> prevChild<span class="token punctuation">.</span>_currentElement<span class="token punctuation">;</span>
    <span class="token keyword">var</span> nextElement <span class="token operator">=</span> element<span class="token punctuation">;</span>

    <span class="token comment">// 调用_shouldUpdateReactComponent判断是否是更新</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">_shouldUpdateReactComponent</span><span class="token punctuation">(</span>prevElement<span class="token punctuation">,</span> nextElement<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 更新的话直接递归调用子节点的receiveComponent就好了</span>
      prevChild<span class="token punctuation">.</span><span class="token function">receiveComponent</span><span class="token punctuation">(</span>nextElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 然后继续使用老的component</span>
      nextChildren<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> prevChild<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 对于没有老的，那就重新新增一个，重新生成一个component</span>
      <span class="token keyword">var</span> nextChildInstance <span class="token operator">=</span> <span class="token function">instantiateReactComponent</span><span class="token punctuation">(</span>nextElement<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 使用新的component</span>
      nextChildren<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> nextChildInstance<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> nextChildren<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 将数组转换为映射
 * @param {Array} componentChildren
 * @return {object} 返回一个映射
 */</span>
<span class="token keyword">function</span> <span class="token function">flattenChildren</span><span class="token punctuation">(</span><span class="token parameter">componentChildren</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> child<span class="token punctuation">;</span>
  <span class="token keyword">var</span> name<span class="token punctuation">;</span>
  <span class="token keyword">var</span> childrenMap <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> componentChildren<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    child <span class="token operator">=</span> componentChildren<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    name <span class="token operator">=</span>
      child <span class="token operator">&amp;&amp;</span> child<span class="token punctuation">.</span>_currentelement <span class="token operator">&amp;&amp;</span> child<span class="token punctuation">.</span>_currentelement<span class="token punctuation">.</span>key
        <span class="token operator">?</span> child<span class="token punctuation">.</span>_currentelement<span class="token punctuation">.</span>key
        <span class="token punctuation">:</span> i<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">36</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    childrenMap<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> child<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> childrenMap<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * _diff用来递归找出差别,组装差异对象,添加到更新队列diffQueue。
 * @param {*} diffQueue
 * @param {*} nextChildrenElements
 */</span>
<span class="token class-name">ReactDOMComponent</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">_diff</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">diffQueue<span class="token punctuation">,</span> nextChildrenElements</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> self <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token comment">// 拿到之前的子节点的 component类型对象的集合,这个是在刚开始渲染时赋值的，记不得的可以翻上面</span>
  <span class="token comment">// _renderedChildren 本来是数组，我们搞成map</span>
  <span class="token keyword">var</span> prevChildren <span class="token operator">=</span> <span class="token function">flattenChildren</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>_renderedChildren<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 生成新的子节点的component对象集合，这里注意，会复用老的component对象</span>
  <span class="token keyword">var</span> nextChildren <span class="token operator">=</span> <span class="token function">generateComponentChildren</span><span class="token punctuation">(</span>
    prevChildren<span class="token punctuation">,</span>
    nextChildrenElements
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 重新赋值_renderedChildren，使用最新的。</span>
  self<span class="token punctuation">.</span>_renderedChildren <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  $<span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span>nextChildren<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span> instance</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    self<span class="token punctuation">.</span>_renderedChildren<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/**注意新增代码**/</span>
  <span class="token keyword">var</span> lastIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 代表访问的最后一次的老的集合的位置</span>

  <span class="token keyword">var</span> nextIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 代表到达的新的节点的index</span>
  <span class="token comment">// 通过对比两个集合的差异，组装差异节点添加到队列中</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>name <span class="token keyword">in</span> nextChildren<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>nextChildren<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">continue</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">var</span> prevChild <span class="token operator">=</span> prevChildren <span class="token operator">&amp;&amp;</span> prevChildren<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> nextChild <span class="token operator">=</span> nextChildren<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// 相同的话，说明是使用的同一个component,所以我们需要做移动的操作</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>prevChild <span class="token operator">===</span> nextChild<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 添加差异对象，类型：MOVE_EXISTING</span>
      <span class="token comment">/**注意新增代码**/</span>
      prevChild<span class="token punctuation">.</span>_mountIndex <span class="token operator">&lt;</span> lastIndex <span class="token operator">&amp;&amp;</span>
        diffQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          parentId<span class="token punctuation">:</span> self<span class="token punctuation">.</span>_rootNodeID<span class="token punctuation">,</span>
          parentNode<span class="token punctuation">:</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;[data-reactid=&quot;</span> <span class="token operator">+</span> self<span class="token punctuation">.</span>_rootNodeID <span class="token operator">+</span> <span class="token string">&quot;]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          type<span class="token punctuation">:</span> <span class="token constant">UPDATE_TYPES</span><span class="token punctuation">.</span><span class="token constant">MOVE_EXISTING</span><span class="token punctuation">,</span>
          fromIndex<span class="token punctuation">:</span> prevChild<span class="token punctuation">.</span>_mountIndex<span class="token punctuation">,</span>
          toIndex<span class="token punctuation">:</span> nextIndex
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">/**注意新增代码**/</span>
      lastIndex <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>prevChild<span class="token punctuation">.</span>_mountIndex<span class="token punctuation">,</span> lastIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果不相同，说明是新增加的节点</span>
      <span class="token comment">// 但是如果老的还存在，就是element不同，但是component一样。我们需要把它对应的老的element删除。</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>prevChild<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 添加差异对象，类型：REMOVE_NODE</span>
        diffQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          parentId<span class="token punctuation">:</span> self<span class="token punctuation">.</span>_rootNodeID<span class="token punctuation">,</span>
          parentNode<span class="token punctuation">:</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;[data-reactid=&quot;</span> <span class="token operator">+</span> self<span class="token punctuation">.</span>_rootNodeID <span class="token operator">+</span> <span class="token string">&quot;]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          type<span class="token punctuation">:</span> <span class="token constant">UPDATE_TYPES</span><span class="token punctuation">.</span><span class="token constant">REMOVE_NODE</span><span class="token punctuation">,</span>
          fromIndex<span class="token punctuation">:</span> prevChild<span class="token punctuation">.</span>_mountIndex<span class="token punctuation">,</span>
          toIndex<span class="token punctuation">:</span> <span class="token keyword">null</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 如果以前已经渲染过了，记得先去掉以前所有的事件监听，通过命名空间全部清空</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>prevChild<span class="token punctuation">.</span>_rootNodeID<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">$</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">undelegate</span><span class="token punctuation">(</span><span class="token string">&quot;.&quot;</span> <span class="token operator">+</span> prevChild<span class="token punctuation">.</span>_rootNodeID<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/**注意新增代码**/</span>
        lastIndex <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>prevChild<span class="token punctuation">.</span>_mountIndex<span class="token punctuation">,</span> lastIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 新增加的节点，也组装差异对象放到队列里</span>
      <span class="token comment">// 添加差异对象，类型：INSERT_MARKUP</span>
      diffQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        parentId<span class="token punctuation">:</span> self<span class="token punctuation">.</span>_rootNodeID<span class="token punctuation">,</span>
        parentNode<span class="token punctuation">:</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;[data-reactid=&quot;</span> <span class="token operator">+</span> self<span class="token punctuation">.</span>_rootNodeID <span class="token operator">+</span> <span class="token string">&quot;]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        type<span class="token punctuation">:</span> <span class="token constant">UPDATE_TYPES</span><span class="token punctuation">.</span><span class="token constant">INSERT_MARKUP</span><span class="token punctuation">,</span>
        fromIndex<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
        toIndex<span class="token punctuation">:</span> nextIndex<span class="token punctuation">,</span>
        markup<span class="token punctuation">:</span> nextChild<span class="token punctuation">.</span><span class="token function">mountComponent</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>_rootNodeID <span class="token operator">+</span> <span class="token string">&quot;.&quot;</span> <span class="token operator">+</span> name<span class="token punctuation">)</span> <span class="token comment">//新增的节点，多一个此属性，表示新节点的dom内容</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 更新mount的index</span>
    nextChild<span class="token punctuation">.</span>_mountIndex <span class="token operator">=</span> nextIndex<span class="token punctuation">;</span>
    nextIndex<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 对于老的节点里有，新的节点里没有的那些，也全都删除掉</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>name <span class="token keyword">in</span> prevChildren<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      prevChildren<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
      <span class="token operator">!</span><span class="token punctuation">(</span>nextChildren <span class="token operator">&amp;&amp;</span> nextChildren<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 添加差异对象，类型：REMOVE_NODE</span>
      diffQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        parentId<span class="token punctuation">:</span> self<span class="token punctuation">.</span>_rootNodeID<span class="token punctuation">,</span>
        parentNode<span class="token punctuation">:</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;[data-reactid=&quot;</span> <span class="token operator">+</span> self<span class="token punctuation">.</span>_rootNodeID <span class="token operator">+</span> <span class="token string">&quot;]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        type<span class="token punctuation">:</span> <span class="token constant">UPDATE_TYPES</span><span class="token punctuation">.</span><span class="token constant">REMOVE_NODE</span><span class="token punctuation">,</span>
        fromIndex<span class="token punctuation">:</span> prevChildren<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">.</span>_mountIndex<span class="token punctuation">,</span>
        toIndex<span class="token punctuation">:</span> <span class="token keyword">null</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 如果以前已经渲染过了，记得先去掉以前所有的事件监听</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>prevChildren<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">.</span>_rootNodeID<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">$</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">undelegate</span><span class="token punctuation">(</span><span class="token string">&quot;.&quot;</span> <span class="token operator">+</span> prevChildren<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">.</span>_rootNodeID<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br></div></div><blockquote><p>注意 flattenChildren 我们这里把数组集合转成了对象 map,以 element 的 key 作为标识，当然对于 text 文本或者没有传入 key 的 element,直接用 index 作为标识。通过这些标识，我们可以从类型的角度来判断两个 component 是否是一样的。</p></blockquote> <blockquote><p>generateComponentChildren 会尽量的复用以前的 component，也就是那些坑，当发现可以复用 component（也就是 key 一致）时，就还用以前的，只需要调用他对应的更新方法 receiveComponent 就行了，这样就会递归的去获取子节点的差异对象然后放到队列了。如果发现不能复用那就是新的节点，我们就需要 instantiateReactComponent 重新生成一个新的 component。</p></blockquote> <blockquote><p>lastIndex，这个代表最后一次访问的老集合节点的最大的位置。
而我们加了个判断，只有_mountIndex 小于这个 lastIndex 的才会需要加入差异队列。有了这个判断上面的例子 2 就不需要 move。而程序也可以好好的运行，实际上大部分都是 2 这种情况。</p></blockquote> <p>这是一种顺序优化，lastIndex 一直在更新，代表了当前访问的最右的老的集合的元素。
我们假设上一个元素是 A,添加后更新了 lastIndex。
如果我们这时候来个新元素 B，比 lastIndex 还大说明当前元素在老的集合里面就比上一个 A 靠后。所以这个元素就算不加入差异队列，也不会影响到其他人，不会影响到后面的 path 插入节点。因为我们从 patch 里面知道，新的集合都是按顺序从头开始插入元素的，只有当新元素比 lastIndex 小时才需要变更。其实只要仔细推敲下上面那个例子，就可以理解这种优化手段了。
查看<a href="https://zhuanlan.zhihu.com/p/20346379" target="_blank" rel="noopener noreferrer">React diff 策略<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h3 id="patch-的实现"><a href="#patch-的实现" aria-hidden="true" class="header-anchor">#</a> _patch 的实现</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">/**
 *
 * @param {*} parentNode
 * @param {*} childNode
 * @param {*} index
 */</span> <span class="token keyword">function</span> <span class="token function">insertChildAt</span><span class="token punctuation">(</span><span class="token parameter">parentNode<span class="token punctuation">,</span> childNode<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> beforeChild <span class="token operator">=</span> parentNode<span class="token punctuation">.</span><span class="token function">children</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
  beforeChild
    <span class="token operator">?</span> childNode<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>beforeChild<span class="token punctuation">)</span>
    <span class="token punctuation">:</span> childNode<span class="token punctuation">.</span><span class="token function">appendTo</span><span class="token punctuation">(</span>parentNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 *
 * @param {*} diffQueue
 */</span>
<span class="token class-name">ReactDOMComponent</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">_patch</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">diffQueue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> update<span class="token punctuation">;</span>
  <span class="token keyword">var</span> initialChildren <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> deleteChildren <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> updates<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    update <span class="token operator">=</span> updates<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      update<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token constant">UPDATE_TYPES</span><span class="token punctuation">.</span><span class="token constant">MOVE_EXISTING</span> <span class="token operator">||</span>
      update<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token constant">UPDATE_TYPES</span><span class="token punctuation">.</span><span class="token constant">REMOVE_NODE</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> updatedIndex <span class="token operator">=</span> update<span class="token punctuation">.</span>fromIndex<span class="token punctuation">;</span>
      <span class="token keyword">var</span> updatedChild <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span>update<span class="token punctuation">.</span>parentNode<span class="token punctuation">.</span><span class="token function">children</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>updatedIndex<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> parentID <span class="token operator">=</span> update<span class="token punctuation">.</span>parentID<span class="token punctuation">;</span>

      <span class="token comment">// 所有需要更新的节点都保存下来，方便后面使用</span>
      initialChildren<span class="token punctuation">[</span>parentID<span class="token punctuation">]</span> <span class="token operator">=</span> initialChildren<span class="token punctuation">[</span>parentID<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token comment">// 使用parentID作为简易命名空间</span>
      initialChildren<span class="token punctuation">[</span>parentID<span class="token punctuation">]</span><span class="token punctuation">[</span>updatedIndex<span class="token punctuation">]</span> <span class="token operator">=</span> updatedChild<span class="token punctuation">;</span>

      <span class="token comment">// 所有需要修改的节点先删除,对于move的，后面再重新插入到正确的位置即可</span>
      deleteChildren<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>updatedChild<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 删除所有需要先删除的</span>
  $<span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span>deleteChildren<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">index<span class="token punctuation">,</span> child</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">$</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 再遍历一次，这次处理新增的节点，还有修改的节点这里也要重新插入</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> k <span class="token operator">&lt;</span> updates<span class="token punctuation">.</span>length<span class="token punctuation">;</span> k<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    update <span class="token operator">=</span> updates<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>update<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> <span class="token constant">UPDATE_TYPES</span><span class="token punctuation">.</span><span class="token constant">INSERT_MARKUP</span><span class="token punctuation">:</span>
        <span class="token function">insertChildAt</span><span class="token punctuation">(</span>update<span class="token punctuation">.</span>parentNode<span class="token punctuation">,</span> <span class="token function">$</span><span class="token punctuation">(</span>update<span class="token punctuation">.</span>markup<span class="token punctuation">)</span><span class="token punctuation">,</span> update<span class="token punctuation">.</span>toIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token constant">UPDATE_TYPES</span><span class="token punctuation">.</span><span class="token constant">MOVE_EXISTING</span><span class="token punctuation">:</span>
        <span class="token function">insertChildAt</span><span class="token punctuation">(</span>
          update<span class="token punctuation">.</span>parentNode<span class="token punctuation">,</span>
          initialChildren<span class="token punctuation">[</span>update<span class="token punctuation">.</span>parentID<span class="token punctuation">]</span><span class="token punctuation">[</span>update<span class="token punctuation">.</span>fromIndex<span class="token punctuation">]</span><span class="token punctuation">,</span>
          update<span class="token punctuation">.</span>toIndex
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token constant">UPDATE_TYPES</span><span class="token punctuation">.</span><span class="token constant">REMOVE_NODE</span><span class="token punctuation">:</span>
        <span class="token comment">// 什么都不需要做，因为上面已经帮忙删除掉了</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br></div></div><blockquote><p>_patch 主要就是挨个遍历差异队列，遍历两次，第一次删除掉所有需要变动的节点，然后第二次插入新的节点还有修改的节点。这里为什么可以直接挨个的插入呢？原因就是我们在 diff 阶段添加差异节点到差异队列时，本身就是有序的，也就是说对于新增节点（包括 move 和 insert 的）在队列里的顺序就是最终 dom 的顺序，所以我们才可以挨个的直接根据 index 去塞入节点。</p></blockquote> <p><code>这样整个的更新机制就完成了。我们再来简单回顾下 React 的差异算法：</code></p> <blockquote><p>首先是所有的 component 都实现了 receiveComponent 来负责自己的更新，而浏览器默认元素的更新最为复杂，也就是经常说的 diff algorithm。</p></blockquote> <blockquote><p>react 有一个全局_shouldUpdateReactComponent 用来根据 element 的 key 来判断是更新还是重新渲染，这是第一个差异判断。比如自定义元素里，就使用这个判断，通过这种标识判断，会变得特别高效。</p></blockquote> <p>每个类型的元素都要处理好自己的更新：</p> <ul><li><p>自定义元素的更新，主要是更新 render 出的节点，做甩手掌柜交给 render 出的节点的对应 component 去管理更新。</p></li> <li><p>text 节点的更新很简单，直接更新文案。</p></li> <li><p>浏览器基本元素的更新，分为两块：</p> <ul><li>先是更新属性，对比出前后属性的不同，局部更新。并且处理特殊属性，比如事件绑定。</li> <li>然后是子节点的更新，子节点更新主要是找出差异对象，找差异对象的时候也会使用上面的_shouldUpdateReactComponent 来判断，如果是可以直接更新的就会递归调用子节点的更新，这样也会递归查找差异对象，这里还会使用 lastIndex 这种做一种优化，使一些节点保留位置，之后根据差异对象操作 dom 元素（位置变动，删除，</li></ul></li></ul> <h3 id="end"><a href="#end" aria-hidden="true" class="header-anchor">#</a> end</h3> <p>这只是个玩具，但实现了 React 最核心的功能，虚拟节点，差异算法，单向数据更新都在这里了。还有很多 React 优秀的东西没有实现，比如对象生成时内存的线程池管理，批量更新机制，事件的优化，服务端的渲染，immutable data 等等。这些东西受限于篇幅就不具体展开了。</p> <p>React 作为一种解决方案，虚拟节点的想法比较新奇，不过个人还是不能接受这种别扭的写法。使用 React，就要使用他那一整套的开发方式，而他核心的功能其实只是一个差异算法，而这种其实已经有相关的库实现了。</p> <p>相关资料：</p> <ul><li><a href="https://zhuanlan.zhihu.com/p/20346379" target="_blank" rel="noopener noreferrer">React diff 策略<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://github.com/purplebamboo/blog/issues" target="_blank" rel="noopener noreferrer">原文地址<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li>react 撸后台: <a href="https://juejin.im/post/5b715c006fb9a009b628faaa" target="_blank" rel="noopener noreferrer">企业级中后台项目<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/prepare/react/源码分析/实现Didact.html" class="prev">实现Didact</a></span> <span class="next"><a href="/prepare/react/源码分析/实现自己的react之简单rendering.html">实现自己的react之简单rendering</a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/prepare/assets/js/app.63a9d18c.js" defer></script><script src="/prepare/assets/js/2.df88221a.js" defer></script><script src="/prepare/assets/js/596.48e4bef1.js" defer></script>
  </body>
</html>
